<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ - GitHub Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .section {
            padding: 25px;
            display: block;
        }
        
        .hidden {
            display: none !important;
        }
        
        .login-form {
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        input, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn-logout {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .teacher-info {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-right: 5px solid #3498db;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 10px;
            text-align: right;
            font-weight: 600;
            font-size: 14px;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #ecf0f1;
            text-align: right;
            font-size: 14px;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        
        .result-cell {
            font-weight: bold;
            text-align: center;
            font-size: 13px;
            padding: 8px 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        .result-excellent {
            color: #27ae60;
            background-color: rgba(39, 174, 96, 0.1);
            border-color: rgba(39, 174, 96, 0.3);
        }
        
        .result-good {
            color: #3498db;
            background-color: rgba(52, 152, 219, 0.1);
            border-color: rgba(52, 152, 219, 0.3);
        }
        
        .result-average {
            color: #f39c12;
            background-color: rgba(243, 156, 18, 0.1);
            border-color: rgba(243, 156, 18, 0.3);
        }
        
        .result-poor {
            color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
            border-color: rgba(231, 76, 60, 0.3);
        }
        
        .student-name {
            color: #3498db;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
        }
        
        .student-name:hover {
            color: #2980b9;
            background-color: rgba(52, 152, 219, 0.1);
            transform: translateY(-1px);
        }
        
        .edit-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s ease;
        }
        
        .edit-btn:hover {
            background-color: #e67e22;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .search-container input,
        .search-container select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex: 1;
            min-width: 200px;
        }
        
        .stats-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-right: 5px solid #3498db;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .connection-status {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 25px;
            border-radius: 15px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            background: #f0f0f0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .student-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .form-section {
            grid-column: 1 / -1;
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .form-section h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--dark-color);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .search-container input,
            .search-container select {
                min-width: 100%;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 5px;
            }
            
            .student-form {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 5% auto;
                padding: 15px;
                width: 98%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
            <p>Ø§ØªØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ GitHub - ØªØ­ÙˆÙŠÙ„ Excel Ø¥Ù„Ù‰ JSON ØªÙ„Ù‚Ø§Ø¦ÙŠ</p>
        </div>

        <div id="loginSection" class="section">
            <div class="login-form">
                <h2 style="margin-bottom: 30px; color: #2c3e50;">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                
                <div class="input-group">
                    <input type="text" id="teacherId" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¹Ù„Ù…..." autocomplete="off" value="ameen">
                </div>

                <div class="connection-status" id="connectionStatus">
                    â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                </div>

                <button class="btn btn-success" id="loginBtn" disabled>ğŸ”— Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„</button>
                <button class="btn btn-warning" id="retryBtn">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                <button class="btn" id="useLocalDataBtn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">ğŸ’¾ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</button>
            </div>
        </div>

        <div id="mainSection" class="section hidden">
            <div class="controls">
                <button class="btn btn-logout" id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                <div style="color: #2c3e50; font-weight: bold;">
                    <span>Ø§Ù„Ù…Ø¹Ù„Ù…: </span>
                    <span id="currentTeacher"></span>
                    <span> | Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: </span>
                    <span id="studentsCount">0</span>
                </div>
            </div>

            <div id="teacherInfo" class="teacher-info hidden">
                <h3>ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
                <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª loaded Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† GitHub</p>
            </div>

            <div id="searchContainer" class="search-container hidden">
                <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯...">
                <select id="classFilter">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø¹Ø¨</option>
                </select>
                <button class="btn" id="exportBtn" style="background: linear-gradient(135deg, #27ae60, #229954);">
                    ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
                <button class="btn" id="saveLocalBtn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                    ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
                </button>
            </div>

            <div id="statsContainer"></div>

            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Barcode</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                            <th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
                            <th>Ù…ÙˆØ§Ø¸Ø¨Ø© 1</th>
                            <th>Ø´ÙÙ‡ÙŠ 1</th>
                            <th>ÙˆØ§Ø¬Ø¨Ø§Øª 1</th>
                            <th>ØªØ­Ø±ÙŠØ±ÙŠ 1</th>
                            <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 1</th>
                            <th>Ù…Ø­ØµÙ„Ø© 1</th>
                            <th>Ù…ÙˆØ§Ø¸Ø¨Ø© 2</th>
                            <th>Ø´ÙÙ‡ÙŠ 2</th>
                            <th>ÙˆØ§Ø¬Ø¨Ø§Øª 2</th>
                            <th>ØªØ­Ø±ÙŠØ±ÙŠ 2</th>
                            <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 2</th>
                            <th>Ù…Ø­ØµÙ„Ø© 2</th>
                            <th>Ù…ÙˆØ§Ø¸Ø¨Ø© 3</th>
                            <th>ÙˆØ§Ø¬Ø¨Ø§Øª 3</th>
                            <th>Ø´ÙÙ‡ÙŠ 3</th>
                            <th>ØªØ­Ø±ÙŠØ±ÙŠ 3</th>
                            <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 3</th>
                            <th>Ù…Ø­ØµÙ„Ø© 3</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <tr>
                            <td colspan="23" style="text-align: center; color: #666; padding: 40px;">
                                â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="loading" class="loading hidden">
            â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
        </div>

        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h3>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨: <span id="currentStudentName"></span></h3>
                <form id="studentForm" class="student-form">
                    <input type="hidden" id="editStudentId">
                    
                    <div class="form-section">
                        <h4>ğŸ“˜ Ø§Ù„ØªØ±Ù… Ø§Ù„Ø£ÙˆÙ„</h4>
                    </div>
                    <div class="form-group">
                        <label for="editAttendance1">Ù…ÙˆØ§Ø¸Ø¨Ø© 1:</label>
                        <input type="number" id="editAttendance1" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editOral1">Ø´ÙÙ‡ÙŠ 1:</label>
                        <input type="number" id="editOral1" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editHomework1">ÙˆØ§Ø¬Ø¨Ø§Øª 1:</label>
                        <input type="number" id="editHomework1" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editWritten1">ØªØ­Ø±ÙŠØ±ÙŠ 1:</label>
                        <input type="number" id="editWritten1" min="0" max="20" step="0.1">
                    </div>

                    <div class="form-section">
                        <h4>ğŸ“— Ø§Ù„ØªØ±Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ</h4>
                    </div>
                    <div class="form-group">
                        <label for="editAttendance2">Ù…ÙˆØ§Ø¸Ø¨Ø© 2:</label>
                        <input type="number" id="editAttendance2" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editOral2">Ø´ÙÙ‡ÙŠ 2:</label>
                        <input type="number" id="editOral2" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editHomework2">ÙˆØ§Ø¬Ø¨Ø§Øª 2:</label>
                        <input type="number" id="editHomework2" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editWritten2">ØªØ­Ø±ÙŠØ±ÙŠ 2:</label>
                        <input type="number" id="editWritten2" min="0" max="20" step="0.1">
                    </div>

                    <div class="form-section">
                        <h4>ğŸ“™ Ø§Ù„ØªØ±Ù… Ø§Ù„Ø«Ø§Ù„Ø«</h4>
                    </div>
                    <div class="form-group">
                        <label for="editAttendance3">Ù…ÙˆØ§Ø¸Ø¨Ø© 3:</label>
                        <input type="number" id="editAttendance3" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editHomework3">ÙˆØ§Ø¬Ø¨Ø§Øª 3:</label>
                        <input type="number" id="editHomework3" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editOral3">Ø´ÙÙ‡ÙŠ 3:</label>
                        <input type="number" id="editOral3" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editWritten3">ØªØ­Ø±ÙŠØ±ÙŠ 3:</label>
                        <input type="number" id="editWritten3" min="0" max="20" step="0.1">
                    </div>

                    <div class="form-section">
                        <button type="submit" class="btn btn-success">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                        <button type="button" id="cancelEditBtn" class="btn btn-danger">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
    // ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub Ùˆ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ==========
    const GITHUB_EXCEL_URL = 'https://raw.githubusercontent.com/ameen-algmady/grades/main/students.xlsx';
    const LOCAL_STORAGE_KEY = 'studentsData';
    
    // ========== Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ Ø§Ù„ØµÙØ­Ø© ==========
    const loginSection = document.getElementById('loginSection');
    const mainSection = document.getElementById('mainSection');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const retryBtn = document.getElementById('retryBtn');
    const useLocalDataBtn = document.getElementById('useLocalDataBtn');
    const saveLocalBtn = document.getElementById('saveLocalBtn'); 
    const teacherIdInput = document.getElementById('teacherId');
    const studentsTableBody = document.getElementById('studentsTableBody');
    const loadingDiv = document.getElementById('loading');
    const teacherInfoDiv = document.getElementById('teacherInfo');
    const currentTeacherSpan = document.getElementById('currentTeacher');
    const studentsCountSpan = document.getElementById('studentsCount');
    const exportBtn = document.getElementById('exportBtn');
    const connectionStatus = document.getElementById('connectionStatus');
    const editModal = document.getElementById('editModal');
    const closeModal = document.querySelector('.close-modal');
    const studentForm = document.getElementById('studentForm');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const currentStudentName = document.getElementById('currentStudentName');

    // Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¯Ø§Ø®Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    const editStudentId = document.getElementById('editStudentId');
    const editAttendance1 = document.getElementById('editAttendance1');
    const editOral1 = document.getElementById('editOral1');
    const editHomework1 = document.getElementById('editHomework1');
    const editWritten1 = document.getElementById('editWritten1');
    const editAttendance2 = document.getElementById('editAttendance2');
    const editOral2 = document.getElementById('editOral2');
    const editHomework2 = document.getElementById('editHomework2');
    const editWritten2 = document.getElementById('editWritten2');
    const editAttendance3 = document.getElementById('editAttendance3');
    const editHomework3 = document.getElementById('editHomework3');
    const editOral3 = document.getElementById('editOral3');
    const editWritten3 = document.getElementById('editWritten3');

    // ========== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ==========
    let currentTeacherId = '';
    let filteredStudents = [];
    let allStudents = [];
    let currentEditStudent = null;
    let usingLocalData = false;

    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø© ==========
    function validateTeacherId(teacherId) {
        return /^[a-zA-Z0-9_\-]+$/.test(teacherId) && teacherId.length >= 3;
    }

    function showLoading(show, message = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...') {
        if (show) {
            loadingDiv.classList.remove('hidden');
            loadingDiv.innerHTML = `<p>${message}</p>`;
        } else {
            loadingDiv.classList.add('hidden');
        }
    }

    function showError(message) {
        loadingDiv.classList.remove('hidden');
        loadingDiv.innerHTML = `
            <div style="color: red; text-align: center; padding: 20px;">
                <p>âŒ ${message}</p>
                <button onclick="hideError()" style="margin: 5px; padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">
                    Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        `;
    }

    function hideError() {
        loadingDiv.classList.add('hidden');
    }

    function showSuccess(message) {
        loadingDiv.classList.remove('hidden');
        loadingDiv.innerHTML = `<p style="color: green;">âœ… ${message}</p>`;
        setTimeout(() => loadingDiv.classList.add('hidden'), 3000);
    }

    function updateConnectionStatus(message, type = 'info') {
        const colors = {
            info: '#fff3cd',
            success: '#d4edda',
            error: '#f8d7da'
        };
        
        const borderColors = {
            info: '#ffeaa7',
            success: '#c3e6cb',
            error: '#f5c6cb'
        };
        
        connectionStatus.innerHTML = message;
        connectionStatus.style.background = colors[type] || colors.info;
        connectionStatus.style.borderColor = borderColors[type] || borderColors.info;
    }

    // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ==========
    function saveDataToLocalStorage() {
        try {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allStudents));
            showSuccess('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­');
            return true;
        } catch (error) {
            showError('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹: ' + error.message);
            return false;
        }
    }

    function loadDataFromLocalStorage() {
        try {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (data) {
                allStudents = JSON.parse(data);
                return true;
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', error);
        }
        return false;
    }

    // ========== Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub ÙˆØªØ­ÙˆÙŠÙ„ Excel ==========
    async function loadExcelFromGitHub() {
        updateConnectionStatus('ğŸŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub...', 'info');
        
        try {
            const response = await fetch(GITHUB_EXCEL_URL);
            
            if (!response.ok) {
                throw new Error(`ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${response.status} ${response.statusText}`);
            }
            
            updateConnectionStatus('ğŸ“ ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ - Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...', 'info');
            
            const arrayBuffer = await response.arrayBuffer();
            
            updateConnectionStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„ Excel Ø¥Ù„Ù‰ JSON...', 'info');
            
            // ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ÙƒØªØ¨Ø© XLSX (SheetJS) Ù…Ø­Ù…Ù„Ø© ÙÙŠ Ù…Ù„Ù HTML Ù‚Ø¨Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const excelData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            
            const processed = processExcelData(excelData);
            allStudents = processed;
            
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            saveDataToLocalStorage();
            
            updateConnectionStatus(`âœ… ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ - ${allStudents.length} Ø·Ø§Ù„Ø¨`, 'success');
            loginBtn.disabled = false;
            loginBtn.style.background = 'linear-gradient(135deg, #27ae60, #229954)';
            usingLocalData = false;
            
            console.log('ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', allStudents);
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„:', error);
            updateConnectionStatus(`
                âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† GitHub
                <br><br>
                <strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:</strong> ${error.message}
                <br><br>
                <strong>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø©</strong>
            `, 'error');
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¹Ù†Ø¯ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„
            if (loadDataFromLocalStorage()) {
                updateConnectionStatus(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allStudents.length} Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©`, 'success');
                loginBtn.disabled = false;
                loginBtn.style.background = 'linear-gradient(135deg, #27ae60, #229954)';
                usingLocalData = true;
            } else {
                loginBtn.disabled = true;
            }
        }
    }

    // ========== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Excel ==========
    function processExcelData(excelData) {
        if (!excelData || excelData.length < 2) {
            throw new Error('Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©');
        }

        const students = [];
        
        // Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙƒÙ…Ø§ Ø­Ø¯Ø¯ØªÙ‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹
        const teacherIdColumn = 23;
        const idColumn = 0;
        const barcodeColumn = 1;
        const nameColumn = 2;
        const classColumn = 3;
        const attendance1Column = 4;
        const oral1Column = 5;
        const homework1Column = 6;
        const written1Column = 7;
        const total1Column = 8;
        const result1Column = 9;
        const attendance2Column = 10;
        const oral2Column = 11;
        const homework2Column = 12;
        const written2Column = 13;
        const total2Column = 14;
        const result2Column = 15;
        const attendance3Column = 16;
        const homework3Column = 17;
        const oral3Column = 18;
        const written3Column = 19;
        const total3Column = 20;
        const result3Column = 21;

        for (let i = 1; i < excelData.length; i++) {
            const row = excelData[i];
            if (row.length === 0) continue;

            const student = {
                id: row[idColumn] || `STD${i}`,
                barcode: row[barcodeColumn] || '',
                name: row[nameColumn] || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
                class: row[classColumn] || '---',
                teacherId: (row[teacherIdColumn] || '').toString().trim(),
                
                attendance1: formatGrade(row[attendance1Column]),
                oral1: formatGrade(row[oral1Column]),
                homework1: formatGrade(row[homework1Column]),
                written1: formatGrade(row[written1Column]),
                total1: formatGrade(row[total1Column]),
                result1: formatGrade(row[result1Column]),
                
                attendance2: formatGrade(row[attendance2Column]),
                oral2: formatGrade(row[oral2Column]),
                homework2: formatGrade(row[homework2Column]),
                written2: formatGrade(row[written2Column]),
                total2: formatGrade(row[total2Column]),
                result2: formatGrade(row[result2Column]),
                
                attendance3: formatGrade(row[attendance3Column]),
                homework3: formatGrade(row[homework3Column]),
                oral3: formatGrade(row[oral3Column]),
                written3: formatGrade(row[written3Column]),
                total3: formatGrade(row[total3Column]),
                result3: formatGrade(row[result3Column]),
                
                fullData: row
            };

            if (student.teacherId) {
                students.push(student);
            }
        }

        return students;
    }

    function formatGrade(value) {
        if (value === null || value === undefined || value === '') return '0';
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¥Ù„Ù‰ Ø³Ù„Ø³Ù„Ø© Ù†ØµÙŠØ© ÙˆØ¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø³Ø§ÙØ§Øª
        const strValue = value.toString().trim();
        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Ø±Ù‚Ù… (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… 0 Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø±Ù‚Ù…Ø§Ù‹ ØµØ§Ù„Ø­Ø§Ù‹)
        const numValue = parseFloat(strValue);
        if (isNaN(numValue)) return '0';
        // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ù…Ø¹ Ù…Ù†Ø²Ù„Ø© Ø¹Ø´Ø±ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙƒØ«Ø±
        return numValue.toFixed(1).replace(/\.0$/, '');
    }
    
    function filterStudentsByTeacher() {
        if (!allStudents || allStudents.length === 0) {
            filteredStudents = [];
            return;
        }

        filteredStudents = allStudents.filter(student => student.teacherId === currentTeacherId);
    }

    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© ==========
    function addSearchFunctionality() {
        updateClassFilter();
        document.getElementById('searchInput').addEventListener('input', filterStudents);
        document.getElementById('classFilter').addEventListener('change', filterStudents);
    }

    function updateClassFilter() {
        const classFilter = document.getElementById('classFilter');
        const classes = [...new Set(filteredStudents.map(student => student.class).filter(c => c))];
        
        classFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø¹Ø¨</option>';
        classes.forEach(className => {
            const option = document.createElement('option');
            option.value = className;
            option.textContent = className;
            classFilter.appendChild(option);
        });
    }

    function filterStudents() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const selectedClass = document.getElementById('classFilter').value;
        
        let filtered = allStudents.filter(student => student.teacherId === currentTeacherId);
        
        if (searchTerm) {
            filtered = filtered.filter(student => 
                student.name.toLowerCase().includes(searchTerm) ||
                student.barcode.toLowerCase().includes(searchTerm)
            );
        }
        
        if (selectedClass) {
            filtered = filtered.filter(student => student.class === selectedClass);
        }
        
        filteredStudents = filtered;
        renderStudentsTable();
        displayStatistics(filteredStudents);
    }

    // ========== Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù…Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­) ==========
    function renderStudentsTable() {
        studentsTableBody.innerHTML = '';
        
        studentsCountSpan.textContent = filteredStudents.length;

        if (filteredStudents.length === 0) {
            studentsTableBody.innerHTML = `
                <tr>
                    <td colspan="23" style="text-align: center; color: #666; padding: 40px;">
                        ğŸ“ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø¹Ù„Ù… ${currentTeacherId}
                    </td>
                </tr>
            `;
            return;
        }
        
        filteredStudents.forEach((student) => {
            const row = document.createElement('tr');
            
            function getResultClass(result) {
                const value = parseFloat(result) || 0;
                if (value >= 4.5) return 'result-excellent';
                if (value >= 3.5) return 'result-good';
                if (value >= 2.5) return 'result-average';
                return 'result-poor';
            }

            const result1Class = getResultClass(student.result1);
            const result2Class = getResultClass(student.result2);
            const result3Class = getResultClass(student.result3);
            
            // **********************************************
            // ğŸ’¡ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ­Ø­ Ù„Ø¥Ù†Ø´Ø§Ø¡ ØµÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
            // **********************************************
            row.innerHTML = `
                <td>${student.id}</td>
                <td>${student.barcode}</td>
                <td>
                    <span class="student-name" data-student-id="${student.id}">
                        ${student.name}
                    </span>
                </td>
                <td>${student.class}</td>
                <td>${student.attendance1}</td>
                <td>${student.oral1}</td>
                <td>${student.homework1}</td>
                <td>${student.written1}</td>
                <td><strong>${student.total1}</strong></td>
                <td class="result-cell ${result1Class}">${student.result1}</td>
                <td>${student.attendance2}</td>
                <td>${student.oral2}</td>
                <td>${student.homework2}</td>
                <td>${student.written2}</td>
                <td><strong>${student.total2}</strong></td>
                <td class="result-cell ${result2Class}">${student.result2}</td>
                <td>${student.attendance3}</td>
                <td>${student.homework3}</td>
                <td>${student.oral3}</td>
                <td>${student.written3}</td>
                <td><strong>${student.total3}</strong></td>
                <td class="result-cell ${result3Class}">${student.result3}</td>
                <td>
                    <button class="edit-btn" data-student-id="${student.id}">ØªØ¹Ø¯ÙŠÙ„</button>
                </td>
            `;
            // **********************************************
            
            studentsTableBody.appendChild(row);
        });
    }

    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ù…ÙƒØ±Ø±Ø© ÙƒÙ…Ø§ ÙƒØ§Ù†Øª) ==========
    function calculateStatistics(students) {
        // ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª ÙˆØ§Ù„Ù†Ø³Ø¨ Ù‡Ù†Ø§
        // Ù„ØªØ¨Ø³ÙŠØ· Ø§Ù„ÙƒÙˆØ¯ØŒ Ø³Ø£ÙØªØ±Ø¶ Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø³Ù„ÙŠÙ…
        return {
            totalStudents: students.length,
            classes: [...new Set(students.map(s => s.class))].join(', '),
            avgTotal1: calculateAverage(students.map(s => parseFloat(s.total1))),
            avgTotal2: calculateAverage(students.map(s => parseFloat(s.total2))),
            avgTotal3: calculateAverage(students.map(s => parseFloat(s.total3))),
        };
    }

    function calculateAverage(arr) {
        const validNumbers = arr.filter(n => !isNaN(n));
        if (validNumbers.length === 0) return '0.0';
        const sum = validNumbers.reduce((a, b) => a + b, 0);
        return (sum / validNumbers.length).toFixed(1);
    }

    function displayStatistics(students) {
        const stats = calculateStatistics(students);
        const statsContainer = document.getElementById('statsContainer');
        
        statsContainer.innerHTML = `
            <div class="stats-container">
                <h3>ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</strong>
                        <p>${stats.totalStudents}</p>
                    </div>
                    <div class="stat-item">
                        <strong>Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 1</strong>
                        <p>${stats.avgTotal1}</p>
                    </div>
                    <div class="stat-item">
                        <strong>Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 2</strong>
                        <p>${stats.avgTotal2}</p>
                    </div>
                    <div class="stat-item">
                        <strong>Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 3</strong>
                        <p>${stats.avgTotal3}</p>
                    </div>
                    <div class="stat-item">
                        <strong>Ø§Ù„Ø´Ø¹Ø¨ Ø§Ù„Ù…Ø¯Ø§Ø±Ø©</strong>
                        <p>${stats.classes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø¹Ø¨'}</p>
                    </div>
                </div>
            </div>
        `;
    }

    // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Edit Modal Logic) ==========

    function getStudentById(id) {
        return allStudents.find(student => student.id.toString() === id.toString());
    }

    function openEditModal(studentId) {
        currentEditStudent = getStudentById(studentId);
        
        if (!currentEditStudent) {
            showError('ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„.');
            return;
        }

        // ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        currentStudentName.textContent = currentEditStudent.name;
        editStudentId.value = currentEditStudent.id;
        
        editAttendance1.value = currentEditStudent.attendance1;
        editOral1.value = currentEditStudent.oral1;
        editHomework1.value = currentEditStudent.homework1;
        editWritten1.value = currentEditStudent.written1;
        
        editAttendance2.value = currentEditStudent.attendance2;
        editOral2.value = currentEditStudent.oral2;
        editHomework2.value = currentEditStudent.homework2;
        editWritten2.value = currentEditStudent.written2;
        
        editAttendance3.value = currentEditStudent.attendance3;
        editHomework3.value = currentEditStudent.homework3;
        editOral3.value = currentEditStudent.oral3;
        editWritten3.value = currentEditStudent.written3;

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
        editModal.style.display = 'block';
        console.log('ØªÙ… ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø·Ø§Ù„Ø¨ ID:', studentId);
    }

    function closeEditModal() {
        editModal.style.display = 'none';
        currentEditStudent = null;
    }

    function handleEditSubmit(event) {
        event.preventDefault();
        
        if (!currentEditStudent) return;

        // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        const newAttendance1 = parseFloat(editAttendance1.value) || 0;
        const newOral1 = parseFloat(editOral1.value) || 0;
        const newHomework1 = parseFloat(editHomework1.value) || 0;
        const newWritten1 = parseFloat(editWritten1.value) || 0;
        const newTotal1 = newAttendance1 + newOral1 + newHomework1 + newWritten1;
        const newResult1 = (newTotal1 / 80) * 5; // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ 80

        const newAttendance2 = parseFloat(editAttendance2.value) || 0;
        const newOral2 = parseFloat(editOral2.value) || 0;
        const newHomework2 = parseFloat(editHomework2.value) || 0;
        const newWritten2 = parseFloat(editWritten2.value) || 0;
        const newTotal2 = newAttendance2 + newOral2 + newHomework2 + newWritten2;
        const newResult2 = (newTotal2 / 80) * 5; 

        const newAttendance3 = parseFloat(editAttendance3.value) || 0;
        const newHomework3 = parseFloat(editHomework3.value) || 0;
        const newOral3 = parseFloat(editOral3.value) || 0;
        const newWritten3 = parseFloat(editWritten3.value) || 0;
        const newTotal3 = newAttendance3 + newHomework3 + newOral3 + newWritten3;
        const newResult3 = (newTotal3 / 80) * 5; 

        // ØªØ­Ø¯ÙŠØ« ÙƒØ§Ø¦Ù† Ø§Ù„Ø·Ø§Ù„Ø¨
        currentEditStudent.attendance1 = newAttendance1.toFixed(1);
        currentEditStudent.oral1 = newOral1.toFixed(1);
        currentEditStudent.homework1 = newHomework1.toFixed(1);
        currentEditStudent.written1 = newWritten1.toFixed(1);
        currentEditStudent.total1 = newTotal1.toFixed(1);
        currentEditStudent.result1 = newResult1.toFixed(1);

        currentEditStudent.attendance2 = newAttendance2.toFixed(1);
        currentEditStudent.oral2 = newOral2.toFixed(1);
        currentEditStudent.homework2 = newHomework2.toFixed(1);
        currentEditStudent.written2 = newWritten2.toFixed(1);
        currentEditStudent.total2 = newTotal2.toFixed(1);
        currentEditStudent.result2 = newResult2.toFixed(1);

        currentEditStudent.attendance3 = newAttendance3.toFixed(1);
        currentEditStudent.homework3 = newHomework3.toFixed(1);
        currentEditStudent.oral3 = newOral3.toFixed(1);
        currentEditStudent.written3 = newWritten3.toFixed(1);
        currentEditStudent.total3 = newTotal3.toFixed(1);
        currentEditStudent.result3 = newResult3.toFixed(1);

        // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        filterStudents(); // Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        saveDataToLocalStorage();
        showSuccess(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ${currentEditStudent.name} Ø¨Ù†Ø¬Ø§Ø­.`);
        closeEditModal();
    }

    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ==========
    function handleLogin() {
        const teacherId = teacherIdInput.value.trim().toLowerCase();
        if (!validateTeacherId(teacherId) || allStudents.length === 0) {
            showError('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ù…Ø¹Ù„Ù… ØµØ­ÙŠØ­ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
            return;
        }

        currentTeacherId = teacherId;
        filterStudentsByTeacher();

        if (filteredStudents.length === 0) {
            showError(`Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù„Ù…Ø¹Ù„Ù… "${currentTeacherId}".`);
            return;
        }

        loginSection.classList.add('hidden');
        mainSection.classList.remove('hidden');
        teacherInfoDiv.classList.remove('hidden');
        document.getElementById('searchContainer').classList.remove('hidden');
        currentTeacherSpan.textContent = currentTeacherId;
        
        renderStudentsTable();
        displayStatistics(filteredStudents);
        addSearchFunctionality(); // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©
    }

    function handleLogout() {
        // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ù„Ø³Ø© Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        currentTeacherId = '';
        allStudents = [];
        filteredStudents = [];
        loginSection.classList.remove('hidden');
        mainSection.classList.add('hidden');
        teacherIdInput.value = 'ameen'; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        updateConnectionStatus('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
        loadExcelFromGitHub(); // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
    }

    // ========== ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØµØ¯ÙŠØ± ==========
    function exportToExcel() {
        if (filteredStudents.length === 0) {
            alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.');
            return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±
        const dataToExport = filteredStudents.map(student => ({
            'ID': student.id,
            'Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯': student.barcode,
            'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': student.name,
            'Ø§Ù„Ø´Ø¹Ø¨Ø©': student.class,
            // ... (Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„)
            'Ù…ÙˆØ§Ø¸Ø¨Ø© 1': student.attendance1,
            'Ø´ÙÙ‡ÙŠ 1': student.oral1,
            'ÙˆØ§Ø¬Ø¨Ø§Øª 1': student.homework1,
            'ØªØ­Ø±ÙŠØ±ÙŠ 1': student.written1,
            'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 1': student.total1,
            'Ù…Ø­ØµÙ„Ø© 1': student.result1,

            'Ù…ÙˆØ§Ø¸Ø¨Ø© 2': student.attendance2,
            'Ø´ÙÙ‡ÙŠ 2': student.oral2,
            'ÙˆØ§Ø¬Ø¨Ø§Øª 2': student.homework2,
            'ØªØ­Ø±ÙŠØ±ÙŠ 2': student.written2,
            'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 2': student.total2,
            'Ù…Ø­ØµÙ„Ø© 2': student.result2,

            'Ù…ÙˆØ§Ø¸Ø¨Ø© 3': student.attendance3,
            'ÙˆØ§Ø¬Ø¨Ø§Øª 3': student.homework3,
            'Ø´ÙÙ‡ÙŠ 3': student.oral3,
            'ØªØ­Ø±ÙŠØ±ÙŠ 3': student.written3,
            'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 3': student.total3,
            'Ù…Ø­ØµÙ„Ø© 3': student.result3,
            // ... Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‡Ù†Ø§
        }));

        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù†ØªØ§Ø¦Ø¬");

        const fileName = `Ø§Ù„Ù†ØªØ§Ø¦Ø¬_${currentTeacherId}_${new Date().toLocaleDateString('en-CA')}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }

    // ========== Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Listeners) ==========
    
    // 1. Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    document.addEventListener('DOMContentLoaded', loadExcelFromGitHub);
    loginBtn.addEventListener('click', handleLogin);
    retryBtn.addEventListener('click', loadExcelFromGitHub);
    useLocalDataBtn.addEventListener('click', () => {
        if (loadDataFromLocalStorage()) {
            allStudents.length > 0 ? loginBtn.disabled = false : loginBtn.disabled = true;
            usingLocalData = true;
            updateConnectionStatus(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allStudents.length} Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©`, 'success');
        } else {
            updateConnectionStatus('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø©.', 'error');
        }
    });

    // 2. Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    logoutBtn.addEventListener('click', handleLogout);
    exportBtn.addEventListener('click', exportToExcel);
    saveLocalBtn.addEventListener('click', saveDataToLocalStorage);

    // 3. Ù…Ø³ØªÙ…Ø¹ ØªÙÙˆÙŠØ¶ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Delegation) ğŸš¨ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    studentsTableBody.addEventListener('click', function(event) {
        const target = event.target;
        let studentId = null;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        if (target.classList.contains('student-name') || target.classList.contains('edit-btn')) {
            studentId = target.dataset.studentId;
        }

        if (studentId) {
            console.log('ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨ ID:', studentId); // Ù„Ù„ØªØ­Ù‚Ù‚ ÙÙŠ Ø§Ù„Ù€ Console
            openEditModal(studentId);
        }
    });

    // 4. Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Modal)
    closeModal.addEventListener('click', closeEditModal);
    cancelEditBtn.addEventListener('click', closeEditModal);
    studentForm.addEventListener('submit', handleEditSubmit);

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    window.addEventListener('click', function(event) {
        if (event.target === editModal) {
            closeEditModal();
        }
    });

    </script>
</body>
</html>