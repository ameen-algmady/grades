<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨ - Google Sheets Update</title>
    
    <!-- Meta Tags for PWA - Ù…Ø­Ø¯Ø« -->
    <meta name="theme-color" content="#667eea"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨">
    
    <!-- Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/yourusername/your-repo/main/icon-192x192.png">
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/yourusername/your-repo/main/icon-192x192.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/yourusername/your-repo/main/icon-192x192.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="https://raw.githubusercontent.com/yourusername/your-repo/main/manifest.json">
    
    <style>
        /* CSS Ø§Ù„Ø£ØµÙ„ÙŠ (Ù…Ø­Ø¯Ø«) */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .install-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            display: none;
            transition: all 0.3s ease;
        }

        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .section {
            padding: 25px;
            display: block;
        }

        .hidden {
            display: none !important;
        }

        .login-form {
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .input-group {
            margin-bottom: 20px;
        }

        input, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-logout {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .teacher-info {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-right: 5px solid #3498db;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 10px;
            text-align: right;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #ecf0f1;
            text-align: right;
            font-size: 14px;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .loading p {
            margin: 0;
            padding: 10px;
        }

        .loading.success {
            color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid rgba(39, 174, 96, 0.3);
        }

        .loading.error {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .result-cell {
            font-weight: bold;
            text-align: center;
            font-size: 13px;
            padding: 8px 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .result-excellent {
            color: #27ae60;
            background-color: rgba(39, 174, 96, 0.1);
            border-color: rgba(39, 174, 96, 0.3);
        }

        .result-good {
            color: #3498db;
            background-color: rgba(52, 152, 219, 0.1);
            border-color: rgba(52, 152, 219, 0.3);
        }

        .result-average {
            color: #f39c12;
            background-color: rgba(243, 156, 18, 0.1);
            border-color: rgba(243, 156, 18, 0.3);
        }

        .result-poor {
            color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
            border-color: rgba(231, 76, 60, 0.3);
        }

        .install-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #8e44ad, #732d91);
        }

        .install-btn:active {
            transform: translateY(0);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .student-name {
            color: #3498db;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
        }

        .student-name:hover {
            color: #2980b9;
            background-color: rgba(52, 152, 219, 0.1);
            transform: translateY(-1px);
        }

        .edit-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s ease;
        }

        .edit-btn:hover {
            background-color: #e67e22;
        }

        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .search-container input,
        .search-container select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex: 1;
            min-width: 200px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 25px;
            border-radius: 15px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        #statsModal .modal-content {
            max-width: 600px;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            background: #f0f0f0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .student-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .form-section {
            grid-column: 1 / -1;
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--dark-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #d0eaff;
        }
        
        .sync-btn-container {
            position: relative;
            display: inline-block;
        }
        
        #pendingCount {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: bold;
            line-height: 1;
        }

        .debug-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }

        .debug-panel h4 {
            color: #6c757d;
            margin-bottom: 10px;
        }

        #syncStatus {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        /* Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ù…Ø§Ø³Ø­ QR Code */
        .qr-scanner-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
        }

        #qrScanner {
            width: 100%;
            height: 300px;
            border: 2px dashed #3498db;
            border-radius: 10px;
            margin-bottom: 15px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        #qrScanner video {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #3498db;
            border-radius: 10px;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.3);
        }

        .qr-result {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .qr-result.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .qr-result.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ù‡ÙˆØ§ØªÙ */
        .edit-modal-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 15px 0;
            border-bottom: 2px solid #ecf0f1;
            z-index: 10;
            margin-bottom: 15px;
        }

        .edit-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .month-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .month-title {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .scores-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .score-group {
            display: flex;
            flex-direction: column;
        }

        .score-group label {
            font-size: 0.9em;
            margin-bottom: 5px;
            color: #555;
        }

        .score-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .total-display {
            grid-column: 1 / -1;
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-top: 10px;
            border: 1px solid #3498db;
        }

        .total-display .label {
            font-weight: bold;
            color: #2c3e50;
        }

        .total-display .value {
            font-size: 1.1em;
            font-weight: bold;
            color: #3498db;
        }

        .result-display {
            grid-column: 1 / -1;
            background: #e8f6f3;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-top: 5px;
            border: 1px solid #27ae60;
        }

        .result-display .label {
            font-weight: bold;
            color: #2c3e50;
        }

        .result-display .value {
            font-size: 1.1em;
            font-weight: bold;
            color: #27ae60;
        }

        /* Ø²Ø± Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ */
        .top-save-btn {
            position: sticky;
            top: 80px;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 20;
            margin: 10px auto;
            display: block;
            width: 220px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .top-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
        }

        /* ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
        }

        .stats-tab {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #7f8c8d;
        }

        .stats-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .stats-tab:hover {
            color: #2980b9;
        }

        .stats-tab-content {
            display: none;
        }

        .stats-tab-content.active {
            display: block;
        }

        /* ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø´Ù‡ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        .months-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
        }

        .month-tab {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #555;
            flex: 1;
            text-align: center;
            margin: 0 2px;
        }

        .month-tab.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .month-tab:hover:not(.active) {
            background: #e9ecef;
            color: #2c3e50;
        }

        .month-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .month-tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ØªØ®ØµÙŠØµ Ø£Ù„ÙˆØ§Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .month-tab[data-month="1"] { border-right: 3px solid #3498db; }
        .month-tab[data-month="2"] { border-right: 3px solid #27ae60; }
        .month-tab[data-month="3"] { border-right: 3px solid #f39c12; }
        .month-tab[data-month="all"] { border-right: 3px solid #9b59b6; }

        .month-tab.active[data-month="1"] { background: linear-gradient(135deg, #3498db, #2980b9); }
        .month-tab.active[data-month="2"] { background: linear-gradient(135deg, #27ae60, #229954); }
        .month-tab.active[data-month="3"] { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .month-tab.active[data-month="all"] { background: linear-gradient(135deg, #9b59b6, #8e44ad); }

        /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ© */
        .month-table th {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .current-month-indicator {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
            color: #2d3436;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            margin-left: 10px;
            display: inline-block;
        }

        /* Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø± */
        .month-selection {
            text-align: center;
            padding: 40px 20px;
        }

        .month-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .month-card {
            background: white;
            border-radius: 15px;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .month-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .month-card.month-1 {
            border-color: #3498db;
            background: linear-gradient(135deg, #f8f9fa, #e3f2fd);
        }

        .month-card.month-2 {
            border-color: #27ae60;
            background: linear-gradient(135deg, #f8f9fa, #e8f5e8);
        }

        .month-card.month-3 {
            border-color: #f39c12;
            background: linear-gradient(135deg, #f8f9fa, #fef9e7);
        }

        .month-card.all-months {
            border-color: #9b59b6;
            background: linear-gradient(135deg, #f8f9fa, #f3e5f5);
        }

        .month-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .month-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.4em;
        }

        .month-card p {
            color: #7f8c8d;
            font-size: 0.9em;
            line-height: 1.5;
        }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ù†ÙØµÙ„Ø© */
        .month-workspace {
            display: none;
        }

        .month-workspace.active {
            display: block;
        }

        .back-to-selection {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            margin-bottom: 20px;
        }

        .current-month-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .current-month-header.month-2 {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .current-month-header.month-3 {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .current-month-header.all-months {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        /* Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù… */
        .sync-controls-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .sync-status-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .status-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-label {
            display: block;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        .status-item:nth-child(2) .status-value {
            color: #27ae60;
        }

        .status-item:nth-child(3) .status-value {
            color: #e74c3c;
        }

        .status-item:nth-child(4) .status-value {
            color: #9b59b6;
        }

        .sync-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .sync-details-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .sync-details-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .sync-detail-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sync-detail-item:last-child {
            border-bottom: none;
        }

        .sync-detail-info {
            flex: 1;
        }

        .sync-detail-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #ffeaa7;
            color: #e67e22;
        }

        .status-completed {
            background: #d4edda;
            color: #27ae60;
        }

        .status-failed {
            background: #f8d7da;
            color: #e74c3c;
        }

        .sync-options {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .option-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-item:last-child {
            margin-bottom: 0;
        }

        .option-item input[type="checkbox"] {
            width: auto;
        }

        .option-item select {
            width: 100px;
            padding: 5px;
        }

        .sync-history-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .sync-history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .sync-history-table th {
            background: #34495e;
            color: white;
            padding: 10px;
            position: sticky;
            top: 0;
        }

        .sync-history-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
        }

        .sync-history-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-container {
                flex-direction: column;
            }

            .search-container input,
            .search-container select {
                min-width: 100%;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 5px;
            }

            .student-form {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 5% auto;
                padding: 15px;
                width: 98%;
            }

            #qrScanner {
                height: 250px;
            }

            .scanner-frame {
                width: 180px;
                height: 180px;
            }

            .scores-grid {
                grid-template-columns: 1fr;
            }

            .top-save-btn {
                width: 90%;
                top: 60px;
                padding: 10px 20px;
                font-size: 14px;
            }

            .stats-tabs,
            .months-tabs {
                flex-direction: column;
            }

            .stats-tab,
            .month-tab {
                text-align: center;
                border-bottom: none;
                border-right: 3px solid transparent;
                margin-bottom: 5px;
            }

            .stats-tab.active,
            .month-tab.active {
                border-right-color: inherit;
                border-bottom: none;
            }

            .month-tab {
                margin: 2px 0;
            }

            .month-cards {
                grid-template-columns: 1fr;
            }

            .month-card {
                padding: 20px 15px;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .sync-actions-grid {
                grid-template-columns: 1fr;
            }
            
            .sync-history-table {
                font-size: 12px;
            }
        }

        @media (min-width: 769px) {
            .edit-form-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
            }
            
            .month-section {
                margin-bottom: 0;
            }
        }
        /* Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ */
#manualBackupBtn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1000;
    display: none;
    transition: all 0.3s ease;
}

#manualBackupBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(0,0,0,0.3);
    background: linear-gradient(135deg, #2980b9, #1c6ea4);
}

#manualBackupBtn:active {
    transform: translateY(0);
}

/* Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ */
#backupModal .modal-content {
    max-width: 400px;
}

.backup-success {
    background: #d4edda;
    color: #155724;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border: 1px solid #c3e6cb;
}

.backup-list {
    max-height: 200px;
    overflow-y: auto;
    margin: 15px 0;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    border: 1px solid #dee2e6;
}

.backup-item {
    padding: 10px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.backup-item:last-child {
    border-bottom: none;
}

.backup-info {
    flex: 1;
}

.backup-actions {
    display: flex;
    gap: 5px;
}
/* ØªØ­Ø³ÙŠÙ† ØªØµÙ…ÙŠÙ… Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… */
.controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
    padding: 15px;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 10px;
    border: 1px solid #dee2e6;
}

.teacher-info-display {
    color: #2c3e50;
    font-weight: bold;
    font-size: 14px;
    background: white;
    padding: 8px 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.teacher-info-display span {
    color: #3498db;
    font-weight: bold;
}

/* ØªØµÙ…ÙŠÙ… Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ */
.toolbar-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
    padding: 12px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}

.toolbar-left {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.toolbar-right {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

/* ØªØµÙ…ÙŠÙ… Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠ */
.toolbar-bottom {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin: 15px 0;
    padding: 15px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}

.toolbar-bottom.full-width {
    grid-template-columns: 1fr 1fr 1fr;
}

/* ØªØ­Ø³ÙŠÙ† ØªØµÙ…ÙŠÙ… Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¨Ø­Ø« */
.search-tools-container {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin: 15px 0;
    padding: 15px;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 10px;
    border: 1px solid #dee2e6;
}

.search-tools-container .search-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.search-tools-container label {
    font-size: 12px;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 3px;
}

.search-tools-container input,
.search-tools-container select {
    width: 100%;
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s ease;
}

.search-tools-container input:focus,
.search-tools-container select:focus {
    border-color: #3498db;
    box-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
}

/* Ø£Ø²Ø±Ø§Ø± Ø¥Ø¶Ø§ÙÙŠØ© */
.btn-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 15px;
    border-radius: 8px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
}

.btn-icon:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.btn-icon.small {
    padding: 8px 12px;
    font-size: 12px;
}

/* ØªØ­Ø³ÙŠÙ† ØªØµÙ…ÙŠÙ… Ø²Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© */
.sync-btn-container {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.sync-status-text {
    font-size: 11px;
    color: #666;
    text-align: center;
    margin-top: 3px;
}

/* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØµÙ…ÙŠÙ… Ù„Ù„Ù‡ÙˆØ§ØªÙ */
@media (max-width: 768px) {
    .toolbar-top {
        flex-direction: column;
        align-items: stretch;
    }
    
    .toolbar-left, .toolbar-right {
        width: 100%;
        justify-content: center;
    }
    
    .toolbar-bottom {
        grid-template-columns: 1fr;
    }
    
    .search-tools-container {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .btn-icon {
        width: 100%;
        justify-content: center;
    }
    
    .teacher-info-display {
        text-align: center;
        font-size: 13px;
    }
    
    .controls {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
    }
}

@media (min-width: 769px) and (max-width: 1024px) {
    .toolbar-bottom {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .search-tools-container {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* ØªØ­Ø³ÙŠÙ† ØªØµÙ…ÙŠÙ… Ø±Ø£Ø³ Ø§Ù„Ø´Ù‡Ø± */
.current-month-header {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    text-align: center;
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
}

.current-month-header h2 {
    margin: 0 0 10px 0;
    font-size: 1.8em;
    font-weight: 300;
}

.current-month-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 0.95em;
}

/* Ø£Ù„ÙˆØ§Ù† Ù…Ø®ØªÙ„ÙØ© Ù„ÙƒÙ„ Ø´Ù‡Ø± */
.current-month-header.month-1 {
    background: linear-gradient(135deg, #3498db, #2980b9);
}

.current-month-header.month-2 {
    background: linear-gradient(135deg, #27ae60, #229954);
}

.current-month-header.month-3 {
    background: linear-gradient(135deg, #f39c12, #e67e22);
}

.current-month-header.all-months {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="install-btn" id="installBtn">ğŸ“² ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
            <h1>ğŸ“ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
            <p>Ø§ØªØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Google Sheets</p>
        </div>

        <div id="loginSection" class="section">
            <div class="login-form">
                <h2 style="margin-bottom: 30px; color: #2c3e50;">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>

                <div class="input-group">
                    <input type="text" id="teacherId" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¹Ù„Ù…..." autocomplete="off">
                </div>

                <div class="connection-status" id="connectionStatus">
                    â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets...
                </div>

                <button class="btn btn-success" id="loginBtn" disabled>ğŸ”— Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„</button>
                <button class="btn btn-warning" id="retryBtn">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                <button class="btn" id="useLocalDataBtn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">ğŸ’¾ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</button>
                
                <div class="debug-panel">
                    <h4>ğŸ› Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­:</h4>
                    <div id="debugInfo">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...</div>
                    <div id="pwaStatus">Ø­Ø§Ù„Ø© PWA: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø± -->
        <div id="monthSelectionSection" class="section hidden">
            <div class="teacher-info">
                <h3>ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ <span id="welcomeTeacherName"></span></h3>
                <p>Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡:</p>
            </div>

            <div class="month-selection">
                <div class="month-cards">
                    <div class="month-card month-1" onclick="selectMonth(1)">
                        <div class="month-icon">ğŸ“˜</div>
                        <h3>Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ÙˆÙ„</h3>
                        <p>Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ÙˆÙ„ (Ù…ÙˆØ§Ø¸Ø¨Ø©ØŒ Ø´ÙÙ‡ÙŠØŒ ÙˆØ§Ø¬Ø¨Ø§ØªØŒ ØªØ­Ø±ÙŠØ±ÙŠ)</p>
                    </div>
                    
                    <div class="month-card month-2" onclick="selectMonth(2)">
                        <div class="month-icon">ğŸ“—</div>
                        <h3>Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ</h3>
                        <p>Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ (Ù…ÙˆØ§Ø¸Ø¨Ø©ØŒ Ø´ÙÙ‡ÙŠØŒ ÙˆØ§Ø¬Ø¨Ø§ØªØŒ ØªØ­Ø±ÙŠØ±ÙŠ)</p>
                    </div>
                    
                    <div class="month-card month-3" onclick="selectMonth(3)">
                        <div class="month-icon">ğŸ“™</div>
                        <h3>Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø«</h3>
                        <p>Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø« (Ù…ÙˆØ§Ø¸Ø¨Ø©ØŒ Ø´ÙÙ‡ÙŠØŒ ÙˆØ§Ø¬Ø¨Ø§ØªØŒ ØªØ­Ø±ÙŠØ±ÙŠ)</p>
                    </div>
                    
                    <div class="month-card all-months" onclick="selectMonth('all')">
                        <div class="month-icon">ğŸ“š</div>
                        <h3>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡ÙˆØ±</h3>
                        <p>Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡ÙˆØ± ÙÙŠ Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø­Ø¯ Ø´Ø§Ù…Ù„</p>
                    </div>
                </div>
            </div>
        </div>

       <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù…Ù„ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ÙˆÙ„ -->
<div id="month1Workspace" class="month-workspace">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <div class="toolbar-top">
        <div class="toolbar-left">
            <button class="btn back-to-selection" onclick="backToMonthSelection()">
                <span style="margin-left: 5px;">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø©</span>
            </button>
            <div class="teacher-info-display">
                <span id="currentTeacher1"></span> | Ø§Ù„Ø·Ù„Ø§Ø¨: <span id="studentsCount1">0</span>
            </div>
        </div>
        
        <div class="toolbar-right">
            <button class="btn btn-logout" id="logoutBtn1">
                <span style="margin-left: 5px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
    </div>

    <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ù‡Ø± -->
    <div class="current-month-header month-1">
        <h2>ğŸ“˜ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ÙˆÙ„ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h2>
        <p>ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ÙˆÙ„ Ù„Ù„Ø·Ù„Ø§Ø¨</p>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠ (Ø£ÙŠÙ‚ÙˆÙ†ØªÙŠÙ† ÙÙŠ Ø§Ù„ØµÙ) -->
    <div class="toolbar-bottom">
        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ -->
        <button class="btn-icon" id="manageSyncBtn1" style="background: linear-gradient(135deg, #34495e, #2c3e50);">
            <span>âš™ï¸</span>
            <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</span>
        </button>
        
        <button class="btn-icon" id="showStatsBtn1" style="background: linear-gradient(135deg, #27ae60, #229954);">
            <span>ğŸ“ˆ</span>
            <span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
        </button>
        
        <div class="sync-btn-container">
            <button class="btn-icon" id="syncSheetsBtn1" style="background: linear-gradient(135deg, #e74c3c, #c0392b); width: 100%;">
                <span>â˜ï¸</span>
                <span>Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</span>
                <span id="pendingCount1" class="hidden" style="background: white; color: #e74c3c; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-right: 5px;">0</span>
            </button>
            <div class="sync-status-text" id="syncStatus1">Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: Ù…ØªÙˆÙ‚ÙØ©</div>
        </div>
    </div>

    <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© -->
    <div class="search-tools-container">
        <!-- Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø© -->
        <div class="search-group">
            <label for="classNameFilter1">ğŸ” Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
            <select id="classNameFilter1">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø¹Ø¨</option>
            </select>
        </div>
        
        <!-- Ù…Ø³Ø­ QR Code -->
        <div class="search-group">
            <label for="qrScanBtn1">ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
            <button class="btn-icon" id="qrScanBtn1" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); width: 100%;">
                <span>ğŸ“·</span>
                <span>Ù…Ø³Ø­ QR Code</span>
            </button>
        </div>
        
        <!-- Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… -->
        <div class="search-group">
            <label for="searchNameInput1">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…</label>
            <input type="text" id="searchNameInput1" placeholder="Ø£Ø¯Ø®Ù„ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨...">
        </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div style="overflow-x: auto;">
        <table class="month-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Barcode</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                    <th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
                    <th>Ù…ÙˆØ§Ø¸Ø¨Ø© 1</th>
                    <th>Ø´ÙÙ‡ÙŠ 1</th>
                    <th>ÙˆØ§Ø¬Ø¨Ø§Øª 1</th>
                    <th>ØªØ­Ø±ÙŠØ±ÙŠ 1</th>
                    <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 1</th>
                    <th>Ù…Ø­ØµÙ„Ø© 1</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="month1TableBody">
                <tr>
                    <td colspan="11" style="text-align: center; color: #666; padding: 40px;">
                        â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù…Ù„ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ -->
<div id="month2Workspace" class="month-workspace">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <div class="toolbar-top">
        <div class="toolbar-left">
            <button class="btn back-to-selection" onclick="backToMonthSelection()">
                <span style="margin-left: 5px;">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø©</span>
            </button>
            <div class="teacher-info-display">
                <span id="currentTeacher2"></span> | Ø§Ù„Ø·Ù„Ø§Ø¨: <span id="studentsCount2">0</span>
            </div>
        </div>
        
        <div class="toolbar-right">
            <button class="btn btn-logout" id="logoutBtn2">
                <span style="margin-left: 5px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
    </div>

    <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ù‡Ø± -->
    <div class="current-month-header month-2">
        <h2>ğŸ“— Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h2>
        <p>ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ Ù„Ù„Ø·Ù„Ø§Ø¨</p>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠ (Ø£ÙŠÙ‚ÙˆÙ†ØªÙŠÙ† ÙÙŠ Ø§Ù„ØµÙ) -->
    <div class="toolbar-bottom">
        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ -->
        <button class="btn-icon" id="manageSyncBtn2" style="background: linear-gradient(135deg, #34495e, #2c3e50);">
            <span>âš™ï¸</span>
            <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</span>
        </button>
        
        <button class="btn-icon" id="showStatsBtn2" style="background: linear-gradient(135deg, #27ae60, #229954);">
            <span>ğŸ“ˆ</span>
            <span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
        </button>
        
        <div class="sync-btn-container">
            <button class="btn-icon" id="syncSheetsBtn2" style="background: linear-gradient(135deg, #e74c3c, #c0392b); width: 100%;">
                <span>â˜ï¸</span>
                <span>Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</span>
                <span id="pendingCount2" class="hidden" style="background: white; color: #e74c3c; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-right: 5px;">0</span>
            </button>
            <div class="sync-status-text" id="syncStatus2">Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: Ù…ØªÙˆÙ‚ÙØ©</div>
        </div>
    </div>

    <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© -->
    <div class="search-tools-container">
        <!-- Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø© -->
        <div class="search-group">
            <label for="classNameFilter2">ğŸ” Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
            <select id="classNameFilter2">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø¹Ø¨</option>
            </select>
        </div>
        
        <!-- Ù…Ø³Ø­ QR Code -->
        <div class="search-group">
            <label for="qrScanBtn2">ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
            <button class="btn-icon" id="qrScanBtn2" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); width: 100%;">
                <span>ğŸ“·</span>
                <span>Ù…Ø³Ø­ QR Code</span>
            </button>
        </div>
        
        <!-- Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… -->
        <div class="search-group">
            <label for="searchNameInput2">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…</label>
            <input type="text" id="searchNameInput2" placeholder="Ø£Ø¯Ø®Ù„ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨...">
        </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div style="overflow-x: auto;">
        <table class="month-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Barcode</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                    <th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
                    <th>Ù…ÙˆØ§Ø¸Ø¨Ø© 2</th>
                    <th>Ø´ÙÙ‡ÙŠ 2</th>
                    <th>ÙˆØ§Ø¬Ø¨Ø§Øª 2</th>
                    <th>ØªØ­Ø±ÙŠØ±ÙŠ 2</th>
                    <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 2</th>
                    <th>Ù…Ø­ØµÙ„Ø© 2</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="month2TableBody">
                <tr>
                    <td colspan="11" style="text-align: center; color: #666; padding: 40px;">
                        â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù…Ù„ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø« -->
<div id="month3Workspace" class="month-workspace">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <div class="toolbar-top">
        <div class="toolbar-left">
            <button class="btn back-to-selection" onclick="backToMonthSelection()">
                <span style="margin-left: 5px;">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø©</span>
            </button>
            <div class="teacher-info-display">
                <span id="currentTeacher3"></span> | Ø§Ù„Ø·Ù„Ø§Ø¨: <span id="studentsCount3">0</span>
            </div>
        </div>
        
        <div class="toolbar-right">
            <button class="btn btn-logout" id="logoutBtn3">
                <span style="margin-left: 5px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
    </div>

    <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ù‡Ø± -->
    <div class="current-month-header month-3">
        <h2>ğŸ“™ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø« - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h2>
        <p>ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø« Ù„Ù„Ø·Ù„Ø§Ø¨</p>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠ (Ø£ÙŠÙ‚ÙˆÙ†ØªÙŠÙ† ÙÙŠ Ø§Ù„ØµÙ) -->
    <div class="toolbar-bottom">
        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ -->
        <button class="btn-icon" id="manageSyncBtn3" style="background: linear-gradient(135deg, #34495e, #2c3e50);">
            <span>âš™ï¸</span>
            <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</span>
        </button>
        
        <button class="btn-icon" id="showStatsBtn3" style="background: linear-gradient(135deg, #27ae60, #229954);">
            <span>ğŸ“ˆ</span>
            <span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
        </button>
        
        <div class="sync-btn-container">
            <button class="btn-icon" id="syncSheetsBtn3" style="background: linear-gradient(135deg, #e74c3c, #c0392b); width: 100%;">
                <span>â˜ï¸</span>
                <span>Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</span>
                <span id="pendingCount3" class="hidden" style="background: white; color: #e74c3c; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-right: 5px;">0</span>
            </button>
            <div class="sync-status-text" id="syncStatus3">Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: Ù…ØªÙˆÙ‚ÙØ©</div>
        </div>
    </div>

    <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© -->
    <div class="search-tools-container">
        <!-- Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø© -->
        <div class="search-group">
            <label for="classNameFilter3">ğŸ” Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
            <select id="classNameFilter3">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø¹Ø¨</option>
            </select>
        </div>
        
        <!-- Ù…Ø³Ø­ QR Code -->
        <div class="search-group">
            <label for="qrScanBtn3">ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
            <button class="btn-icon" id="qrScanBtn3" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); width: 100%;">
                <span>ğŸ“·</span>
                <span>Ù…Ø³Ø­ QR Code</span>
            </button>
        </div>
        
        <!-- Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… -->
        <div class="search-group">
            <label for="searchNameInput3">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…</label>
            <input type="text" id="searchNameInput3" placeholder="Ø£Ø¯Ø®Ù„ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨...">
        </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div style="overflow-x: auto;">
        <table class="month-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Barcode</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                    <th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
                    <th>Ù…ÙˆØ§Ø¸Ø¨Ø© 3</th>
                    <th>ÙˆØ§Ø¬Ø¨Ø§Øª 3</th>
                    <th>Ø´ÙÙ‡ÙŠ 3</th>
                    <th>ØªØ­Ø±ÙŠØ±ÙŠ 3</th>
                    <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 3</th>
                    <th>Ù…Ø­ØµÙ„Ø© 3</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="month3TableBody">
                <tr>
                    <td colspan="11" style="text-align: center; color: #666; padding: 40px;">
                        â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡ÙˆØ± -->
<div id="allMonthsWorkspace" class="month-workspace">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <div class="toolbar-top">
        <div class="toolbar-left">
            <button class="btn back-to-selection" onclick="backToMonthSelection()">
                <span style="margin-left: 5px;">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø©</span>
            </button>
            <div class="teacher-info-display">
                <span id="currentTeacherAll"></span> | Ø§Ù„Ø·Ù„Ø§Ø¨: <span id="studentsCountAll">0</span>
            </div>
        </div>
        
        <div class="toolbar-right">
            <button class="btn btn-logout" id="logoutBtnAll">
                <span style="margin-left: 5px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
    </div>

    <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ù‡Ø± -->
    <div class="current-month-header all-months">
        <h2>ğŸ“š Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡ÙˆØ± - Ø¹Ø±Ø¶ Ø´Ø§Ù…Ù„</h2>
        <p>Ø¹Ø±Ø¶ Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ø«Ù„Ø§Ø«Ø©</p>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠ (Ø£ÙŠÙ‚ÙˆÙ†ØªÙŠÙ† ÙÙŠ Ø§Ù„ØµÙ) -->
    <div class="toolbar-bottom">
        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ -->
        <button class="btn-icon" id="manageSyncBtnAll" style="background: linear-gradient(135deg, #34495e, #2c3e50);">
            <span>âš™ï¸</span>
            <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</span>
        </button>
        
        <button class="btn-icon" id="showStatsBtnAll" style="background: linear-gradient(135deg, #27ae60, #229954);">
            <span>ğŸ“ˆ</span>
            <span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
        </button>
        
        <div class="sync-btn-container">
            <button class="btn-icon" id="syncSheetsBtnAll" style="background: linear-gradient(135deg, #e74c3c, #c0392b); width: 100%;">
                <span>â˜ï¸</span>
                <span>Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</span>
                <span id="pendingCountAll" class="hidden" style="background: white; color: #e74c3c; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-right: 5px;">0</span>
            </button>
            <div class="sync-status-text" id="syncStatusAll">Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: Ù…ØªÙˆÙ‚ÙØ©</div>
        </div>
    </div>

    <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© -->
    <div class="search-tools-container">
        <!-- Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø© -->
        <div class="search-group">
            <label for="classNameFilterAll">ğŸ” Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
            <select id="classNameFilterAll">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø¹Ø¨</option>
            </select>
        </div>
        
        <!-- Ù…Ø³Ø­ QR Code -->
        <div class="search-group">
            <label for="qrScanBtnAll">ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
            <button class="btn-icon" id="qrScanBtnAll" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); width: 100%;">
                <span>ğŸ“·</span>
                <span>Ù…Ø³Ø­ QR Code</span>
            </button>
        </div>
        
        <!-- Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… -->
        <div class="search-group">
            <label for="searchNameInputAll">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…</label>
            <input type="text" id="searchNameInputAll" placeholder="Ø£Ø¯Ø®Ù„ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨...">
        </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Barcode</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                    <th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
                    <th>Ù…ÙˆØ§Ø¸Ø¨Ø© 1</th>
                    <th>Ø´ÙÙ‡ÙŠ 1</th>
                    <th>ÙˆØ§Ø¬Ø¨Ø§Øª 1</th>
                    <th>ØªØ­Ø±ÙŠØ±ÙŠ 1</th>
                    <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 1</th>
                    <th>Ù…Ø­ØµÙ„Ø© 1</th>
                    <th>Ù…ÙˆØ§Ø¸Ø¨Ø© 2</th>
                    <th>Ø´ÙÙ‡ÙŠ 2</th>
                    <th>ÙˆØ§Ø¬Ø¨Ø§Øª 2</th>
                    <th>ØªØ­Ø±ÙŠØ±ÙŠ 2</th>
                    <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 2</th>
                    <th>Ù…Ø­ØµÙ„Ø© 2</th>
                    <th>Ù…ÙˆØ§Ø¸Ø¨Ø© 3</th>
                    <th>ÙˆØ§Ø¬Ø¨Ø§Øª 3</th>
                    <th>Ø´ÙÙ‡ÙŠ 3</th>
                    <th>ØªØ­Ø±ÙŠØ±ÙŠ 3</th>
                    <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 3</th>
                    <th>Ù…Ø­ØµÙ„Ø© 3</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="studentsTableBody">
                <tr>
                    <td colspan="23" style="text-align: center; color: #666; padding: 40px;">
                        â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
                

        <div id="loading" class="loading hidden">
            â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ù…Ø§Ø³Ø­ QR Code -->
        <div id="qrModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal('qrModal')">&times;</span>
                <h3>ğŸ“· Ù…Ø³Ø­ QR Code Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                <div class="qr-scanner-container">
                    <div id="qrScanner">
                        <span>Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</span>
                    </div>
                    <div class="scanner-overlay">
                        <div class="scanner-frame"></div>
                    </div>
                    <button class="btn btn-warning" id="stopScannerBtn">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­</button>
                    <div id="qrResult" class="qr-result hidden">
                        <p id="qrResultText"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div id="statsModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal('statsModal')">&times;</span>
                <h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ÙÙ„ØªØ±ÙŠÙ† (Ø§Ù„Ù…Ø¹Ù„Ù…: <span id="statsTeacherId"></span>)</h3>
                
                <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
                <div class="stats-tabs">
                    <button class="stats-tab active" onclick="openStatsTab('overall')">Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ù…</button>
                    <button class="stats-tab" onclick="openStatsTab('month1')">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ÙˆÙ„</button>
                    <button class="stats-tab" onclick="openStatsTab('month2')">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ</button>
                    <button class="stats-tab" onclick="openStatsTab('month3')">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø«</button>
                </div>
                
                <!-- Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ù… -->
                <div id="overallStats" class="stats-tab-content active">
                    <h4>Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ù‡Ø±</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <h4>Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ</h4>
                            <p style="font-size: 24px; color: #3498db; font-weight: bold;" id="totalStudentsCount">0</p>
                        </div>
                        <div class="stat-item">
                            <h4>Ø£Ù‚Ù„ Ù…Ù† 5</h4>
                            <p style="font-size: 24px; color: #e74c3c; font-weight: bold;" id="statsOverallLess5">0</p>
                        </div>
                        <div class="stat-item">
                            <h4>Ù…Ù† 5 Ø¥Ù„Ù‰ 10</h4>
                            <p style="font-size: 24px; color: #f39c12; font-weight: bold;" id="statsOverall5to10">0</p>
                        </div>
                        <div class="stat-item">
                            <h4>Ù…Ù† 11 Ø¥Ù„Ù‰ 15</h4>
                            <p style="font-size: 24px; color: #3498db; font-weight: bold;" id="statsOverall11to15">0</p>
                        </div>
                        <div class="stat-item">
                            <h4>Ù…Ù† 16 Ø¥Ù„Ù‰ 20</h4>
                            <p style="font-size: 24px; color: #27ae60; font-weight: bold;" id="statsOverall16to20">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ÙˆÙ„ -->
                <div id="month1Stats" class="stats-tab-content">
                    <h4>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ÙˆÙ„</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <h4>Ø£Ù‚Ù„ Ù…Ù† 5</h4>
                            <p style="font-size: 24px; color: #e74c3c; font-weight: bold;" id="statsMonth1Less5">0</p>
                        </div>
                        <div class="stat-item">
                            <h4>Ù…Ù† 5 Ø¥Ù„Ù‰ 10</h4>
                            <p style="font-size: 24px; color: #f39c12; font-weight: bold;" id="statsMonth15to10">0</p>
                        </div>
                        <div class="stat-item">
                            <h4>Ù…Ù† 11 Ø¥Ù„Ù‰ 15</h4>
                            <p style="font-size: 24px; color: #3498db; font-weight: bold;" id="statsMonth111to15">0</p>
                        </div>
                        <div class="stat-item">
                            <h4>Ù…Ù† 16 Ø¥Ù„Ù‰ 20</h4>
                            <p style="font-size: 24px; color: #27ae60; font-weight: bold;" id="statsMonth116to20">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ -->
                <div id="month2Stats" class="stats-tab-content">
                    <h4>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <h4>Ø£Ù‚Ù„ Ù…Ù† 5</h4>
                            <p style="font-size: 24px; color: #e74c3c; font-weight: bold;" id="statsMonth2Less5">0</p>
                        </div>
                        <div class="stat-item">
                            <h4>Ù…Ù† 5 Ø¥Ù„Ù‰ 10</h4>
                            <p style="font-size: 24px; color: #f39c12; font-weight: bold;" id="statsMonth25to10">0</p>
                        </div>
                        <div class="stat-item">
                            <h4>Ù…Ù† 11 Ø¥Ù„Ù‰ 15</h4>
                            <p style="font-size: 24px; color: #3498db; font-weight: bold;" id="statsMonth211to15">0</p>
                        </div>
                        <div class="stat-item">
                            <h4>Ù…Ù† 16 Ø¥Ù„Ù‰ 20</h4>
                            <p style="font-size: 24px; color: #27ae60; font-weight: bold;" id="statsMonth216to20">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø« -->
                <div id="month3Stats" class="stats-tab-content">
                    <h4>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø«</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <h4>Ø£Ù‚Ù„ Ù…Ù† 5</h4>
                            <p style="font-size: 24px; color: #e74c3c; font-weight: bold;" id="statsMonth3Less5">0</p>
                        </div>
                        <div class="stat-item">
                            <h4>Ù…Ù† 5 Ø¥Ù„Ù‰ 10</h4>
                            <p style="font-size: 24px; color: #f39c12; font-weight: bold;" id="statsMonth35to10">0</p>
                        </div>
                        <div class="stat-item">
                            <h4>Ù…Ù† 11 Ø¥Ù„Ù‰ 15</h4>
                            <p style="font-size: 24px; color: #3498db; font-weight: bold;" id="statsMonth311to15">0</p>
                        </div>
                        <div class="stat-item">
                            <h4>Ù…Ù† 16 Ø¥Ù„Ù‰ 20</h4>
                            <p style="font-size: 24px; color: #27ae60; font-weight: bold;" id="statsMonth316to20">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù„Ø´Ù‡Ø± -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal('editModal')">&times;</span>
                <div class="edit-modal-header">
                    <h3>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨: <span id="currentStudentName"></span></h3>
                    <div class="current-month-indicator" id="currentMonthIndicator">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ÙˆÙ„</div>
                    <button type="button" class="top-save-btn" onclick="saveAllEdits()">
                        âœ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                    </button>
                </div>
                
                <input type="hidden" id="editStudentId">
                <input type="hidden" id="currentEditMonth">
                
                <div class="edit-form-grid" id="editFormContainer">
                    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ -->
                </div>
            </div>
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
        <div id="syncManagementModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal('syncManagementModal')">&times;</span>
                <h3>âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
                
                <div class="sync-controls-panel">
                    <div class="sync-status-card">
                        <h4>ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
                        <div class="status-grid">
                            <div class="status-item">
                                <span class="status-label">Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©:</span>
                                <span class="status-value" id="syncPendingCount">0</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">ØªÙ… Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ø§:</span>
                                <span class="status-value" id="syncCompletedCount">0</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">ÙØ´Ù„Øª:</span>
                                <span class="status-value" id="syncFailedCount">0</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©:</span>
                                <span class="status-value" id="lastSyncTime">Ù„Ù… ØªØªÙ…</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sync-actions-grid">
                        <button class="btn btn-warning" onclick="forceReSync()">
                            ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒÙ„
                        </button>
                        <button class="btn" style="background: linear-gradient(135deg, #3498db, #2980b9);" 
                                onclick="verifySyncStatus()">
                            ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
                        </button>
                        <button class="btn btn-success" onclick="syncMissingData()">
                            ğŸ“¤ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯ ÙÙ‚Ø·
                        </button>
                        <button class="btn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);" 
                                onclick="showSyncHistory()">
                            ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø§Øª
                        </button>
                    </div>
                    
                    <div class="sync-details-section">
                        <h4>ğŸ” ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h4>
                        <div id="syncDetailsList" class="sync-details-list">
                            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                        </div>
                    </div>
                    
                    <div class="sync-options">
                        <h4>âš™ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h4>
                        <div class="option-item">
                            <input type="checkbox" id="autoRetryFailed" checked>
                            <label for="autoRetryFailed">Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</label>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" id="verifyAfterSync" checked>
                            <label for="verifyAfterSync">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©</label>
                        </div>
                        <div class="option-item">
                            <label for="retryInterval">ÙØªØ±Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© (Ø«Ø§Ù†ÙŠØ©):</label>
                            <select id="retryInterval">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="30">30</option>
                                <option value="60">60</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ø³Ø¬Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø§Øª -->
        <div id="syncHistoryModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal('syncHistoryModal')">&times;</span>
                <h3>ğŸ“‹ Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h3>
                <div class="sync-history-container">
                    <table class="sync-history-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                            </tr>
                        </thead>
                        <tbody id="syncHistoryBody">
                            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø³Ø¬Ù„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                        </tbody>
                    </table>
                </div>
                <button class="btn" onclick="clearSyncHistory()" style="margin-top: 15px;">
                    ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
                </button>
            </div>
        </div>
    </div>

    <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© jsQR Ù„Ù…Ø³Ø­ QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

   

    <script>
    // ========== Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø®Ø§ØµØ© Ø¨Ù€ GitHub Pages ==========

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ù„ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ GitHub Pages
    const IS_GITHUB_PAGES = window.location.hostname.includes('github.io');
    
    // ========== Ø§Ù„Ø«ÙˆØ§Ø¨Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙØ­Ø¯ÙÙ‘Ø«Ø© ==========
    const LOCAL_STORAGE_KEY = 'studentsData';
    const PENDING_UPDATES_KEY = 'pendingUpdates';
    const TEACHER_SESSION_KEY = 'teacherSession';
    const SYNC_HISTORY_KEY = 'syncHistory';
    const FAILED_UPDATES_KEY = 'failedUpdates';
    const SYNC_VERIFICATION_KEY = 'syncVerification';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwcaLokiABRJmf9LzZOAskFoKhdLvOeoFHXt9-a5zAb5eTSMwqyNCzgB_HDOsWF9-hO/exec'; 
    
    const STUDENT_PROPERTIES = {
        'ID': 'id',
        'Barcode': 'barcode',
        'Ø§Ù„Ø§Ø³Ù…': 'studentName',
        'Ø§Ù„Ø´Ø¹Ø¨Ø©': 'className',
        'Ø§Ù„Ù…Ø¹Ø±Ù': 'teacherId',
        'Ù…ÙˆØ§Ø¸Ø¨Ø© 1 ': 'attendance1', 
        'Ø´ÙÙ‡ÙŠ 1': 'oral1',
        'ÙˆØ§Ø¬Ø¨Ø§Øª 1': 'homework1',
        'ØªØ­Ø±ÙŠØ±ÙŠ 1': 'written1',
        'Ø§Ù„Ù…Ø¬Ù…Ù€Ù€Ù€Ù€Ù€ÙˆØ¹1': 'total1',
        'Ù…Ø­ØµÙ„Ø©1': 'result1',
        'Ù…ÙˆØ§Ø¸Ø¨Ø© 2': 'attendance2',
        'Ø´ÙÙ‡ÙŠ 2': 'oral2',
        'ÙˆØ§Ø¬Ø¨Ø§Øª 2': 'homework2',
        'ØªØ­Ø±ÙŠØ±ÙŠ 2': 'written2',
        'Ø§Ù„Ù…Ø¬Ù…Ù€Ù€Ù€Ù€Ù€ÙˆØ¹2': 'total2',
        'Ù…Ø­ØµÙ„Ø©2': 'result2',
        'Ù…ÙˆØ§Ø¸Ø¨Ø© 3': 'attendance3',
        'ÙˆØ§Ø¬Ø¨Ø§Øª 3': 'homework3',
        'Ø´ÙÙ‡ÙŠ 3': 'oral3',
        'ØªØ­Ø±ÙŠØ±ÙŠ 3': 'written3',
        'Ø§Ù„Ù…Ø¬Ù…Ù€Ù€Ù€Ù€Ù€ÙˆØ¹': 'total3', 
        'Ù…Ø­ØµÙ„Ø©3': 'result3'
    };

    // ========== Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ Ø§Ù„ØµÙØ­Ø© ==========
    const teacherIdInput = document.getElementById('teacherId');
    const loginSection = document.getElementById('loginSection');
    const monthSelectionSection = document.getElementById('monthSelectionSection');
    const welcomeTeacherName = document.getElementById('welcomeTeacherName');
    const loadingDiv = document.getElementById('loading');
    const connectionStatus = document.getElementById('connectionStatus');
    const loginBtn = document.getElementById('loginBtn');
    const retryBtn = document.getElementById('retryBtn');
    const useLocalDataBtn = document.getElementById('useLocalDataBtn');
    const installBtn = document.getElementById('installBtn');
    const debugInfo = document.getElementById('debugInfo');
    const pwaStatus = document.getElementById('pwaStatus');

    // ========== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ==========
    let currentTeacherId = '';
    let allStudents = []; 
    let pendingUpdates = [];
    let failedUpdates = [];
    let syncHistory = [];
    let syncVerification = {};
    let isSyncing = false; 
    let isVerifying = false;
    let autoSyncInterval; 
    let retryInterval = 10000;
    let currentMonth = 1;
    let qrScanner = null;
    let qrStream = null;
    let deferredPrompt = null;
    let retryAttempts = 0;
    const MAX_RETRY_ATTEMPTS = 3;

    // ========== Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ÙŠØ¯ÙˆÙŠ ==========
    function createBackupButton() {
        // Ø­Ø°Ù Ø§Ù„Ø²Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        const existingBtn = document.getElementById('manualBackupBtn');
        if (existingBtn) existingBtn.remove();
        
        const backupBtn = document.createElement('button');
        backupBtn.id = 'manualBackupBtn';
        backupBtn.innerHTML = 'ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ';
        backupBtn.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            transition: all 0.3s ease;
        `;
        
        backupBtn.onclick = () => {
            const success = backupUserData();
            if (success) {
                showSuccess('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            } else {
                showError('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
            }
        };
        
        backupBtn.onmouseenter = () => {
            backupBtn.style.transform = 'translateY(-2px)';
            backupBtn.style.boxShadow = '0 6px 18px rgba(0,0,0,0.3)';
        };
        
        backupBtn.onmouseleave = () => {
            backupBtn.style.transform = 'translateY(0)';
            backupBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
        };
        
        document.body.appendChild(backupBtn);
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª
        setTimeout(() => {
            if (allStudents.length > 0) {
                backupBtn.style.display = 'block';
            }
        }, 2000);
        
        return backupBtn;
    }

    // ========== Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ù…Ø­Ø³Ù‘Ù† ==========
    function backupUserData() {
        try {
            const backup = {
                timestamp: new Date().toISOString(),
                teacherId: currentTeacherId,
                students: JSON.parse(JSON.stringify(allStudents)),
                pendingUpdates: JSON.parse(JSON.stringify(pendingUpdates)),
                failedUpdates: JSON.parse(JSON.stringify(failedUpdates)),
                syncHistory: JSON.parse(JSON.stringify(syncHistory))
            };
            
            const backupKey = 'grades_backup_' + Date.now();
            localStorage.setItem(backupKey, JSON.stringify(backup));
            console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', backupKey);
            
            // Ø­ÙØ¸ ÙÙ‚Ø· Ø¢Ø®Ø± 5 Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            const backupKeys = Object.keys(localStorage)
                .filter(key => key.startsWith('grades_backup_'))
                .sort()
                .reverse();
            
            if (backupKeys.length > 5) {
                for (let i = 5; i < backupKeys.length; i++) {
                    localStorage.removeItem(backupKeys[i]);
                }
            }
            
            return true;
        } catch (error) {
            console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ:', error);
            return false;
        }
    }

    function restoreUserData() {
        try {
            const backupKeys = Object.keys(localStorage)
                .filter(key => key.startsWith('grades_backup_'))
                .sort()
                .reverse();
            
            if (backupKeys.length > 0) {
                const latestBackup = JSON.parse(localStorage.getItem(backupKeys[0]));
                
                if (latestBackup && latestBackup.teacherId === currentTeacherId) {
                    if (validateBackupData(latestBackup)) {
                        allStudents = latestBackup.students || [];
                        pendingUpdates = latestBackup.pendingUpdates || [];
                        failedUpdates = latestBackup.failedUpdates || [];
                        syncHistory = latestBackup.syncHistory || [];
                        
                        saveDataToLocalStorage();
                        savePendingUpdates();
                        saveFailedUpdates();
                        saveSyncHistory();
                        
                        console.log('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
                        showSuccess(`ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© ${allStudents.length} Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©`);
                        return true;
                    }
                }
            }
            return false;
        } catch (error) {
            console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            return false;
        }
    }

    function validateBackupData(backupData) {
        if (!backupData || typeof backupData !== 'object') return false;
        if (!backupData.students || !Array.isArray(backupData.students)) return false;
        if (backupData.teacherId !== currentTeacherId) return false;
        if (backupData.students.length === 0) return false;
        
        const sampleStudent = backupData.students[0];
        if (!sampleStudent.id || !sampleStudent.studentName) return false;
        
        return true;
    }

    // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ==========
    function initializeSession() {
        console.log('ğŸ”’ ØªÙ‡ÙŠØ¦Ø© Ø¬Ù„Ø³Ø© Ø¢Ù…Ù†Ø© Ù…Ø¹ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        const sessionData = loadTeacherSession();
        if (sessionData && sessionData.teacherId) {
            currentTeacherId = sessionData.teacherId;
            teacherIdInput.value = currentTeacherId;
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
            if (tryRestoreLocalData()) {
                return true;
            }
            
            // Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©ØŒ Ø¬Ø±Ø¨ Ø§Ù„Ø³ÙŠØ±ÙØ±
            setTimeout(async () => {
                await autoLogin();
            }, 1000);
        }
        return false;
    }

    function tryRestoreLocalData() {
        try {
            // Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            const backupKeys = Object.keys(localStorage)
                .filter(key => key.startsWith('grades_backup_'))
                .sort()
                .reverse();
            
            let restored = false;
            
            if (backupKeys.length > 0) {
                console.log(`ğŸ“‚ ÙŠÙˆØ¬Ø¯ ${backupKeys.length} Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©`);
                
                for (const backupKey of backupKeys) {
                    const backupData = JSON.parse(localStorage.getItem(backupKey));
                    
                    if (backupData && backupData.teacherId === currentTeacherId) {
                        if (validateBackupData(backupData)) {
                            allStudents = backupData.students || [];
                            pendingUpdates = backupData.pendingUpdates || [];
                            failedUpdates = backupData.failedUpdates || [];
                            syncHistory = backupData.syncHistory || [];
                            
                            saveDataToLocalStorage();
                            savePendingUpdates();
                            saveFailedUpdates();
                            saveSyncHistory();
                            
                            console.log(`âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†: ${backupKey}`);
                            showSuccess(`ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© ${allStudents.length} Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©`);
                            
                            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                            const backupBtn = document.getElementById('manualBackupBtn');
                            if (backupBtn && allStudents.length > 0) {
                                backupBtn.style.display = 'block';
                            }
                            
                            restored = true;
                            break;
                        }
                    }
                }
            }
            
            // Ø«Ø§Ù†ÙŠØ§Ù‹: Ø¥Ø°Ø§ Ù„Ù… ØªÙ†Ø¬Ø­ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŒ Ø¬Ø±Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            if (!restored) {
                const localData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (localData) {
                    const parsedData = JSON.parse(localData);
                    const filteredStudents = parsedData.students ? 
                        parsedData.students.filter(s => s.teacherId === currentTeacherId) : [];
                    
                    if (filteredStudents.length > 0) {
                        allStudents = filteredStudents;
                        pendingUpdates = loadPendingUpdates();
                        failedUpdates = loadFailedUpdates();
                        syncHistory = loadSyncHistory();
                        
                        const integrity = verifyDataIntegrity();
                        
                        if (integrity.valid) {
                            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©');
                            
                            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                            const backupBtn = document.getElementById('manualBackupBtn');
                            if (backupBtn && allStudents.length > 0) {
                                backupBtn.style.display = 'block';
                            }
                            
                            completeLogin();
                            return true;
                        }
                    }
                }
            }
            
            return restored;
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', error);
            return false;
        }
    }

    function verifyDataIntegrity() {
        const issues = [];
        
        if (!Array.isArray(allStudents)) {
            issues.push('Ù‡ÙŠÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­');
            allStudents = [];
        }
        
        if (!Array.isArray(pendingUpdates)) {
            issues.push('Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ØºÙŠØ± ØµØ­ÙŠØ­');
            pendingUpdates = [];
        }
        
        if (!Array.isArray(failedUpdates)) {
            issues.push('Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø© ØºÙŠØ± ØµØ­ÙŠØ­');
            failedUpdates = [];
        }
        
        allStudents.forEach((student, index) => {
            if (!student.id || !student.studentName) {
                issues.push(`Ø·Ø§Ù„Ø¨ #${index + 1} ÙŠÙØªÙ‚Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©`);
            }
            
            const fields = ['attendance1', 'oral1', 'homework1', 'written1',
                           'attendance2', 'oral2', 'homework2', 'written2',
                           'attendance3', 'homework3', 'oral3', 'written3'];
            
            fields.forEach(field => {
                if (student[field] && isNaN(parseFloat(student[field]))) {
                    issues.push(`Ø¯Ø±Ø¬Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„Ø·Ø§Ù„Ø¨ ${student.studentName} ÙÙŠ ${field}`);
                }
            });
        });
        
        return {
            valid: issues.length === 0,
            issues: issues,
            studentCount: allStudents.length,
            pendingCount: pendingUpdates.length,
            failedCount: failedUpdates.length
        };
    }

    function completeLogin() {
        welcomeTeacherName.textContent = currentTeacherId;
        populateClassFilters();
        updatePendingCount();
        
        loginSection.classList.add('hidden');
        monthSelectionSection.classList.remove('hidden');
        
        const integrity = verifyDataIntegrity();
        showSuccess(`ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentTeacherId}! ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allStudents.length} Ø·Ø§Ù„Ø¨`);
        
        if (pendingUpdates.length > 0) {
            showSuccess(`âš ï¸ ÙŠÙˆØ¬Ø¯ ${pendingUpdates.length} ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„Ù‚ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©`);
        }
        
        if (failedUpdates.length > 0) {
            showError(`âŒ ÙŠÙˆØ¬Ø¯ ${failedUpdates.length} ØªØ¹Ø¯ÙŠÙ„ ÙØ´Ù„Øª Ù…Ø²Ø§Ù…Ù†ØªÙ‡`);
        }
    }

    // ========== Ù†Ø¸Ø§Ù… PWA ÙˆØ§Ù„ØªØ«Ø¨ÙŠØª (Ù…ÙØµÙ„Ø­ Ù„Ù€ GitHub Pages) ==========
    function initializePWA() {
        console.log('ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… PWA...');
        
        // Ø¹Ù„Ù‰ GitHub PagesØŒ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… HTTPS
        const isSecure = window.location.protocol === 'https:';
        
        if (isSecure && 'serviceWorker' in navigator) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø³Ø§Ø± Ù†Ø³Ø¨ÙŠ Ù„Ù€ service worker
            navigator.serviceWorker.register('service-worker.js?v=' + Date.now())
            .then(function(registration) {
                console.log('âœ… Service Worker Ù…Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­:', registration);
                updatePWAStatus('âœ… Service Worker Ù†Ø´Ø·');
            })
            .catch(function(error) {
                console.log('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker:', error);
                updatePWAStatus('âŒ Service Worker ØºÙŠØ± Ù†Ø´Ø·');
            });
        } else {
            console.log('â„¹ï¸ Service Worker ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙŠØ§Ù‚');
            updatePWAStatus('â„¹ï¸ ÙŠØªØ·Ù„Ø¨ HTTPS Ù„ØªØ´ØºÙŠÙ„ Service Worker');
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('ğŸ¯ Ø­Ø¯Ø« beforeinstallprompt ØªÙ… ØªØ´ØºÙŠÙ„Ù‡');
            e.preventDefault();
            window.deferredPrompt = e;
            showInstallButton();
            updatePWAStatus('ğŸ“² Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ«Ø¨ÙŠØª');
        });

        window.addEventListener('appinstalled', (evt) => {
            console.log('ğŸ‰ ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
            hideInstallButton();
            window.deferredPrompt = null;
            updatePWAStatus('âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø«Ø¨Øª');
        });

        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('ğŸ“± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ ÙÙŠ ÙˆØ¶Ø¹ PWA');
            hideInstallButton();
            updatePWAStatus('âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø«Ø¨Øª ÙˆÙŠØ¹Ù…Ù„');
        }

        if (installBtn) {
            installBtn.addEventListener('click', installPWA);
        }
    }

    // ========== Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (Ù…ÙØµÙ„Ø­) ==========
    function initializeSyncManagement() {
        console.log('ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');
        
        pendingUpdates = loadPendingUpdates();
        failedUpdates = loadFailedUpdates();
        syncHistory = loadSyncHistory();
        
        updatePendingCount();
        
        // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        for (let i = 1; i <= 3; i++) {
            const btn = document.getElementById(`manageSyncBtn${i}`);
            if (btn) {
                btn.addEventListener('click', () => {
                    showSyncManagement();
                });
            }
        }
        
        const allBtn = document.getElementById('manageSyncBtnAll');
        if (allBtn) {
            allBtn.addEventListener('click', () => {
                showSyncManagement();
            });
        }
        
        // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        for (let i = 1; i <= 3; i++) {
            const btn = document.getElementById(`syncSheetsBtn${i}`);
            if (btn) {
                btn.addEventListener('click', () => {
                    syncPendingUpdates(false);
                });
            }
        }
        
        const syncAllBtn = document.getElementById('syncSheetsBtnAll');
        if (syncAllBtn) {
            syncAllBtn.addEventListener('click', () => {
                syncPendingUpdates(false);
            });
        }
        
        startSyncMonitoring();
    }

    function showSyncManagement() {
        updateSyncManagementUI();
        const modal = document.getElementById('syncManagementModal');
        if (modal) {
            modal.style.display = 'block';
            
            // ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            const autoRetryCheckbox = document.getElementById('autoRetryFailed');
            if (autoRetryCheckbox) {
                autoRetryCheckbox.checked = true;
            }
            
            const verifyAfterSync = document.getElementById('verifyAfterSync');
            if (verifyAfterSync) {
                verifyAfterSync.checked = true;
            }
            
            const retryIntervalSelect = document.getElementById('retryInterval');
            if (retryIntervalSelect) {
                retryIntervalSelect.value = '10';
            }
        }
    }

    function updateSyncManagementUI() {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        const syncPendingCount = document.getElementById('syncPendingCount');
        const syncFailedCount = document.getElementById('syncFailedCount');
        const syncCompletedCount = document.getElementById('syncCompletedCount');
        const lastSyncTime = document.getElementById('lastSyncTime');
        
        if (syncPendingCount) syncPendingCount.textContent = pendingUpdates.length;
        if (syncFailedCount) syncFailedCount.textContent = failedUpdates.length;
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
        const completedCount = syncHistory.filter(h => h.status === 'success').reduce((sum, h) => sum + (h.count || 0), 0);
        if (syncCompletedCount) syncCompletedCount.textContent = completedCount;
        
        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©
        const lastSuccess = syncHistory.filter(h => h.status === 'success').sort((a, b) => 
            new Date(b.timestamp) - new Date(a.timestamp)
        )[0];
        
        if (lastSyncTime) {
            lastSyncTime.textContent = lastSuccess ? 
                new Date(lastSuccess.timestamp).toLocaleString('ar-SA') : 'Ù„Ù… ØªØªÙ…';
        }
        
        // ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
        updateSyncDetailsList();
    }

    function updateSyncDetailsList() {
        const container = document.getElementById('syncDetailsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (pendingUpdates.length === 0 && failedUpdates.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</p>';
            return;
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
        pendingUpdates.forEach((update, index) => {
            const student = allStudents.find(s => s.id === update.id);
            const detailItem = document.createElement('div');
            detailItem.className = 'sync-detail-item';
            detailItem.innerHTML = `
                <div class="sync-detail-info">
                    <strong>${student ? student.studentName : 'Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</strong>
                    <div style="font-size: 12px; color: #666;">
                        ${Object.keys(update).filter(k => !['row', 'id', 'error', 'retryCount'].includes(k)).join(', ')}
                    </div>
                </div>
                <span class="sync-detail-status status-pending">â³ Ù…Ø¹Ù„Ù‚</span>
            `;
            container.appendChild(detailItem);
        });
        
        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©
        failedUpdates.forEach((update, index) => {
            const student = allStudents.find(s => s.id === update.id);
            const detailItem = document.createElement('div');
            detailItem.className = 'sync-detail-item';
            detailItem.innerHTML = `
                <div class="sync-detail-info">
                    <strong>${student ? student.studentName : 'Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</strong>
                    <div style="font-size: 12px; color: #666;">
                        ${update.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
                    </div>
                </div>
                <span class="sync-detail-status status-failed">âŒ ÙØ´Ù„</span>
                <button class="btn" style="padding: 3px 8px; font-size: 12px;" 
                        onclick="retryFailedUpdate(${index})">
                    ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©
                </button>
            `;
            container.appendChild(detailItem);
        });
    }

    async function syncPendingUpdates(isAuto = false) {
        if (pendingUpdates.length === 0 || isSyncing) {
            if (!isAuto && pendingUpdates.length === 0) {
                showSuccess('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©.');
            }
            return false;
        }

        isSyncing = true;
        const updatesToSync = [...pendingUpdates];
        const totalCount = updatesToSync.length;

        showLoading(true, `â˜ï¸ Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© ${totalCount} ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹ Google Sheets...`);
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        document.querySelectorAll('[id^="syncStatus"]').forEach(status => {
            if (status) status.textContent = `Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©: Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (${totalCount})...`;
        });
        
        // ØªØ¹Ø·ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        document.querySelectorAll('[id^="syncSheetsBtn"]').forEach(btn => {
            if (btn) btn.disabled = true;
        });

        try {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify({ 
                    updates: updatesToSync,
                    teacherId: currentTeacherId,
                    timestamp: new Date().toISOString()
                })
            });
            
            const data = await response.json();
            
            showLoading(false);
            
            // ØªÙ…ÙƒÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
            document.querySelectorAll('[id^="syncSheetsBtn"]').forEach(btn => {
                if (btn) btn.disabled = false;
            });
            
            if (data.status === 'success') {
                const successCount = data.updatedCount || totalCount;
                
                // Ø¥Ø²Ø§Ù„Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ø§
                pendingUpdates = pendingUpdates.filter(update => 
                    !updatesToSync.some(synced => synced.id === update.id)
                );
                
                savePendingUpdates();
                
                // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¬Ù„
                addToSyncHistory(
                    isAuto ? 'Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©' : 'Ù…Ø²Ø§Ù…Ù†Ø© ÙŠØ¯ÙˆÙŠØ©',
                    'success',
                    successCount,
                    `ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ${successCount} Ù…Ù† ${totalCount} ØªØ¹Ø¯ÙŠÙ„`
                );
                
                showSuccess(`âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${successCount} Ø®Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!`);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®ÙŠØ§Ø± Ù…ÙØ¹Ù„Ø§Ù‹
                const verifyAfterSync = document.getElementById('verifyAfterSync');
                if (verifyAfterSync && verifyAfterSync.checked) {
                    setTimeout(() => {
                        verifySyncStatus();
                    }, 2000);
                } else {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                    await fetchDataFromSheet(currentTeacherId, false);
                }
                
                return true;
                
            } else {
                // Ù†Ù‚Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©
                updatesToSync.forEach(update => {
                    update.error = data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    update.retryCount = (update.retryCount || 0) + 1;
                    failedUpdates.push(update);
                });
                
                saveFailedUpdates();
                
                // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¬Ù„
                addToSyncHistory(
                    isAuto ? 'Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©' : 'Ù…Ø²Ø§Ù…Ù†Ø© ÙŠØ¯ÙˆÙŠØ©',
                    'failed',
                    0,
                    data.error || 'ÙØ´Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©'
                );
                
                showError(`âŒ ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.'}`);
                return false;
            }
            
        } catch (error) {
            showLoading(false);
            
            document.querySelectorAll('[id^="syncSheetsBtn"]').forEach(btn => {
                if (btn) btn.disabled = false;
            });
            
            // Ù†Ù‚Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©
            updatesToSync.forEach(update => {
                update.error = error.message;
                update.retryCount = (update.retryCount || 0) + 1;
                failedUpdates.push(update);
            });
            
            saveFailedUpdates();
            
            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¬Ù„
            addToSyncHistory(
                isAuto ? 'Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©' : 'Ù…Ø²Ø§Ù…Ù†Ø© ÙŠØ¯ÙˆÙŠØ©',
                'failed',
                0,
                error.message
            );
            
            showError('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ' + error.message);
            return false;
            
        } finally {
            isSyncing = false;
            updateAutoSyncStatus();
            updateSyncManagementUI();
        }
    }

    // ========== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ==========
    async function forceReSync() {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ÙˆØ§Ù„ÙØ§Ø´Ù„Ø©ØŸ')) return;
        
        const allUpdates = [...pendingUpdates, ...failedUpdates];
        if (allUpdates.length === 0) {
            showSuccess('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
            return;
        }
        
        showLoading(true, `ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø²Ø§Ù…Ù†Ø© ${allUpdates.length} ØªØ¹Ø¯ÙŠÙ„...`);
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
        pendingUpdates = [];
        failedUpdates = [];
        savePendingUpdates();
        saveFailedUpdates();
        
        // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        pendingUpdates = allUpdates;
        savePendingUpdates();
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        const success = await syncPendingUpdates(false);
        
        if (success) {
            showSuccess(`âœ… ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø²Ø§Ù…Ù†Ø© ${allUpdates.length} ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­`);
            updateSyncManagementUI();
        }
    }

    async function syncMissingData() {
        showLoading(true, 'ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø©...');
        
        try {
            const response = await fetch(WEB_APP_URL);
            const data = await response.json();
            
            if (data.status === 'success' && data.data) {
                const serverData = mapData(data.data);
                const serverStudents = serverData.filter(s => s.teacherId === currentTeacherId);
                
                let missingCount = 0;
                
                serverStudents.forEach(serverStudent => {
                    const localStudent = allStudents.find(s => s.id === serverStudent.id);
                    if (localStudent) {
                        const fields = [
                            'attendance1', 'oral1', 'homework1', 'written1',
                            'attendance2', 'oral2', 'homework2', 'written2',
                            'attendance3', 'homework3', 'oral3', 'written3'
                        ];
                        
                        fields.forEach(field => {
                            const serverValue = formatGrade(serverStudent[field]);
                            const localValue = formatGrade(localStudent[field]);
                            
                            if (serverValue !== localValue) {
                                missingCount++;
                                const update = {
                                    row: localStudent.originalRowIndex,
                                    id: localStudent.id,
                                    [field]: localValue
                                };
                                
                                const exists = pendingUpdates.some(u => 
                                    u.id === update.id && u[field] === update[field]
                                );
                                
                                if (!exists) {
                                    pendingUpdates.push(update);
                                }
                            }
                        });
                    }
                });
                
                savePendingUpdates();
                
                if (missingCount > 0) {
                    showSuccess(`ğŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${missingCount} Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø©`);
                    updateSyncManagementUI();
                    await syncPendingUpdates(false);
                } else {
                    showSuccess('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ²Ø§Ù…Ù†Ø©ØŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø©');
                }
            }
        } catch (error) {
            showError('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    async function verifySyncStatus() {
        if (isVerifying) return;
        
        isVerifying = true;
        showLoading(true, 'ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');
        
        try {
            const response = await fetch(WEB_APP_URL);
            const data = await response.json();
            
            if (data.status === 'success' && data.data) {
                const serverData = mapData(data.data);
                const serverStudents = serverData.filter(s => s.teacherId === currentTeacherId);
                
                let verified = 0;
                let failed = 0;
                const verificationResults = [];
                
                allStudents.forEach(localStudent => {
                    const serverStudent = serverStudents.find(s => s.id === localStudent.id);
                    
                    if (!serverStudent) {
                        failed++;
                        verificationResults.push({
                            id: localStudent.id,
                            name: localStudent.studentName,
                            status: 'missing',
                            message: 'Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±'
                        });
                        return;
                    }
                    
                    const fields = [
                        'attendance1', 'oral1', 'homework1', 'written1',
                        'attendance2', 'oral2', 'homework2', 'written2',
                        'attendance3', 'homework3', 'oral3', 'written3'
                    ];
                    
                    const mismatches = fields.filter(field => {
                        const serverValue = formatGrade(serverStudent[field]);
                        const localValue = formatGrade(localStudent[field]);
                        return serverValue !== localValue;
                    });
                    
                    if (mismatches.length === 0) {
                        verified++;
                        verificationResults.push({
                            id: localStudent.id,
                            name: localStudent.studentName,
                            status: 'verified',
                            message: 'Ù…Ø·Ø§Ø¨Ù‚'
                        });
                    } else {
                        failed++;
                        verificationResults.push({
                            id: localStudent.id,
                            name: localStudent.studentName,
                            status: 'mismatch',
                            message: `Ø§Ø®ØªÙ„Ø§Ù ÙÙŠ: ${mismatches.join(', ')}`
                        });
                    }
                });
                
                syncVerification = {
                    timestamp: new Date().toISOString(),
                    verified,
                    failed,
                    total: allStudents.length,
                    results: verificationResults
                };
                saveSyncVerification();
                
                showLoading(false);
                
                alertWithHTML('Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù‚Ù‚', `
                    <h4>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù‚Ù‚:</h4>
                    <div style="margin: 15px 0;">
                        <span class="badge badge-success">âœ… Ù…Ø·Ø§Ø¨Ù‚: ${verified}</span>
                        <span class="badge badge-danger">âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚: ${failed}</span>
                        <span class="badge badge-info">ğŸ“Š Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${allStudents.length}</span>
                    </div>
                    ${failed > 0 ? 
                        `<button class="btn btn-warning" onclick="fixVerificationIssues()" style="margin-top: 10px;">
                            ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                        </button>` : 
                        ''
                    }
                `);
                
            }
        } catch (error) {
            showError('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ' + error.message);
        } finally {
            isVerifying = false;
        }
    }

    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ==========
    function saveTeacherSession(teacherId) {
        try {
            const sessionData = {
                teacherId: teacherId,
                timestamp: new Date().toISOString(),
                lastLogin: new Date().toISOString()
            };
            localStorage.setItem(TEACHER_SESSION_KEY, JSON.stringify(sessionData));
            return true;
        } catch (error) {
            console.error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø¹Ù„Ù…:', error);
            return false;
        }
    }

    function loadTeacherSession() {
        try {
            const data = localStorage.getItem(TEACHER_SESSION_KEY);
            return data ? JSON.parse(data) : null;
        } catch (error) {
            return null;
        }
    }

    function savePendingUpdates() {
        try {
            localStorage.setItem(PENDING_UPDATES_KEY, JSON.stringify(pendingUpdates));
            updatePendingCount();
            return true;
        } catch (error) {
            showError('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©: ' + error.message);
            return false;
        }
    }

    function loadPendingUpdates() {
        try {
            const data = localStorage.getItem(PENDING_UPDATES_KEY);
            return data ? JSON.parse(data) : [];
        } catch (error) {
            return [];
        }
    }

    function saveFailedUpdates() {
        try {
            localStorage.setItem(FAILED_UPDATES_KEY, JSON.stringify(failedUpdates));
            return true;
        } catch (error) {
            console.error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©:', error);
            return false;
        }
    }

    function loadFailedUpdates() {
        try {
            const data = localStorage.getItem(FAILED_UPDATES_KEY);
            return data ? JSON.parse(data) : [];
        } catch (error) {
            return [];
        }
    }

    function saveSyncHistory() {
        try {
            localStorage.setItem(SYNC_HISTORY_KEY, JSON.stringify(syncHistory));
            return true;
        } catch (error) {
            console.error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø§Øª:', error);
            return false;
        }
    }

    function loadSyncHistory() {
        try {
            const data = localStorage.getItem(SYNC_HISTORY_KEY);
            return data ? JSON.parse(data) : [];
        } catch (error) {
            return [];
        }
    }

    function saveSyncVerification() {
        try {
            localStorage.setItem(SYNC_VERIFICATION_KEY, JSON.stringify(syncVerification));
            return true;
        } catch (error) {
            console.error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù‚Ù‚:', error);
            return false;
        }
    }

    function loadSyncVerification() {
        try {
            const data = localStorage.getItem(SYNC_VERIFICATION_KEY);
            return data ? JSON.parse(data) : {};
        } catch (error) {
            return {};
        }
    }

    function saveDataToLocalStorage() {
        try {
            const dataToSave = {
                students: allStudents,
                teacherId: currentTeacherId,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            return true;
        } catch (error) {
            showError('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©: ' + error.message);
            return false;
        }
    }

    function updatePendingCount() {
        const count = pendingUpdates.length;
        document.querySelectorAll('#pendingCount1, #pendingCount2, #pendingCount3, #pendingCountAll').forEach(span => {
            if (span) {
                span.textContent = count;
                if (count > 0) {
                    span.classList.remove('hidden');
                } else {
                    span.classList.add('hidden');
                }
            }
        });
    }

    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ==========
    function startSyncMonitoring() {
        setInterval(() => {
            if (navigator.onLine && pendingUpdates.length > 0 && !isSyncing) {
                attemptAutoSync();
            }
        }, 30000);
    }

    function attemptAutoSync() {
        if (navigator.onLine && pendingUpdates.length > 0 && !isSyncing) {
            console.log('Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©: Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª...');
            syncPendingUpdates(true);
        }
    }

    async function retryFailedUpdate(index) {
        const update = failedUpdates[index];
        if (!update) return;
        
        failedUpdates.splice(index, 1);
        saveFailedUpdates();
        
        pendingUpdates.push(update);
        savePendingUpdates();
        
        await syncPendingUpdates(true);
        updateSyncManagementUI();
    }

    function updateAutoSyncStatus() {
        const hasPending = pendingUpdates.length > 0;
        const isOnline = navigator.onLine;

        let statusText = 'Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©: Ù…ØªÙˆÙ‚ÙØ©';
        let statusColor = '#666';

        if (hasPending && isOnline) {
            statusText = `Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©: Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„ (ØªØ¹Ø¯ÙŠÙ„Ø§Øª: ${pendingUpdates.length})`;
            statusColor = '#27ae60';
        } else if (hasPending && !isOnline) {
            statusText = `Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©: Ù…ØªÙˆÙ‚ÙØ© (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ù†ØªØ±Ù†Øª)`;
            statusColor = '#f39c12';
        }

        document.querySelectorAll('[id^="syncStatus"]').forEach(status => {
            if (status) {
                status.textContent = statusText;
                status.style.color = statusColor;
            }
        });
    }

    // ========== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ==========
    document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ GitHub Pages...');
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø£ÙˆÙ„Ø§Ù‹
        createBackupButton();
        
        // ØªÙ‡ÙŠØ¦Ø© Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        try {
            localStorage.setItem('storage_test', 'test');
            localStorage.removeItem('storage_test');
            console.log('âœ… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
        } catch (e) {
            console.error('âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ:', e);
            showError('âš ï¸ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ØºÙŠØ± Ù…ØªÙˆÙØ±. Ù‚Ø¯ Ù„Ø§ ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
        }
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const sessionRestored = initializeSession();
        
        // ØªÙ‡ÙŠØ¦Ø© PWA (Ø¹Ù„Ù‰ GitHub Pages ÙŠÙƒÙˆÙ† HTTPS)
        initializePWA();
        
        // ØªÙ‡ÙŠØ¦Ø© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©
        initializeMonthSystem();
        initializeQRScanner();
        initializeStatistics();
        initializeSyncManagement();
        
        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ø§Ù…Ø©
        setupGlobalEvents();
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
        loadInitialData();
        
        console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰ GitHub Pages');
        updateDebugInfo('âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ù„Ù‰ GitHub Pages');
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­
        if (IS_GITHUB_PAGES) {
            updateDebugInfo('ğŸŒ ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ GitHub Pages');
        }
    });

    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ==========
   // ÙÙŠ Ø¯Ø§Ù„Ø© initializeMonthSystem() Ø£Ø¶Ù:
function initializeMonthSystem() {
    console.log('Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù‡ÙˆØ±...');
    
    // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ù‡ÙˆØ±
    document.querySelectorAll('.month-card').forEach(card => {
        card.addEventListener('click', function() {
            const month = this.classList.contains('month-1') ? 1 : 
                         this.classList.contains('month-2') ? 2 : 
                         this.classList.contains('month-3') ? 3 : 'all';
            selectMonth(month);
        });
    });
    
    // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹ÙˆØ¯Ø©
    document.querySelectorAll('.back-to-selection').forEach(btn => {
        btn.addEventListener('click', backToMonthSelection);
    });
    
    // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    for (let i = 1; i <= 3; i++) {
        const searchInput = document.getElementById(`searchNameInput${i}`);
        const classFilter = document.getElementById(`classNameFilter${i}`);
        const qrBtn = document.getElementById(`qrScanBtn${i}`);
        
        if (searchInput) searchInput.addEventListener('input', updateDisplayedStudents);
        if (classFilter) classFilter.addEventListener('change', updateDisplayedStudents);
        if (qrBtn) qrBtn.addEventListener('click', () => startQRScanner(i));
    }
    
    // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡ÙˆØ±
    const searchInputAll = document.getElementById('searchNameInputAll');
    const classFilterAll = document.getElementById('classNameFilterAll');
    const qrBtnAll = document.getElementById('qrScanBtnAll');
    
    if (searchInputAll) searchInputAll.addEventListener('input', updateDisplayedStudents);
    if (classFilterAll) classFilterAll.addEventListener('change', updateDisplayedStudents);
    if (qrBtnAll) qrBtnAll.addEventListener('click', () => startQRScanner('all'));
    
    console.log('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù‡ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
}
    function initializeQRScanner() {
        console.log('ØªÙ‡ÙŠØ¦Ø© Ù…Ø§Ø³Ø­ QR Code...');
        
        for (let i = 1; i <= 3; i++) {
            const btn = document.getElementById(`qrScanBtn${i}`);
            if (btn) btn.addEventListener('click', () => startQRScanner(i));
        }
        
        const allBtn = document.getElementById('qrScanBtnAll');
        if (allBtn) allBtn.addEventListener('click', () => startQRScanner('all'));
        
        const stopBtn = document.getElementById('stopScannerBtn');
        if (stopBtn) stopBtn.addEventListener('click', stopQRScanner);
    }

    function initializeStatistics() {
        console.log('ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...');
        
        for (let i = 1; i <= 3; i++) {
            const btn = document.getElementById(`showStatsBtn${i}`);
            if (btn) btn.addEventListener('click', () => showStatistics(i));
        }
        
        const allBtn = document.getElementById('showStatsBtnAll');
        if (allBtn) allBtn.addEventListener('click', () => showStatistics('all'));
    }

    function setupGlobalEvents() {
        if (loginBtn) loginBtn.addEventListener('click', () => login(false));
        if (useLocalDataBtn) useLocalDataBtn.addEventListener('click', () => login(true));
        if (retryBtn) retryBtn.addEventListener('click', initializeData);
        
        setupSearchAndFilters();
        
        // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        document.querySelectorAll('[id^="logoutBtn"]').forEach(btn => {
            btn.addEventListener('click', handleLogout);
        });
    }

    function setupSearchAndFilters() {
        for (let i = 1; i <= 3; i++) {
            const searchInput = document.getElementById(`searchNameInput${i}`);
            const classFilter = document.getElementById(`classNameFilter${i}`);
            
            if (searchInput) {
                searchInput.addEventListener('input', updateDisplayedStudents);
            }
            if (classFilter) {
                classFilter.addEventListener('change', updateDisplayedStudents);
            }
        }

        const searchInputAll = document.getElementById('searchNameInputAll');
        const classFilterAll = document.getElementById('classNameFilterAll');
        
        if (searchInputAll) {
            searchInputAll.addEventListener('input', updateDisplayedStudents);
        }
        if (classFilterAll) {
            classFilterAll.addEventListener('change', updateDisplayedStudents);
        }
    }

    function loadInitialData() {
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        syncHistory = loadSyncHistory();
        syncVerification = loadSyncVerification();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Google Sheets
        setTimeout(initializeData, 1000);
    }

    // ========== Ø¯ÙˆØ§Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
    function showLoading(show, message = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...') {
        if (!loadingDiv) return;
        
        if (show) {
            loadingDiv.classList.remove('hidden');
            loadingDiv.innerHTML = `<p>${message}</p>`;
            loadingDiv.className = 'loading';
        } else {
            loadingDiv.classList.add('hidden');
        }
    }

    function showError(message) {
        showLoading(true, 'âŒ ' + message);
        if (loadingDiv) loadingDiv.className = 'loading error';
    }

    function showSuccess(message) {
        showLoading(true, 'âœ… ' + message);
        if (loadingDiv) loadingDiv.className = 'loading success';
        setTimeout(() => {
            if (loadingDiv) loadingDiv.classList.add('hidden');
        }, 3000);
    }

    function updateDebugInfo(message) {
        if (debugInfo) {
            debugInfo.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
    }

    function updatePWAStatus(message) {
        if (pwaStatus) {
            pwaStatus.textContent = `Ø­Ø§Ù„Ø© PWA: ${message}`;
        }
    }
    // ========== Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ==========

// ========== Ø¯ÙˆØ§Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==========
function mapData(data) {
    const scoreKeys = ['attendance', 'oral', 'homework', 'written'];
    
    return data.map(item => {
        const newItem = {
            originalRowIndex: item.originalRowIndex
        };
        
        for (const [arabicKey, jsKey] of Object.entries(STUDENT_PROPERTIES)) {
            const foundKey = Object.keys(item).find(sheetKey => 
                sheetKey.trim().replace(/\s+/g, ' ') === arabicKey.trim().replace(/\s+/g, ' ')
            );
            
            if (foundKey) {
                let value = item[foundKey];
                
                if (jsKey.includes('total') || jsKey.includes('result')) {
                    newItem[jsKey] = (value !== undefined && value !== '') ? value : 0;
                } else if (scoreKeys.some(key => jsKey.startsWith(key))) {
                    newItem[jsKey] = (value !== undefined && value !== '') ? value : "";
                } else {
                    newItem[jsKey] = (value !== undefined && value !== '') ? value : '';
                }
            } else {
                if (jsKey.includes('total') || jsKey.includes('result')) {
                    newItem[jsKey] = 0;
                } else if (scoreKeys.some(key => jsKey.startsWith(key))) {
                    newItem[jsKey] = "";
                } else {
                    newItem[jsKey] = '';
                }
            }
        }
        
        newItem.id = newItem.id ? newItem.id.toString().trim() : '';
        newItem.teacherId = newItem.teacherId ? newItem.teacherId.toString().trim() : '';
        newItem.barcode = newItem.barcode ? newItem.barcode.toString().trim() : '';
        
        return newItem;
    });
}

function formatGrade(value) {
    if (value === null || value === undefined || value === '') {
        return ''; 
    }
    const strValue = value.toString().trim();
    const numValue = parseFloat(strValue);
    
    if (isNaN(numValue)) {
        return '';
    }
    if (numValue % 1 !== 0) {
         return numValue.toFixed(1);
    }
    return numValue.toString();
}

function calculateTotal(student, term) {
    const att = parseFloat(student[`attendance${term}`]) || 0;
    const oral = parseFloat(student[`oral${term}`]) || 0;
    const hw = parseFloat(student[`homework${term}`]) || 0;
    const written = parseFloat(student[`written${term}`]) || 0;
    return (att + oral + hw + written).toFixed(1).replace(/\.0$/, '');
}

function calculateResult(total) {
    const value = parseFloat(total) || 0;
    const result = (value / 5).toFixed(1);
    return result;
}

function getResultClass(result) {
    const value = parseFloat(result) || 0;
    if (value >= 16) return 'result-cell result-excellent';
    if (value >= 11) return 'result-cell result-good';
    if (value >= 5) return 'result-cell result-average';
    return 'result-cell result-poor';
}

function calculateMonthTotal(month) {
    const fields = {
        1: ['attendance1', 'oral1', 'homework1', 'written1'],
        2: ['attendance2', 'oral2', 'homework2', 'written2'],
        3: ['attendance3', 'homework3', 'oral3', 'written3']
    };
    
    let total = 0;
    fields[month].forEach(field => {
        const input = document.getElementById(`edit${field}`);
        if (input) {
            const value = parseFloat(input.value) || 0;
            total += value;
        }
    });
    
    const result = calculateResult(total);
    
    const totalDisplay = document.getElementById(`totalDisplay${month}`);
    const resultDisplay = document.getElementById(`resultDisplay${month}`);
    
    if (totalDisplay) totalDisplay.textContent = total.toFixed(1);
    if (resultDisplay) resultDisplay.textContent = result;
}

// ========== Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ==========
function populateClassFilters() {
    const classNames = [...new Set(allStudents.map(s => s.className).filter(c => c && c.trim() !== ''))];
    
    for (let i = 1; i <= 3; i++) {
        const filter = document.getElementById(`classNameFilter${i}`);
        if (filter) {
            filter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø´Ø¹Ø¨</option>';
            classNames.sort().forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                filter.appendChild(option);
            });
        }
    }
    
    const allFilter = document.getElementById('classNameFilterAll');
    if (allFilter) {
        allFilter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø´Ø¹Ø¨</option>';
        classNames.sort().forEach(className => {
            const option = document.createElement('option');
            option.value = className;
            option.textContent = className;
            allFilter.appendChild(option);
        });
    }
}

function updateDisplayedStudents() {
    const searchTerm = document.getElementById(`searchNameInput${currentMonth}`)?.value.trim().toLowerCase() || '';
    const selectedClass = document.getElementById(`classNameFilter${currentMonth}`)?.value || '';

    let filteredStudents = allStudents.filter(student => {
        const studentName = student.studentName ? student.studentName.toLowerCase() : '';
        const matchesName = searchTerm === '' || studentName.includes(searchTerm);
        const matchesClass = selectedClass === '' || student.className === selectedClass;
        return matchesName && matchesClass;
    });

    switch (currentMonth) {
        case 1:
            renderMonth1Table(filteredStudents);
            break;
        case 2:
            renderMonth2Table(filteredStudents);
            break;
        case 3:
            renderMonth3Table(filteredStudents);
            break;
        case 'all':
            renderAllMonthsTable(filteredStudents);
            break;
    }
}

function renderMonth1Table(students = allStudents) {
    const tbody = document.getElementById('month1TableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (students.length === 0) {
        tbody.innerHTML = `<tr><td colspan="11" style="text-align: center; color: #e74c3c; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„ØªØ±Ø©.</td></tr>`;
        return;
    }
    
    students.forEach(student => {
        const total1 = calculateTotal(student, 1);
        const result1 = calculateResult(total1);

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${student.id}</td>
            <td>${student.barcode}</td>
            <td class="student-name" onclick="openEditModal('${student.id}')">${student.studentName}</td>
            <td>${student.className}</td>
            <td>${formatGrade(student.attendance1)}</td>
            <td>${formatGrade(student.oral1)}</td>
            <td>${formatGrade(student.homework1)}</td>
            <td>${formatGrade(student.written1)}</td>
            <td>${total1}</td>
            <td class="${getResultClass(result1)}">${result1}</td>
            <td><button class="edit-btn" onclick="openEditModal('${student.id}')">ØªØ¹Ø¯ÙŠÙ„</button></td>
        `;
        tbody.appendChild(row);
    });
    
    const studentsCount1 = document.getElementById('studentsCount1');
    if (studentsCount1) studentsCount1.textContent = students.length;
}

function renderMonth2Table(students = allStudents) {
    const tbody = document.getElementById('month2TableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (students.length === 0) {
        tbody.innerHTML = `<tr><td colspan="11" style="text-align: center; color: #e74c3c; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„ØªØ±Ø©.</td></tr>`;
        return;
    }
    
    students.forEach(student => {
        const total2 = calculateTotal(student, 2);
        const result2 = calculateResult(total2);

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${student.id}</td>
            <td>${student.barcode}</td>
            <td class="student-name" onclick="openEditModal('${student.id}')">${student.studentName}</td>
            <td>${student.className}</td>
            <td>${formatGrade(student.attendance2)}</td>
            <td>${formatGrade(student.oral2)}</td>
            <td>${formatGrade(student.homework2)}</td>
            <td>${formatGrade(student.written2)}</td>
            <td>${total2}</td>
            <td class="${getResultClass(result2)}">${result2}</td>
            <td><button class="edit-btn" onclick="openEditModal('${student.id}')">ØªØ¹Ø¯ÙŠÙ„</button></td>
        `;
        tbody.appendChild(row);
    });
    
    const studentsCount2 = document.getElementById('studentsCount2');
    if (studentsCount2) studentsCount2.textContent = students.length;
}

function renderMonth3Table(students = allStudents) {
    const tbody = document.getElementById('month3TableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (students.length === 0) {
        tbody.innerHTML = `<tr><td colspan="11" style="text-align: center; color: #e74c3c; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„ØªØ±Ø©.</td></tr>`;
        return;
    }
    
    students.forEach(student => {
        const total3 = calculateTotal(student, 3);
        const result3 = calculateResult(total3);

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${student.id}</td>
            <td>${student.barcode}</td>
            <td class="student-name" onclick="openEditModal('${student.id}')">${student.studentName}</td>
            <td>${student.className}</td>
            <td>${formatGrade(student.attendance3)}</td>
            <td>${formatGrade(student.homework3)}</td>
            <td>${formatGrade(student.oral3)}</td>
            <td>${formatGrade(student.written3)}</td>
            <td>${total3}</td>
            <td class="${getResultClass(result3)}">${result3}</td>
            <td><button class="edit-btn" onclick="openEditModal('${student.id}')">ØªØ¹Ø¯ÙŠÙ„</button></td>
        `;
        tbody.appendChild(row);
    });
    
    const studentsCount3 = document.getElementById('studentsCount3');
    if (studentsCount3) studentsCount3.textContent = students.length;
}

function renderAllMonthsTable(students = allStudents) {
    const tbody = document.getElementById('studentsTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (students.length === 0) {
        tbody.innerHTML = `<tr><td colspan="23" style="text-align: center; color: #e74c3c; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„ØªØ±Ø©.</td></tr>`;
        return;
    }
    
    students.forEach(student => {
        const total1 = calculateTotal(student, 1);
        const result1 = calculateResult(total1);
        const total2 = calculateTotal(student, 2);
        const result2 = calculateResult(total2);
        const total3 = calculateTotal(student, 3);
        const result3 = calculateResult(total3);

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${student.id}</td>
            <td>${student.barcode}</td>
            <td class="student-name" onclick="openEditModal('${student.id}')">${student.studentName}</td>
            <td>${student.className}</td>
            <td>${formatGrade(student.attendance1)}</td>
            <td>${formatGrade(student.oral1)}</td>
            <td>${formatGrade(student.homework1)}</td>
            <td>${formatGrade(student.written1)}</td>
            <td>${total1}</td>
            <td class="${getResultClass(result1)}">${result1}</td>
            <td>${formatGrade(student.attendance2)}</td>
            <td>${formatGrade(student.oral2)}</td>
            <td>${formatGrade(student.homework2)}</td>
            <td>${formatGrade(student.written2)}</td>
            <td>${total2}</td>
            <td class="${getResultClass(result2)}">${result2}</td>
            <td>${formatGrade(student.attendance3)}</td>
            <td>${formatGrade(student.homework3)}</td>
            <td>${formatGrade(student.oral3)}</td>
            <td>${formatGrade(student.written3)}</td>
            <td>${total3}</td>
            <td class="${getResultClass(result3)}">${result3}</td>
            <td><button class="edit-btn" onclick="openEditModal('${student.id}')">ØªØ¹Ø¯ÙŠÙ„</button></td>
        `;
        tbody.appendChild(row);
    });
    
    const studentsCountAll = document.getElementById('studentsCountAll');
    if (studentsCountAll) studentsCountAll.textContent = students.length;
}

// ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ ==========
async function fetchDataFromSheet(teacherId, showLoadingScreen = true) {
    if (showLoadingScreen) showLoading(true, 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets...');
    
    try {
        const response = await fetch(WEB_APP_URL);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();

        if (data.status === 'success' && data.data) {
            const mappedData = mapData(data.data);
            
            allStudents = mappedData.filter(student => student.teacherId === teacherId);
            
            currentTeacherId = teacherId;
            if (welcomeTeacherName) welcomeTeacherName.textContent = teacherId;
            
            populateClassFilters(); 
            
            if (showLoadingScreen) {
                showLoading(false);
                if (loginSection) loginSection.classList.add('hidden');
                if (monthSelectionSection) monthSelectionSection.classList.remove('hidden');
                showSuccess(`Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${teacherId}! ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.`);
            }

            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
            const backupBtn = document.getElementById('manualBackupBtn');
            if (backupBtn && allStudents.length > 0) {
                backupBtn.style.display = 'block';
            }

            return true;
        } else {
            throw new Error(data.error || 'ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheet.');
        }

    } catch (error) {
        if (showLoadingScreen) showError('âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
        return false;
    }
}

async function login(useLocal = false) {
    const teacherId = teacherIdInput.value.trim();
    if (!teacherId) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¹Ù„Ù….');
        return;
    }

    let success = false;
    
    if (useLocal) {
        try {
            const localData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (localData) {
                const parsedData = JSON.parse(localData);
                const filteredStudents = parsedData.students ? 
                    parsedData.students.filter(s => s.teacherId === teacherId) : [];

                if (filteredStudents.length > 0) {
                    allStudents = filteredStudents;
                    currentTeacherId = teacherId;
                    if (welcomeTeacherName) welcomeTeacherName.textContent = teacherId;
                    
                    saveTeacherSession(teacherId);
                    
                    populateClassFilters(); 
                    
                    if (loginSection) loginSection.classList.add('hidden');
                    if (monthSelectionSection) monthSelectionSection.classList.remove('hidden');
                    showSuccess(`ğŸ’¾ ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ø§Ù„Ù…Ø¹Ù„Ù…: ${teacherId}).`);
                    success = true;
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                    const backupBtn = document.getElementById('manualBackupBtn');
                    if (backupBtn && allStudents.length > 0) {
                        backupBtn.style.display = 'block';
                    }
                } else {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¨Ù‚Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ù.');
                }
            } else {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¨Ù‚Ø© Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚.');
            }
        } catch (error) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©: ' + error.message);
        }

    } else {
        success = await fetchDataFromSheet(teacherId);
        if (success) {
            saveTeacherSession(teacherId);
        }
    }

    return success;
}

async function initializeData() {
    const url = `${WEB_APP_URL}`;
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP Status: ${response.status}`);
        
        const data = await response.json();
        
        if (data.status === 'success') {
            enableLogin(true);
        } else {
            throw new Error(data.error || 'Apps Script returned an unknown error.');
        }
    } catch (error) {
        enableLogin(false);
        updateConnectionStatus(`âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets: ${error.message}.`, 'error');
    }
}

function enableLogin(enable = true) {
    if (loginBtn) loginBtn.disabled = !enable;
    if (enable) {
        updateConnectionStatus('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Google Sheets. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†.', 'success');
    }
}

function updateConnectionStatus(message, type = 'info') {
    if (!connectionStatus) return;
    
    const colors = {
        info: '#fff3cd',
        success: '#d4edda',
        error: '#f8d7da',
        warning: '#ffe0b2'
    };
    const borderColors = {
        info: '#ffeaa7',
        success: '#c3e6cb',
        error: '#f5c6cb',
        warning: '#ffc107'
    };

    connectionStatus.innerHTML = message;
    connectionStatus.style.background = colors[type] || colors.info;
    connectionStatus.style.border = `1px solid ${borderColors[type] || borderColors.info}`;
    connectionStatus.style.padding = '10px';
    connectionStatus.style.borderRadius = '5px';
    connectionStatus.style.margin = '10px 0';
}

// ========== Ø¯ÙˆØ§Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ==========
function openEditModal(studentId) {
    const targetId = studentId.toString().trim(); 
    const student = allStudents.find(s => s.id && s.id.toString().trim() === targetId);
    
    if (!student) {
        showError(`âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨. Ø§Ù„Ù€ ID Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: "${targetId}".`);
        return;
    }
    
    const currentStudentName = document.getElementById('currentStudentName');
    if (currentStudentName) currentStudentName.textContent = student.studentName;
    
    const editStudentId = document.getElementById('editStudentId');
    if (editStudentId) editStudentId.value = student.id;
    
    const currentEditMonth = document.getElementById('currentEditMonth');
    if (currentEditMonth) currentEditMonth.value = currentMonth;
    
    const monthNames = {
        1: 'Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ÙˆÙ„',
        2: 'Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ', 
        3: 'Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø«',
        'all': 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡ÙˆØ±'
    };
    
    const currentMonthIndicator = document.getElementById('currentMonthIndicator');
    if (currentMonthIndicator) currentMonthIndicator.textContent = monthNames[currentMonth];
    
    createEditFormContent(student, currentMonth);
    
    const editModal = document.getElementById('editModal');
    if (editModal) editModal.style.display = 'block';
}

function createEditFormContent(student, month) {
    const container = document.getElementById('editFormContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (month === 'all') {
        for (let i = 1; i <= 3; i++) {
            container.appendChild(createMonthSection(student, i));
        }
    } else {
        container.appendChild(createMonthSection(student, month));
    }
}

function createMonthSection(student, month) {
    const section = document.createElement('div');
    section.className = 'month-section';
    
    const monthNames = {
        1: 'ğŸ“˜ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ÙˆÙ„',
        2: 'ğŸ“— Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ',
        3: 'ğŸ“™ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø«'
    };
    
    const fields = {
        1: ['attendance1', 'oral1', 'homework1', 'written1'],
        2: ['attendance2', 'oral2', 'homework2', 'written2'],
        3: ['attendance3', 'homework3', 'oral3', 'written3']
    };
    
    const fieldLabels = {
        'attendance1': 'Ù…ÙˆØ§Ø¸Ø¨Ø© 1', 'oral1': 'Ø´ÙÙ‡ÙŠ 1', 'homework1': 'ÙˆØ§Ø¬Ø¨Ø§Øª 1', 'written1': 'ØªØ­Ø±ÙŠØ±ÙŠ 1',
        'attendance2': 'Ù…ÙˆØ§Ø¸Ø¨Ø© 2', 'oral2': 'Ø´ÙÙ‡ÙŠ 2', 'homework2': 'ÙˆØ§Ø¬Ø¨Ø§Øª 2', 'written2': 'ØªØ­Ø±ÙŠØ±ÙŠ 2',
        'attendance3': 'Ù…ÙˆØ§Ø¸Ø¨Ø© 3', 'homework3': 'ÙˆØ§Ø¬Ø¨Ø§Øª 3', 'oral3': 'Ø´ÙÙ‡ÙŠ 3', 'written3': 'ØªØ­Ø±ÙŠØ±ÙŠ 3'
    };
    
    section.innerHTML = `
        <div class="month-title">${monthNames[month]}</div>
        <div class="scores-grid">
            ${fields[month].map(field => `
                <div class="score-group">
                    <label for="edit${field}">${fieldLabels[field]}:</label>
                    <input type="number" id="edit${field}" min="0" max="5" step="0.1" 
                           value="${formatGrade(student[field])}" 
                           oninput="calculateMonthTotal(${month})">
                </div>
            `).join('')}
            <div class="total-display">
                <span class="label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: </span>
                <span class="value" id="totalDisplay${month}">${calculateTotal(student, month)}</span>
            </div>
            <div class="result-display">
                <span class="label">Ø§Ù„Ù…Ø­ØµÙ„Ø©: </span>
                <span class="value" id="resultDisplay${month}">${calculateResult(calculateTotal(student, month))}</span>
            </div>
        </div>
    `;
    
    return section;
}

function saveAllEdits() {
    const studentId = document.getElementById('editStudentId')?.value;
    const currentMonth = document.getElementById('currentEditMonth')?.value;
    
    if (!studentId) {
        showError('âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ø§Ù„Ø¨');
        return;
    }
    
    const idToFind = studentId.toString().trim(); 
    const student = allStudents.find(s => s.id && s.id.toString().trim() === idToFind);

    if (!student) {
        showError('âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ø­ÙØ¸. (ID: ' + idToFind + ')');
        return;
    }

    const updateData = {
        row: student.originalRowIndex, 
        id: student.id,
    };

    let changesMade = false;

    let fieldsToCheck = [];
    if (currentMonth === 'all') {
        fieldsToCheck = [
            'attendance1', 'oral1', 'homework1', 'written1',
            'attendance2', 'oral2', 'homework2', 'written2', 
            'attendance3', 'homework3', 'oral3', 'written3'
        ];
    } else {
        const monthFields = {
            1: ['attendance1', 'oral1', 'homework1', 'written1'],
            2: ['attendance2', 'oral2', 'homework2', 'written2'],
            3: ['attendance3', 'homework3', 'oral3', 'written3']
        };
        fieldsToCheck = monthFields[currentMonth];
    }

    fieldsToCheck.forEach(field => {
        const inputElement = document.getElementById(`edit${field}`);
        if (inputElement) {
            const oldValue = student[field]; 
            const newValue = inputElement.value;
            
            const newFormatted = newValue.toString().trim();
            const oldFormatted = oldValue ? oldValue.toString().trim() : '';
            
            if (oldFormatted !== newFormatted) {
                student[field] = newFormatted;
                updateData[field] = newFormatted; 
                changesMade = true;
            }
        }
    });

    for(let i = 1; i <= 3; i++) {
        student[`total${i}`] = calculateTotal(student, i);
        student[`result${i}`] = calculateResult(student[`total${i}`]);
    }

    if (changesMade) {
        pendingUpdates = pendingUpdates.filter(update => update.id !== student.id);
        pendingUpdates.push(updateData);
        
        savePendingUpdates();
        saveDataToLocalStorage();
        
        updateDisplayedStudents(); 
        
        closeModal('editModal');
        showSuccess('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ù„Ø·Ø§Ù„Ø¨ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©.');
        
        attemptAutoSync();
    } else {
        closeModal('editModal');
        showSuccess('ğŸ‘ Ù„Ù… ÙŠØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­ÙØ¸Ù‡Ø§.');
    }
}

// ========== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ù‡ÙˆØ± ==========
function selectMonth(month) {
    currentMonth = month;
    
    document.querySelectorAll('.month-workspace').forEach(workspace => {
        workspace.classList.remove('active');
    });
    
    const workspaceId = month === 'all' ? 'allMonthsWorkspace' : `month${month}Workspace`;
    const workspaceElement = document.getElementById(workspaceId);
    if (workspaceElement) {
        workspaceElement.classList.add('active');
    }
    
    if (monthSelectionSection) monthSelectionSection.classList.add('hidden');
    
    document.querySelectorAll('#currentTeacher1, #currentTeacher2, #currentTeacher3, #currentTeacherAll').forEach(element => {
        element.textContent = currentTeacherId;
    });
    
    updateDisplayedStudents();
    
    console.log(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø±: ${month}`);
}

function backToMonthSelection() {
    document.querySelectorAll('.month-workspace').forEach(workspace => {
        workspace.classList.remove('active');
    });
    
    if (monthSelectionSection) monthSelectionSection.classList.remove('hidden');
}

// ========== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙˆØ§ÙØ° ==========
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        if (modalId === 'qrModal') {
            stopQRScanner();
        }
    }
}

// ========== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø­ QR Code ==========
async function startQRScanner(month) {
    console.log(`Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­ Ù„Ù„Ø´Ù‡Ø±: ${month}`);
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment" } 
        });
        
        qrStream = stream;
        const videoElement = document.createElement('video');
        const canvasElement = document.createElement('canvas');
        const canvas = canvasElement.getContext('2d');
        
        const scannerContainer = document.getElementById('qrScanner');
        if (!scannerContainer) return;
        
        scannerContainer.innerHTML = '';
        scannerContainer.appendChild(videoElement);
        
        videoElement.srcObject = stream;
        videoElement.setAttribute("playsinline", true);
        videoElement.play();
        
        const qrModal = document.getElementById('qrModal');
        if (qrModal) qrModal.style.display = 'block';
        
        const qrResult = document.getElementById('qrResult');
        if (qrResult) qrResult.classList.add('hidden');
        
        function scanFrame() {
            if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                canvasElement.height = videoElement.videoHeight;
                canvasElement.width = videoElement.videoWidth;
                canvas.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (code) {
                    console.log('ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯:', code.data);
                    handleScannedBarcode(code.data, month);
                }
            }
            
            if (qrScanner !== null) {
                requestAnimationFrame(scanFrame);
            }
        }
        
        qrScanner = true;
        requestAnimationFrame(scanFrame);
        
    } catch (err) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', err);
        showError('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù†.');
    }
}

function handleScannedBarcode(barcode, month) {
    console.log('Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:', barcode);
    
    const student = allStudents.find(s => {
        const cleanBarcode = s.barcode ? s.barcode.toString().trim().replace(/\s+/g, '') : '';
        const scannedBarcode = barcode.toString().trim().replace(/\s+/g, '');
        return cleanBarcode === scannedBarcode;
    });
    
    const resultDiv = document.getElementById('qrResult');
    const resultText = document.getElementById('qrResultText');
    
    if (!resultDiv || !resultText) return;
    
    if (student) {
        resultText.textContent = `âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.studentName} (${student.barcode})`;
        resultDiv.className = 'qr-result success';
        stopQRScanner();
        closeModal('qrModal');
        
        setTimeout(() => {
            openEditModal(student.id);
        }, 1000);
    } else {
        resultText.textContent = `âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ø§Ù„Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${barcode}`;
        resultDiv.className = 'qr-result error';
    }
    
    resultDiv.classList.remove('hidden');
}

function stopQRScanner() {
    if (qrStream) {
        qrStream.getTracks().forEach(track => track.stop());
        qrStream = null;
    }
    qrScanner = null;
    
    const scannerContainer = document.getElementById('qrScanner');
    if (scannerContainer) {
        scannerContainer.innerHTML = '<span>Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</span>';
    }
}

// ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ==========
function showStatistics(month) {
    console.log(`Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø±: ${month}`);
    
    const statsTeacherId = document.getElementById('statsTeacherId');
    if (statsTeacherId) statsTeacherId.textContent = currentTeacherId;
    
    calculateAllStatistics();
    
    const modal = document.getElementById('statsModal');
    if (modal) modal.style.display = 'block';
}

function calculateAllStatistics() {
    const searchTerm = document.getElementById(`searchNameInput${currentMonth}`)?.value.trim().toLowerCase() || '';
    const selectedClass = document.getElementById(`classNameFilter${currentMonth}`)?.value || '';

    const filteredStudents = allStudents.filter(student => {
        const studentName = student.studentName ? student.studentName.toLowerCase() : '';
        const matchesName = searchTerm === '' || studentName.includes(searchTerm);
        const matchesClass = selectedClass === '' || student.className === selectedClass;
        return matchesName && matchesClass;
    });

    const totalStudentsCount = document.getElementById('totalStudentsCount');
    if (totalStudentsCount) totalStudentsCount.textContent = filteredStudents.length;
    
    calculateMonthStatistics(filteredStudents, 1);
    calculateMonthStatistics(filteredStudents, 2);
    calculateMonthStatistics(filteredStudents, 3);
    calculateOverallStatistics(filteredStudents);
}

function calculateMonthStatistics(students, month) {
    const ranges = {
        less5: 0,
        from5to10: 0,
        from11to15: 0,
        from16to20: 0
    };
    
    students.forEach(student => {
        const total = parseFloat(student[`total${month}`]) || 0;
        
        if (total < 5) ranges.less5++;
        else if (total >= 5 && total <= 10) ranges.from5to10++;
        else if (total >= 11 && total <= 15) ranges.from11to15++;
        else if (total >= 16 && total <= 20) ranges.from16to20++;
    });
    
    const less5Element = document.getElementById(`statsMonth${month}Less5`);
    const from5to10Element = document.getElementById(`statsMonth${month}5to10`);
    const from11to15Element = document.getElementById(`statsMonth${month}11to15`);
    const from16to20Element = document.getElementById(`statsMonth${month}16to20`);
    
    if (less5Element) less5Element.textContent = ranges.less5;
    if (from5to10Element) from5to10Element.textContent = ranges.from5to10;
    if (from11to15Element) from11to15Element.textContent = ranges.from11to15;
    if (from16to20Element) from16to20Element.textContent = ranges.from16to20;
}

function calculateOverallStatistics(students) {
    const ranges = {
        less5: 0,
        from5to10: 0, 
        from11to15: 0,
        from16to20: 0
    };
    
    students.forEach(student => {
        const total1 = parseFloat(student.total1) || 0;
        const total2 = parseFloat(student.total2) || 0;
        const total3 = parseFloat(student.total3) || 0;
        
        const overallAverage = (total1 + total2 + total3) / 3;
        
        if (overallAverage < 5) ranges.less5++;
        else if (overallAverage >= 5 && overallAverage <= 10) ranges.from5to10++;
        else if (overallAverage >= 11 && overallAverage <= 15) ranges.from11to15++;
        else if (overallAverage >= 16 && overallAverage <= 20) ranges.from16to20++;
    });
    
    const less5Element = document.getElementById('statsOverallLess5');
    const from5to10Element = document.getElementById('statsOverall5to10');
    const from11to15Element = document.getElementById('statsOverall11to15');
    const from16to20Element = document.getElementById('statsOverall16to20');
    
    if (less5Element) less5Element.textContent = ranges.less5;
    if (from5to10Element) from5to10Element.textContent = ranges.from5to10;
    if (from11to15Element) from11to15Element.textContent = ranges.from11to15;
    if (from16to20Element) from16to20Element.textContent = ranges.from16to20;
}

function openStatsTab(tabName) {
    document.querySelectorAll('.stats-tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    document.querySelectorAll('.stats-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    const tabContent = document.getElementById(`${tabName}Stats`);
    if (tabContent) tabContent.classList.add('active');
    
    const tabButton = document.querySelector(`.stats-tab[onclick*="${tabName}"]`);
    if (tabButton) tabButton.classList.add('active');
}

// ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ==========
function alertWithHTML(title, htmlContent) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-modal" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <h3>${title}</h3>
            ${htmlContent}
        </div>
    `;
    document.body.appendChild(modal);
}

function handleLogout() {
    if (pendingUpdates.length > 0) {
        savePendingUpdates();
        saveDataToLocalStorage();
    }
    
    clearTeacherSession();
    
    if (loginSection) loginSection.classList.remove('hidden');
    if (monthSelectionSection) monthSelectionSection.classList.add('hidden');
    
    document.querySelectorAll('.month-workspace').forEach(workspace => {
        workspace.classList.remove('active');
    });
    
    allStudents = [];
    
    if (teacherIdInput) teacherIdInput.value = '';
    
    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    const backupBtn = document.getElementById('manualBackupBtn');
    if (backupBtn) backupBtn.style.display = 'none';
    
    showSuccess('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­.');
}

// ========== Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© ==========
function addToSyncHistory(type, status, count, details = '') {
    const record = {
        timestamp: new Date().toISOString(),
        type,
        status,
        count,
        details,
        teacherId: currentTeacherId
    };
    
    syncHistory.unshift(record);
    
    if (syncHistory.length > 100) {
        syncHistory = syncHistory.slice(0, 100);
    }
    
    saveSyncHistory();
}

function showSyncHistory() {
    updateSyncHistoryUI();
    const modal = document.getElementById('syncHistoryModal');
    if (modal) modal.style.display = 'block';
}

function updateSyncHistoryUI() {
    const tbody = document.getElementById('syncHistoryBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (syncHistory.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; color: #666; padding: 20px;">
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø²Ø§Ù…Ù†Ø©
                </td>
            </tr>
        `;
        return;
    }
    
    syncHistory.slice(0, 50).forEach(record => {
        const row = document.createElement('tr');
        
        let statusBadge = '';
        if (record.status === 'success') {
            statusBadge = '<span class="badge badge-success">âœ… Ù†Ø§Ø¬Ø­</span>';
        } else if (record.status === 'partial') {
            statusBadge = '<span class="badge badge-warning">âš ï¸ Ø¬Ø²Ø¦ÙŠ</span>';
        } else {
            statusBadge = '<span class="badge badge-danger">âŒ ÙØ´Ù„</span>';
        }
        
        row.innerHTML = `
            <td>${new Date(record.timestamp).toLocaleString('ar-SA')}</td>
            <td>${record.type || 'Ù…Ø²Ø§Ù…Ù†Ø©'}</td>
            <td>${record.count || 0}</td>
            <td>${statusBadge}</td>
            <td>${record.details || ''}</td>
        `;
        tbody.appendChild(row);
    });
}

function clearSyncHistory() {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')) {
        syncHistory = [];
        saveSyncHistory();
        updateSyncHistoryUI();
        showSuccess('ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø§Øª');
    }
}

// ========== Ø¯ÙˆØ§Ù„ PWA ==========
async function installPWA() {
    if (!window.deferredPrompt) {
        console.log('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ prompt Ù„Ù„ØªØ«Ø¨ÙŠØª');
        return;
    }

    console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ«Ø¨ÙŠØª...');
    
    try {
        window.deferredPrompt.prompt();
        const { outcome } = await window.deferredPrompt.userChoice;
        console.log(`Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª: ${outcome}`);
        
        if (outcome === 'accepted') {
            console.log('âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
            showSuccess('âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!');
        } else {
            console.log('âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„ØªØ«Ø¨ÙŠØª');
        }
    } catch (error) {
        console.log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ«Ø¨ÙŠØª:', error);
    }
    
    window.deferredPrompt = null;
    hideInstallButton();
}

function showInstallButton() {
    if (installBtn) {
        installBtn.style.display = 'block';
        console.log('ğŸ‘† Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª Ù…Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø¢Ù†');
    }
}

function hideInstallButton() {
    if (installBtn) {
        installBtn.style.display = 'none';
        console.log('âŒ Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª Ù…Ø®ÙÙŠ Ø§Ù„Ø¢Ù†');
    }
}

// ========== ØªØ­Ø³ÙŠÙ† Ø¯ÙˆØ±Ø© Ø­ÙŠØ§Ø© Ø§Ù„ØµÙØ­Ø© ==========
window.addEventListener('beforeunload', () => {
    if (pendingUpdates.length > 0) {
        savePendingUpdates();
        saveDataToLocalStorage();
        return 'Ù‡Ù†Ø§Ùƒ ØªØ¹Ø¯ÙŠÙ„Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ù‚Ø§Ù‹ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©ØŸ';
    }
});

// ========== ØªÙ‡ÙŠØ¦Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ==========
document.addEventListener('DOMContentLoaded', () => {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©
    setTimeout(() => {
        // ØªØ­Ù…ÙŠÙ„ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©
        const backupBtn = document.getElementById('manualBackupBtn');
        if (backupBtn && allStudents.length > 0) {
            backupBtn.style.display = 'block';
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        updateAutoSyncStatus();
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨
        updateDisplayedStudents();
    }, 1000);
});

    // ========== Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©) ==========
    // ... (Ø£Ø¶Ù Ù‡Ù†Ø§ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙŠ Ø°ÙƒØ±ØªÙ‡Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    // Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ: mapData, formatGrade, calculateTotal, calculateResult, 
    // populateClassFilters, updateDisplayedStudents, renderMonth1Table, 
    // renderMonth2Table, renderMonth3Table, renderAllMonthsTable,
    // fetchDataFromSheet, login, initializeData, openEditModal, 
    // createEditFormContent, saveAllEdits, handleLogout, etc.

    // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ¬Ø¨ Ø£Ù† ØªØ¶Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
    // Ø¥Ø°Ø§ ÙƒÙ†Øª Ø¨Ø­Ø§Ø¬Ø© Ù„Ø£ÙŠ Ù…Ù†Ù‡Ø§ØŒ Ø£Ø®Ø¨Ø±Ù†ÙŠ ÙˆØ³Ø£Ø¶ÙŠÙÙ‡Ø§
// ========== Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ù…Ø­Ø³Ù‘Ù† ==========

// Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
let backupButton = null;

function initializeBackupSystem() {
    console.log('ğŸ’¾ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ...');
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    createBackupButton();
    
    // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¹Ù„Ù…
    addBackupManagementButton();
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
    setTimeout(updateBackupList, 1000);
}

function createBackupButton() {
    // Ø­Ø°Ù Ø§Ù„Ø²Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    const existingBtn = document.getElementById('manualBackupBtn');
    if (existingBtn) existingBtn.remove();
    
    backupButton = document.createElement('button');
    backupButton.id = 'manualBackupBtn';
    backupButton.innerHTML = 'ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ';
    backupButton.title = 'Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    
    backupButton.addEventListener('click', function() {
        showBackupModal();
    });
    
    backupButton.addEventListener('mouseenter', function() {
        backupButton.style.transform = 'translateY(-2px)';
        backupButton.style.boxShadow = '0 6px 18px rgba(0,0,0,0.3)';
    });
    
    backupButton.addEventListener('mouseleave', function() {
        backupButton.style.transform = 'translateY(0)';
        backupButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
    });
    
    document.body.appendChild(backupButton);
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
    updateBackupButtonState();
}

function addBackupManagementButton() {
    // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® ÙÙŠ ÙƒÙ„ Ù‚Ø³Ù…
    for (let i = 1; i <= 3; i++) {
        const container = document.querySelector(`#month${i}Workspace .search-container`);
        if (container) {
            const existingBtn = container.querySelector('.backup-management-btn');
            if (!existingBtn) {
                const backupBtn = document.createElement('button');
                backupBtn.className = 'btn backup-management-btn';
                backupBtn.innerHTML = 'ğŸ’¾ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø®';
                backupBtn.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
                backupBtn.style.marginLeft = '10px';
                backupBtn.addEventListener('click', showBackupModal);
                container.appendChild(backupBtn);
            }
        }
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ÙÙŠ Ù‚Ø³Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡ÙˆØ±
    const allContainer = document.querySelector('#allMonthsWorkspace .search-container');
    if (allContainer) {
        const existingBtn = allContainer.querySelector('.backup-management-btn');
        if (!existingBtn) {
            const backupBtn = document.createElement('button');
            backupBtn.className = 'btn backup-management-btn';
            backupBtn.innerHTML = 'ğŸ’¾ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø®';
            backupBtn.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
            backupBtn.style.marginLeft = '10px';
            backupBtn.addEventListener('click', showBackupModal);
            allContainer.appendChild(backupBtn);
        }
    }
}

function updateBackupButtonState() {
    if (!backupButton) return;
    
    if (allStudents.length > 0 && currentTeacherId) {
        backupButton.style.display = 'block';
        backupButton.disabled = false;
        backupButton.title = `Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù€ ${allStudents.length} Ø·Ø§Ù„Ø¨`;
    } else {
        backupButton.style.display = 'none';
        backupButton.disabled = true;
        backupButton.title = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ';
    }
}

function showBackupModal() {
    updateBackupList();
    document.getElementById('backupModal').style.display = 'block';
    document.getElementById('backupInfo').style.display = 'none';
}

// ========== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ==========

function createManualBackup() {
    console.log('ğŸ”„ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ©...');
    
    if (!currentTeacherId || allStudents.length === 0) {
        showBackupMessage('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'error');
        return;
    }
    
    const success = backupUserData();
    
    if (success) {
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        showBackupMessage('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø®
        updateBackupList();
        
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        updateBackupButtonState();
        
        // Ø¥Ø¶Ø§ÙØ© ØµÙˆØª ØªØ£ÙƒÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        playBackupSound();
        
        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        setTimeout(() => {
            showBackupDetails();
        }, 500);
    } else {
        showBackupMessage('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
    }
}

function backupUserData() {
    try {
        console.log('ğŸ“¦ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ...');
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        const backupData = {
            timestamp: new Date().toISOString(),
            teacherId: currentTeacherId,
            studentCount: allStudents.length,
            pendingUpdates: pendingUpdates.length,
            failedUpdates: failedUpdates.length,
            syncHistoryCount: syncHistory.length,
            students: JSON.parse(JSON.stringify(allStudents)),
            pendingUpdates: JSON.parse(JSON.stringify(pendingUpdates)),
            failedUpdates: JSON.parse(JSON.stringify(failedUpdates)),
            syncHistory: JSON.parse(JSON.stringify(syncHistory))
        };
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯ Ù„Ù„Ù†Ø³Ø®Ø©
        const timestamp = Date.now();
        const backupKey = `grades_backup_${currentTeacherId}_${timestamp}`;
        
        // Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        localStorage.setItem(backupKey, JSON.stringify(backupData));
        
        console.log(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${backupKey}`);
        console.log(`ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø©: ${allStudents.length} Ø·Ø§Ù„Ø¨ØŒ ${pendingUpdates.length} ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„Ù‚`);
        
        // Ø­ÙØ¸ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø³Ø®
        saveBackupToHistory(backupKey, backupData);
        
        // ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        organizeBackups();
        
        return true;
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ:', error);
        return false;
    }
}

function saveBackupToHistory(backupKey, backupData) {
    try {
        const backupHistory = JSON.parse(localStorage.getItem('backup_history') || '[]');
        
        backupHistory.unshift({
            key: backupKey,
            timestamp: backupData.timestamp,
            teacherId: backupData.teacherId,
            studentCount: backupData.studentCount,
            size: JSON.stringify(backupData).length
        });
        
        // Ø­ÙØ¸ ÙÙ‚Ø· Ø¢Ø®Ø± 20 Ø³Ø¬Ù„
        if (backupHistory.length > 20) {
            backupHistory.pop();
        }
        
        localStorage.setItem('backup_history', JSON.stringify(backupHistory));
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø³Ø®:', error);
    }
}

function organizeBackups() {
    try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        const allKeys = Object.keys(localStorage);
        const backupKeys = allKeys.filter(key => key.startsWith('grades_backup_'));
        
        // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        const teacherBackups = backupKeys.filter(key => key.includes(currentTeacherId));
        
        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
        teacherBackups.sort((a, b) => {
            const timeA = parseInt(a.split('_').pop());
            const timeB = parseInt(b.split('_').pop());
            return timeB - timeA;
        });
        
        // Ø­ÙØ¸ ÙÙ‚Ø· Ø¢Ø®Ø± 5 Ù†Ø³Ø® Ù„ÙƒÙ„ Ù…Ø¹Ù„Ù…
        if (teacherBackups.length > 5) {
            const toDelete = teacherBackups.slice(5);
            toDelete.forEach(key => {
                localStorage.removeItem(key);
                console.log(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: ${key}`);
            });
        }
        
        console.log(`ğŸ“ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø³Ø® Ù„Ù„Ù…Ø¹Ù„Ù… ${currentTeacherId}: ${teacherBackups.length}`);
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù†Ø³Ø®:', error);
    }
}

// ========== Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ==========

function updateBackupList() {
    const container = document.getElementById('backupList');
    if (!container) return;
    
    try {
        const allKeys = Object.keys(localStorage);
        const backupKeys = allKeys.filter(key => key.startsWith('grades_backup_'));
        
        // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        const teacherBackups = currentTeacherId ? 
            backupKeys.filter(key => key.includes(currentTeacherId)) : 
            backupKeys;
        
        if (teacherBackups.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</p>';
            return;
        }
        
        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
        teacherBackups.sort((a, b) => {
            const timeA = parseInt(a.split('_').pop()) || 0;
            const timeB = parseInt(b.split('_').pop()) || 0;
            return timeB - timeA;
        });
        
        let html = '';
        
        teacherBackups.forEach((key, index) => {
            try {
                const backupData = JSON.parse(localStorage.getItem(key));
                if (!backupData) return;
                
                const date = new Date(backupData.timestamp);
                const timeStr = date.toLocaleString('ar-SA');
                
                html += `
                    <div class="backup-item">
                        <div class="backup-info">
                            <strong>Ù†Ø³Ø®Ø© ${index + 1}</strong>
                            <div style="font-size: 12px; color: #666;">
                                ${timeStr}
                            </div>
                            <div style="font-size: 11px; color: #888;">
                                ${backupData.studentCount || 0} Ø·Ø§Ù„Ø¨ | 
                                ${backupData.pendingUpdates || 0} ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„Ù‚
                            </div>
                        </div>
                        <div class="backup-actions">
                            <button class="btn" style="padding: 5px 10px; font-size: 12px;" 
                                    onclick="restoreBackup('${key}')" title="Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©">
                                â†©ï¸
                            </button>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #e74c3c;" 
                                    onclick="deleteBackup('${key}')" title="Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ø³Ø®Ø© ${key}:`, error);
            }
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø®:', error);
        container.innerHTML = '<p style="text-align: center; color: #e74c3c;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</p>';
    }
}

function restoreBackup(backupKey) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
        return;
    }
    
    console.log(`ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø©: ${backupKey}`);
    
    try {
        const backupData = JSON.parse(localStorage.getItem(backupKey));
        
        if (!backupData) {
            showBackupMessage('âŒ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
            return;
        }
        
        if (backupData.teacherId !== currentTeacherId) {
            showBackupMessage('âŒ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© ØªÙ†ØªÙ…ÙŠ Ù„Ù…Ø¹Ù„Ù… Ø¢Ø®Ø±', 'error');
            return;
        }
        
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        allStudents = backupData.students || [];
        pendingUpdates = backupData.pendingUpdates || [];
        failedUpdates = backupData.failedUpdates || [];
        syncHistory = backupData.syncHistory || [];
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯Ø©
        saveDataToLocalStorage();
        savePendingUpdates();
        saveFailedUpdates();
        saveSyncHistory();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        populateClassFilters();
        updateDisplayedStudents();
        updatePendingCount();
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        showBackupMessage(`âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© ${allStudents.length} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø®
        updateBackupList();
        
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        updateBackupButtonState();
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø©:', error);
        showBackupMessage('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø©', 'error');
    }
}

function restoreLatestBackup() {
    const allKeys = Object.keys(localStorage);
    const backupKeys = allKeys.filter(key => 
        key.startsWith('grades_backup_') && key.includes(currentTeacherId)
    );
    
    if (backupKeys.length === 0) {
        showBackupMessage('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
        return;
    }
    
    // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø©
    backupKeys.sort((a, b) => {
        const timeA = parseInt(a.split('_').pop()) || 0;
        const timeB = parseInt(b.split('_').pop()) || 0;
        return timeB - timeA;
    });
    
    const latestBackup = backupKeys[0];
    restoreBackup(latestBackup);
}

function deleteBackup(backupKey) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
        return;
    }
    
    try {
        localStorage.removeItem(backupKey);
        console.log(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø©: ${backupKey}`);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        updateBackupList();
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        showBackupMessage('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'success');
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø©:', error);
        showBackupMessage('âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø©', 'error');
    }
}

// ========== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ==========

function showBackupMessage(message, type = 'info') {
    const statusDiv = document.getElementById('backupStatus');
    if (!statusDiv) return;
    
    const colors = {
        success: '#d4edda',
        error: '#f8d7da',
        info: '#d1ecf1'
    };
    
    const borderColors = {
        success: '#c3e6cb',
        error: '#f5c6cb',
        info: '#bee5eb'
    };
    
    const textColors = {
        success: '#155724',
        error: '#721c24',
        info: '#0c5460'
    };
    
    statusDiv.innerHTML = message;
    statusDiv.style.background = colors[type] || colors.info;
    statusDiv.style.border = `1px solid ${borderColors[type] || borderColors.info}`;
    statusDiv.style.color = textColors[type] || textColors.info;
    statusDiv.style.padding = '10px';
    statusDiv.style.borderRadius = '5px';
    statusDiv.style.textAlign = 'center';
    statusDiv.style.fontWeight = 'bold';
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
    if (type !== 'error') {
        setTimeout(() => {
            statusDiv.innerHTML = '';
            statusDiv.style.background = 'transparent';
            statusDiv.style.border = 'none';
            statusDiv.style.padding = '0';
        }, 5000);
    }
}

function showBackupDetails() {
    const allKeys = Object.keys(localStorage);
    const backupKeys = allKeys.filter(key => 
        key.startsWith('grades_backup_') && key.includes(currentTeacherId)
    );
    
    const infoDiv = document.getElementById('backupInfo');
    const statsDiv = document.getElementById('backupStats');
    
    if (!infoDiv || !statsDiv) return;
    
    let totalSize = 0;
    let backupDetails = [];
    
    backupKeys.forEach(key => {
        try {
            const backupData = localStorage.getItem(key);
            if (backupData) {
                const size = backupData.length;
                totalSize += size;
                
                const parsedData = JSON.parse(backupData);
                backupDetails.push({
                    key,
                    timestamp: parsedData.timestamp,
                    studentCount: parsedData.studentCount || 0,
                    size: size
                });
            }
        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© ${key}:`, error);
        }
    });
    
    const sizeMB = (totalSize / 1024 / 1024).toFixed(2);
    
    statsDiv.innerHTML = `
        <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: <strong>${backupKeys.length}</strong></p>
        <p>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong>${sizeMB} Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª</strong></p>
        <p>Ø§Ù„Ù…Ø¹Ù„Ù…: <strong>${currentTeacherId}</strong></p>
        <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong>${allStudents.length}</strong></p>
        ${backupDetails.length > 0 ? `
            <p>Ø¢Ø®Ø± Ù†Ø³Ø®Ø©: ${new Date(backupDetails[0].timestamp).toLocaleString('ar-SA')}</p>
        ` : ''}
    `;
    
    infoDiv.style.display = 'block';
}

function showBackupInfo() {
    const infoDiv = document.getElementById('backupInfo');
    if (infoDiv.style.display === 'block') {
        infoDiv.style.display = 'none';
    } else {
        showBackupDetails();
    }
}

function playBackupSound() {
    try {
        // ØµÙˆØª ØªØ£ÙƒÙŠØ¯ Ø¨Ø³ÙŠØ·
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(1200, audioContext.currentTime + 0.1);
        
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
        
    } catch (error) {
        console.log('â„¹ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', error);
    }
}

// ========== Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ==========

function setupAutoBackup() {
    // Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©
    setInterval(() => {
        if (allStudents.length > 0 && currentTeacherId) {
            console.log('ğŸ”„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ...');
            backupUserData();
        }
    }, 30 * 60 * 1000); // 30 Ø¯Ù‚ÙŠÙ‚Ø©
    
    // Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
    let lastPendingCount = pendingUpdates.length;
    
    setInterval(() => {
        if (pendingUpdates.length > lastPendingCount) {
            console.log('ğŸ”„ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©...');
            backupUserData();
            lastPendingCount = pendingUpdates.length;
        }
    }, 10000); // ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù
}

// ========== Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø© ==========

window.addEventListener('beforeunload', () => {
    if (allStudents.length > 0 && currentTeacherId) {
        console.log('ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù‚Ø¨Ù„ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©...');
        backupUserData();
    }
});

// ========== ØªØ­Ø¯ÙŠØ« ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ==========

// ÙÙŠ Ø¯Ø§Ù„Ø© document.addEventListener('DOMContentLoaded', () => {
// Ø£Ø¶Ù Ù‡Ø°Ø§:
function initializeApp() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø£ÙˆÙ„Ø§Ù‹
    createBackupButton();
    
    // ØªÙ‡ÙŠØ¦Ø© Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    try {
        localStorage.setItem('storage_test', 'test');
        localStorage.removeItem('storage_test');
        console.log('âœ… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
    } catch (e) {
        console.error('âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ:', e);
        showError('âš ï¸ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ØºÙŠØ± Ù…ØªÙˆÙØ±. Ù‚Ø¯ Ù„Ø§ ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
    }
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const sessionRestored = initializeSession();
    
    // ØªÙ‡ÙŠØ¦Ø© PWA
    initializePWA();
    
    // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    initializeBackupSystem();
    
    // ØªÙ‡ÙŠØ¦Ø© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©
    initializeMonthSystem();
    initializeQRScanner();
    initializeStatistics();
    initializeSyncManagement();
    
    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ø§Ù…Ø©
    setupGlobalEvents();
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
    loadInitialData();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    setupAutoBackup();
    
    console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
    updateDebugInfo('âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù
    setTimeout(() => {
        updateBackupButtonState();
        updateBackupList();
    }, 3000);
}

// Ø§Ø³ØªØ¨Ø¯Ù„ document.addEventListener Ø¨Ø¯Ø§Ù„Ø© initializeApp
document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ -->
<div id="backupModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('backupModal')">&times;</span>
        <h3>ğŸ’¾ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</h3>
        
        <div id="backupStatus" style="margin: 15px 0; padding: 10px; border-radius: 8px;"></div>
        
        <button class="btn btn-success" onclick="createManualBackup()" style="width: 100%; margin-bottom: 15px;">
            ğŸ“¥ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
        </button>
        
        <div class="backup-list" id="backupList">
            <p style="text-align: center; color: #666;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©...</p>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn btn-warning" onclick="restoreLatestBackup()" style="flex: 1;">
                â†©ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¢Ø®Ø± Ù†Ø³Ø®Ø©
            </button>
            <button class="btn" onclick="showBackupInfo()" style="flex: 1; background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø®
            </button>
        </div>
        
        <div id="backupInfo" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; display: none;">
            <h4>ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:</h4>
            <div id="backupStats"></div>
        </div>
    </div>
</div>
</body>
</html>