<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ - Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .section {
            padding: 25px;
            display: block;
        }
        
        .hidden {
            display: none !important;
        }
        
        .login-form {
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn-logout {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .btn-test {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        .teacher-info {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-right: 5px solid #3498db;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 10px;
            text-align: right;
            font-weight: 600;
            font-size: 14px;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #ecf0f1;
            text-align: right;
            font-size: 14px;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        
        .result-cell {
            font-weight: bold;
            text-align: center;
            font-size: 13px;
            padding: 8px 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        .result-excellent {
            color: #27ae60;
            background-color: rgba(39, 174, 96, 0.1);
            border-color: rgba(39, 174, 96, 0.3);
        }
        
        .result-good {
            color: #3498db;
            background-color: rgba(52, 152, 219, 0.1);
            border-color: rgba(52, 152, 219, 0.3);
        }
        
        .result-average {
            color: #f39c12;
            background-color: rgba(243, 156, 18, 0.1);
            border-color: rgba(243, 156, 18, 0.3);
        }
        
        .result-poor {
            color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
            border-color: rgba(231, 76, 60, 0.3);
        }
        
        .student-name {
            color: #3498db;
            cursor: pointer;
            font-weight: bold;
            transition: color 0.3s ease;
            padding: 5px;
            border-radius: 3px;
        }
        
        .student-name:hover {
            color: #2980b9;
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .edit-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s ease;
        }
        
        .edit-btn:hover {
            background-color: #e67e22;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .search-container input,
        .search-container select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex: 1;
            min-width: 200px;
        }
        
        .stats-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-right: 5px solid #3498db;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .file-upload-section {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #3498db;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .search-container input,
            .search-container select {
                min-width: 100%;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
            <p>Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØªÙ‚ÙŠÙŠÙ… Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
        </div>

        <!-- Ù‚Ø³Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
        <div id="loginSection" class="section">
            <div class="login-form">
                <h2 style="margin-bottom: 30px; color: #2c3e50;">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                <div class="input-group">
                    <input type="text" id="teacherId" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¹Ù„Ù…..." autocomplete="off">
                </div>
                <button class="btn" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
                
                <div class="file-upload-section">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">ğŸ“ Ø±ÙØ¹ Ù…Ù„Ù Excel</h3>
                    <input type="file" id="excelFile" accept=".xlsx, .xls" style="margin: 10px 0;">
                    <button class="btn btn-test" id="loadExcelBtn">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel</button>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div id="mainSection" class="section hidden">
            <div class="controls">
                <button class="btn btn-logout" id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                <div style="color: #2c3e50; font-weight: bold;">
                    <span>Ø§Ù„Ù…Ø¹Ù„Ù…: </span>
                    <span id="currentTeacher"></span>
                    <span> | Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: </span>
                    <span id="studentsCount">0</span>
                </div>
            </div>

            <div id="teacherInfo" class="teacher-info hidden">
                <h3>ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
                <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</p>
            </div>

            <!-- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ -->
            <div id="searchContainer" class="search-container hidden">
                <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯...">
                <select id="sortSelect">
                    <option value="name">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ø£Ø³Ù…</option>
                    <option value="barcode">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</option>
                    <option value="class">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„ÙØµÙ„</option>
                    <option value="result1">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø© 1</option>
                    <option value="result2">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø© 2</option>
                    <option value="result3">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø© 3</option>
                </select>
                <button class="btn" id="exportBtn" style="background: linear-gradient(135deg, #27ae60, #229954);">
                    ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
            </div>

            <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
            <div id="statsContainer"></div>

            <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                            <th>Ø§Ù„ÙØµÙ„</th>
                            <th>Ø§Ù„Ù†ØªÙŠØ¬Ø© 1</th>
                            <th>Ø§Ù„Ù†ØªÙŠØ¬Ø© 2</th>
                            <th>Ø§Ù„Ù†ØªÙŠØ¬Ø© 3</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; color: #666; padding: 40px;">
                                â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
        <div id="loading" class="loading hidden">
            â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
        </div>
    </div>

    <script>
        // ========== Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ Ø§Ù„ØµÙØ­Ø© ==========
        const loginSection = document.getElementById('loginSection');
        const mainSection = document.getElementById('mainSection');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const teacherIdInput = document.getElementById('teacherId');
        const studentsTableBody = document.getElementById('studentsTableBody');
        const loadingDiv = document.getElementById('loading');
        const teacherInfoDiv = document.getElementById('teacherInfo');
        const currentTeacherSpan = document.getElementById('currentTeacher');
        const studentsCountSpan = document.getElementById('studentsCount');
        const loadExcelBtn = document.getElementById('loadExcelBtn');
        const excelFileInput = document.getElementById('excelFile');
        const exportBtn = document.getElementById('exportBtn');

        // ========== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ==========
        let currentTeacherId = '';
        let filteredStudents = [];
        let allStudents = [];
        let excelData = null;

        // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ ==========
        function validateTeacherId(teacherId) {
            return /^[a-zA-Z0-9_\-]+$/.test(teacherId) && teacherId.length >= 3;
        }

        // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ==========
        function showLoading(show, message = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...') {
            if (show) {
                loadingDiv.classList.remove('hidden');
                loadingDiv.innerHTML = `<p>${message}</p>`;
            } else {
                loadingDiv.classList.add('hidden');
            }
        }

        function showError(message) {
            loadingDiv.classList.remove('hidden');
            loadingDiv.innerHTML = `
                <div style="color: red; text-align: center; padding: 20px;">
                    <p>âŒ ${message}</p>
                    <button onclick="hideError()" style="margin: 5px; padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">
                        Ø¥ØºÙ„Ø§Ù‚
                    </button>
                </div>
            `;
        }

        function hideError() {
            loadingDiv.classList.add('hidden');
        }

        function showSuccess(message) {
            loadingDiv.classList.remove('hidden');
            loadingDiv.innerHTML = `<p style="color: green;">âœ… ${message}</p>`;
            setTimeout(() => loadingDiv.classList.add('hidden'), 3000);
        }

        // ========== Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Excel ==========
        function handleExcelFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        excelData = jsonData;
                        resolve(true);
                    } catch (error) {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù:', error);
                        resolve(false);
                    }
                };
                
                reader.onerror = function() {
                    resolve(false);
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // ========== ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Excel ==========
        function parseExcelData() {
            if (!excelData || excelData.length < 2) {
                showError('âŒ Ù…Ù„Ù Excel Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©');
                return false;
            }

            const headers = excelData[0];
            console.log('ğŸ” Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:', headers);

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø¹Ø±Ù ÙÙŠ Ø§Ù„Ø±Ø¤ÙˆØ³
            const teacherIdColumn = findTeacherIdColumn(headers);
            if (teacherIdColumn === -1) {
                showError('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ "Ø§Ù„Ù…Ø¹Ø±Ù" ÙÙŠ Ù…Ù„Ù Excel');
                return false;
            }

            allStudents = [];
            
            for (let i = 1; i < excelData.length; i++) {
                const row = excelData[i];
                if (row.length === 0) continue;

                const rowTeacherId = row[teacherIdColumn];
                if (!rowTeacherId) continue;

                const student = {
                    id: row[0] || `STD${i}`,
                    barcode: row[1] || '',
                    name: row[2] || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
                    class: row[3] || '---',
                    result1: formatGrade(row[9]),  // Ù…Ø­ØµÙ„Ø© 1
                    result2: formatGrade(row[15]), // Ù…Ø­ØµÙ„Ø© 2  
                    result3: formatGrade(row[21]), // Ù…Ø­ØµÙ„Ø© 3
                    teacherId: rowTeacherId.toString().trim(),
                    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
                    fullData: row
                };

                allStudents.push(student);
            }

            console.log(`âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ ${allStudents.length} Ø·Ø§Ù„Ø¨ Ù…Ù† Ù…Ù„Ù Excel`);
            return true;
        }

        function findTeacherIdColumn(headers) {
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i]?.toString().toLowerCase().trim();
                if (header && (header.includes('Ù…Ø¹Ø±Ù') || header.includes('teacherid') || header.includes('id'))) {
                    return i;
                }
            }
            return -1;
        }

        function formatGrade(value) {
            if (value === null || value === undefined || value === '') return '0.0';
            if (typeof value === 'number') return value.toFixed(1);
            return parseFloat(value) || 0.0;
        }

        // ========== ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù… ==========
        function filterStudentsByTeacher() {
            if (!allStudents || allStudents.length === 0) {
                filteredStudents = [];
                return;
            }

            filteredStudents = allStudents.filter(student => 
                student.teacherId === currentTeacherId
            );

            console.log(`ğŸ‘¨â€ğŸ« ØªÙ… ØªØµÙÙŠØ© ${filteredStudents.length} Ø·Ø§Ù„Ø¨ Ù„Ù„Ù…Ø¹Ù„Ù… ${currentTeacherId}`);
        }

        // ========== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ==========
        function calculateStatistics(students) {
            const stats = {
                total: students.length,
                excellent: 0,
                good: 0,
                average: 0,
                poor: 0
            };
            
            students.forEach(student => {
                const avg = (parseFloat(student.result1 || 0) + 
                            parseFloat(student.result2 || 0) + 
                            parseFloat(student.result3 || 0)) / 3;
                
                if (avg >= 4.5) stats.excellent++;
                else if (avg >= 3.5) stats.good++;
                else if (avg >= 2.5) stats.average++;
                else stats.poor++;
            });
            
            return stats;
        }

        function displayStatistics(students) {
            const stats = calculateStatistics(students);
            const statsHTML = `
                <div class="stats-container">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div style="color: #27ae60; font-weight: bold; font-size: 18px;">${stats.excellent}</div>
                            <div style="font-size: 12px; color: #666;">Ù…Ù…ØªØ§Ø²</div>
                        </div>
                        <div class="stat-item">
                            <div style="color: #3498db; font-weight: bold; font-size: 18px;">${stats.good}</div>
                            <div style="font-size: 12px; color: #666;">Ø¬ÙŠØ¯</div>
                        </div>
                        <div class="stat-item">
                            <div style="color: #f39c12; font-weight: bold; font-size: 18px;">${stats.average}</div>
                            <div style="font-size: 12px; color: #666;">Ù…ØªÙˆØ³Ø·</div>
                        </div>
                        <div class="stat-item">
                            <div style="color: #e74c3c; font-weight: bold; font-size: 18px;">${stats.poor}</div>
                            <div style="font-size: 12px; color: #666;">Ø¶Ø¹ÙŠÙ</div>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white;">
                            <div style="font-weight: bold; font-size: 18px;">${stats.total}</div>
                            <div style="font-size: 12px;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</div>
                        </div>
                    </div>
                </div>
            `;
            
            const existingStats = document.getElementById('statsContainer');
            if (existingStats) {
                existingStats.innerHTML = statsHTML;
            } else {
                const statsContainer = document.createElement('div');
                statsContainer.id = 'statsContainer';
                statsContainer.innerHTML = statsHTML;
                teacherInfoDiv.parentNode.insertBefore(statsContainer, teacherInfoDiv.nextSibling);
            }
        }

        // ========== Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ ==========
        function addSearchFunctionality() {
            const searchContainer = document.createElement('div');
            searchContainer.style.cssText = 'margin: 15px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;';
            
            searchContainer.innerHTML = `
                <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯..." 
                       style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; flex: 1; min-width: 200px;">
                <select id="sortSelect" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="name">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ø£Ø³Ù…</option>
                    <option value="barcode">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</option>
                    <option value="class">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„ÙØµÙ„</option>
                    <option value="result1">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø© 1</option>
                    <option value="result2">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø© 2</option>
                    <option value="result3">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø© 3</option>
                </select>
            `;
            
            teacherInfoDiv.parentNode.insertBefore(searchContainer, teacherInfoDiv.nextSibling);
            
            // Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ±ØªÙŠØ¨
            document.getElementById('searchInput').addEventListener('input', function(e) {
                filterAndSortStudents();
            });
            
            document.getElementById('sortSelect').addEventListener('change', function() {
                filterAndSortStudents();
            });
        }

        function filterAndSortStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const sortBy = document.getElementById('sortSelect').value;
            
            let filtered = filteredStudents.filter(student => 
                (student.name?.toLowerCase().includes(searchTerm) ||
                 student.barcode?.toLowerCase().includes(searchTerm) ||
                 student.class?.toLowerCase().includes(searchTerm))
            );
            
            // Ø§Ù„ØªØ±ØªÙŠØ¨
            filtered.sort((a, b) => {
                let aVal = a[sortBy] || '';
                let bVal = b[sortBy] || '';
                
                if (sortBy.includes('result')) {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                    return bVal - aVal; // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ù†ØªØ§Ø¦Ø¬
                }
                
                return aVal.toString().localeCompare(bVal.toString());
            });
            
            renderStudentsTable(filtered);
            displayStatistics(filtered);
        }

        // ========== ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==========
        function exportToExcel() {
            if (filteredStudents.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ±
            const exportData = [
                ['Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„ÙØµÙ„', 'Ø§Ù„Ù†ØªÙŠØ¬Ø© 1', 'Ø§Ù„Ù†ØªÙŠØ¬Ø© 2', 'Ø§Ù„Ù†ØªÙŠØ¬Ø© 3', 'Ø§Ù„Ù…Ø¹Ù„Ù…']
            ];
            
            filteredStudents.forEach(student => {
                exportData.push([
                    student.barcode || '',
                    student.name || '',
                    student.class || '',
                    student.result1 || '0.0',
                    student.result2 || '0.0', 
                    student.result3 || '0.0',
                    currentTeacherId
                ]);
            });
            
            // Ø¥Ù†Ø´Ø§Ø¡ workbook
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ø·Ù„Ø§Ø¨');
            
            // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
            const fileName = `Ø·Ù„Ø§Ø¨_${currentTeacherId}_${new Date().toLocaleDateString('ar-EG')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showSuccess('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
        }

        // ========== Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ==========
        function renderStudentsTable(students = filteredStudents) {
            studentsTableBody.innerHTML = '';
            
            if (students.length === 0) {
                studentsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #666; padding: 40px;">
                            ğŸ“ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø¹Ù„Ù… ${currentTeacherId}
                        </td>
                    </tr>
                `;
                return;
            }
            
            students.forEach((student, index) => {
                const row = document.createElement('tr');
                
                function getResultClass(result) {
                    const value = parseFloat(result) || 0;
                    if (value >= 4.5) return 'result-excellent';
                    if (value >= 3.5) return 'result-good';
                    if (value >= 2.5) return 'result-average';
                    return 'result-poor';
                }

                const result1Class = getResultClass(student.result1);
                const result2Class = getResultClass(student.result2);
                const result3Class = getResultClass(student.result3);
                
                row.innerHTML = `
                    <td>${student.barcode || '---'}</td>
                    <td>
                        <span class="student-name" data-id="${student.id}">
                            ${student.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}
                        </span>
                    </td>
                    <td>${student.class || '---'}</td>
                    <td class="result-cell ${result1Class}">${student.result1 || '0.0'}</td>
                    <td class="result-cell ${result2Class}">${student.result2 || '0.0'}</td>
                    <td class="result-cell ${result3Class}">${student.result3 || '0.0'}</td>
                    <td>
                        <button class="edit-btn" data-id="${student.id}" onclick="openEditModal('${student.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                    </td>
                `;
                studentsTableBody.appendChild(row);
            });
        }

        // ========== ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ==========
        function openEditModal(studentId) {
            const student = filteredStudents.find(s => s.id === studentId);
            if (!student) return;
            
            // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ù‡Ù†Ø§ Ù†ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            // Ù„ÙƒÙ† Ù„Ù„ØªØ¨Ø³ÙŠØ· Ø³Ù†Ø³ØªØ®Ø¯Ù… prompt
            const newResult1 = prompt(`Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© 1 Ù„Ù„Ø·Ø§Ù„Ø¨ ${student.name}:`, student.result1);
            const newResult2 = prompt(`Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© 2 Ù„Ù„Ø·Ø§Ù„Ø¨ ${student.name}:`, student.result2);
            const newResult3 = prompt(`Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© 3 Ù„Ù„Ø·Ø§Ù„Ø¨ ${student.name}:`, student.result3);
            
            if (newResult1 !== null && newResult2 !== null && newResult3 !== null) {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                student.result1 = formatGrade(newResult1);
                student.result2 = formatGrade(newResult2);
                student.result3 = formatGrade(newResult3);
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                renderStudentsTable();
                displayStatistics(filteredStudents);
                showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            }
        }

        // ========== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==========
        function loadStudentsForTeacher() {
            if (!excelData) {
                showError('âŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            showLoading(true);
            
            try {
                // ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…
                filterStudentsByTeacher();
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                renderStudentsTable();
                displayStatistics(filteredStudents);
                studentsCountSpan.textContent = filteredStudents.length;
                currentTeacherSpan.textContent = currentTeacherId;
                teacherInfoDiv.classList.remove('hidden');
                
                // Ø¥Ø¶Ø§ÙØ© Ø®ÙˆØ§Øµ Ø§Ù„Ø¨Ø­Ø« Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                if (!document.getElementById('searchInput')) {
                    addSearchFunctionality();
                }
                
                document.getElementById('searchContainer').classList.remove('hidden');
                
                showLoading(false);
                showSuccess(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${filteredStudents.length} Ø·Ø§Ù„Ø¨`);
                
            } catch (error) {
                showLoading(false);
                showError('Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ' + error.message);
                console.error('âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:', error);
            }
        }

        // ========== Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ==========
        loginBtn.addEventListener('click', async function() {
            const teacherId = teacherIdInput.value.trim();
            if (!teacherId) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ø±Ù');
                return;
            }
            
            if (!validateTeacherId(teacherId)) {
                alert('Ø§Ù„Ù…Ø¹Ø±Ù ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø­Ø±Ù ÙˆØ£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· ÙˆÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            
            currentTeacherId = teacherId;
            
            if (!excelData) {
                showError('âŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            loginSection.classList.add('hidden');
            mainSection.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            
            loadStudentsForTeacher();
        });

        loadExcelBtn.addEventListener('click', async function() {
            const file = excelFileInput.files[0];
            if (!file) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel');
                return;
            }
            
            showLoading(true, 'ğŸ“ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Excel...');
            
            const success = await handleExcelFile(file);
            showLoading(false);
            
            if (success) {
                const parsed = parseExcelData();
                if (parsed) {
                    showSuccess('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­');
                    // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¹Ø±Ù Ù…Ø¯Ø®Ù„Ø§Ù‹
                    if (teacherIdInput.value.trim()) {
                        loginBtn.disabled = false;
                    }
                }
            } else {
                showError('âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel');
            }
        });

        logoutBtn.addEventListener('click', function() {
            currentTeacherId = '';
            loginSection.classList.remove('hidden');
            mainSection.classList.add('hidden');
            logoutBtn.classList.add('hidden');
            teacherIdInput.value = '';
            teacherInfoDiv.classList.add('hidden');
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            const statsContainer = document.getElementById('statsContainer');
            if (statsContainer) {
                statsContainer.innerHTML = '';
            }
        });

        exportBtn.addEventListener('click', exportToExcel);

        // Ø¥Ø¯Ø®Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        teacherIdInput.value = 'ameen';

        console.log('ğŸš€ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² - Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Excel Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Google Sheets');
    </script>
</body>
</html>