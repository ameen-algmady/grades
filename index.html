<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ - GitHub Excel + Google Sheets Update</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .section {
            padding: 25px;
            display: block;
        }

        .hidden {
            display: none !important;
        }

        .login-form {
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .input-group {
            margin-bottom: 20px;
        }

        input, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-logout {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .teacher-info {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-right: 5px solid #3498db;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 10px;
            text-align: right;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #ecf0f1;
            text-align: right;
            font-size: 14px;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .result-cell {
            font-weight: bold;
            text-align: center;
            font-size: 13px;
            padding: 8px 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .result-excellent {
            color: #27ae60;
            background-color: rgba(39, 174, 96, 0.1);
            border-color: rgba(39, 174, 96, 0.3);
        }

        .result-good {
            color: #3498db;
            background-color: rgba(52, 152, 219, 0.1);
            border-color: rgba(52, 152, 219, 0.3);
        }

        .result-average {
            color: #f39c12;
            background-color: rgba(243, 156, 18, 0.1);
            border-color: rgba(243, 156, 18, 0.3);
        }

        .result-poor {
            color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
            border-color: rgba(231, 76, 60, 0.3);
        }

        .student-name {
            color: #3498db;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
        }

        .student-name:hover {
            color: #2980b9;
            background-color: rgba(52, 152, 219, 0.1);
            transform: translateY(-1px);
        }

        .edit-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s ease;
        }

        .edit-btn:hover {
            background-color: #e67e22;
        }

        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .search-container input,
        .search-container select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex: 1;
            min-width: 200px;
        }

        /* 1- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆÙ†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Modal) */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 25px;
            border-radius: 15px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        /* 1- ØªØµÙ…ÙŠÙ… Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Popup Stats) */
        #statsModal .modal-content {
            max-width: 600px;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            background: #f0f0f0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .student-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        /* 3- ØªØ¹Ø¯ÙŠÙ„ ØªØµÙ…ÙŠÙ… Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø´Ù‡Ø± */
        .form-section {
            grid-column: 1 / -1;
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-section h4 {
            color: var(--primary-color);
            margin: 0;
        }

        .save-term-btn {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .save-term-btn:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
            transform: translateY(-1px);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--dark-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #d0eaff;
        }
        
        /* ğŸš¨ Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© */
        .sync-btn-container {
            position: relative;
            display: inline-block;
        }
        
        #pendingCount {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: bold;
            line-height: 1;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-container {
                flex-direction: column;
            }

            .search-container input,
            .search-container select {
                min-width: 100%;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 5px;
            }

            .student-form {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 5% auto;
                padding: 15px;
                width: 98%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
            <p>Ø§ØªØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Google Sheets</p>
        </div>

        <div id="loginSection" class="section">
            <div class="login-form">
                <h2 style="margin-bottom: 30px; color: #2c3e50;">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>

                <div class="input-group">
                    <input type="text" id="teacherId" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¹Ù„Ù…..." autocomplete="off" value="ameen">
                </div>

                <div class="connection-status" id="connectionStatus">
                    â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets...
                </div>

                <button class="btn btn-success" id="loginBtn" disabled>ğŸ”— Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„</button>
                <button class="btn btn-warning" id="retryBtn">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                <button class="btn" id="useLocalDataBtn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">ğŸ’¾ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</button>
            </div>
        </div>

        <div id="mainSection" class="section hidden">
            <div class="controls">
                <button class="btn btn-logout" id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                <div style="color: #2c3e50; font-weight: bold;">
                    <span>Ø§Ù„Ù…Ø¹Ù„Ù…: </span>
                    <span id="currentTeacher"></span>
                    <span> | Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: </span>
                    <span id="studentsCount">0</span>
                </div>
            </div>

            <div id="teacherInfo" class="teacher-info hidden">
                <h3>ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
                <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª </p>
            </div>

            <div id="searchContainer" class="search-container hidden">
                <input type="text" id="searchInput" placeholder="ğŸ” ØªØµÙÙŠØ© Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³Ù…...">
                <select id="classFilter">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø¹Ø¨</option>
                </select>
                <button class="btn" id="showStatsBtn" style="background: linear-gradient(135deg, #27ae60, #229954);">
                    ğŸ“ˆ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                </button>
                <button class="btn" id="saveLocalBtn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                    ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
                </button>
                <div class="sync-btn-container">
                    <button class="btn" id="syncSheetsBtn" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                        â˜ï¸ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª (Sheets)
                    </button>
                    <span id="pendingCount" class="hidden">0</span>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Barcode</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                            <th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
                            <th>Ù…ÙˆØ§Ø¸Ø¨Ø© 1</th>
                            <th>Ø´ÙÙ‡ÙŠ 1</th>
                            <th>ÙˆØ§Ø¬Ø¨Ø§Øª 1</th>
                            <th>ØªØ­Ø±ÙŠØ±ÙŠ 1</th>
                            <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 1</th>
                            <th>Ù…Ø­ØµÙ„Ø© 1</th>
                            <th>Ù…ÙˆØ§Ø¸Ø¨Ø© 2</th>
                            <th>Ø´ÙÙ‡ÙŠ 2</th>
                            <th>ÙˆØ§Ø¬Ø¨Ø§Øª 2</th>
                            <th>ØªØ­Ø±ÙŠØ±ÙŠ 2</th>
                            <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 2</th>
                            <th>Ù…Ø­ØµÙ„Ø© 2</th>
                            <th>Ù…ÙˆØ§Ø¸Ø¨Ø© 3</th>
                            <th>ÙˆØ§Ø¬Ø¨Ø§Øª 3</th>
                            <th>Ø´ÙÙ‡ÙŠ 3</th>
                            <th>ØªØ­Ø±ÙŠØ±ÙŠ 3</th>
                            <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ 3</th>
                            <th>Ù…Ø­ØµÙ„Ø© 3</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <tr>
                            <td colspan="23" style="text-align: center; color: #666; padding: 40px;">
                                â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="loading" class="loading hidden">
            â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
        </div>

        <div id="statsModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal('statsModal')">&times;</span>
                <h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ÙÙ„ØªØ±ÙŠÙ†</h3>
                <div id="statsContainer" class="stats-grid">
                    </div>
            </div>
        </div>

        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal('editModal')">&times;</span>
                <h3>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨: <span id="currentStudentName"></span></h3>
                <div id="studentForm" class="student-form">
                    <input type="hidden" id="editStudentId">

                    <div class="form-section">
                        <h4>ğŸ“˜ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ÙˆÙ„</h4>
                        <button type="button" class="save-term-btn btn-warning" data-term="1">Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø´Ù‡Ø± 1</button>
                    </div>
                    <div class="form-group">
                        <label for="editAttendance1">Ù…ÙˆØ§Ø¸Ø¨Ø© 1:</label>
                        <input type="number" id="editAttendance1" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editOral1">Ø´ÙÙ‡ÙŠ 1:</label>
                        <input type="number" id="editOral1" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editHomework1">ÙˆØ§Ø¬Ø¨Ø§Øª 1:</label>
                        <input type="number" id="editHomework1" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editWritten1">ØªØ­Ø±ÙŠØ±ÙŠ 1:</label>
                        <input type="number" id="editWritten1" min="0" max="40" step="0.1">
                    </div>

                    <div class="form-section">
                        <h4>ğŸ“— Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ</h4>
                        <button type="button" class="save-term-btn btn-warning" data-term="2">Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø´Ù‡Ø± 2</button>
                    </div>
                    <div class="form-group">
                        <label for="editAttendance2">Ù…ÙˆØ§Ø¸Ø¨Ø© 2:</label>
                        <input type="number" id="editAttendance2" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editOral2">Ø´ÙÙ‡ÙŠ 2:</label>
                        <input type="number" id="editOral2" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editHomework2">ÙˆØ§Ø¬Ø¨Ø§Øª 2:</label>
                        <input type="number" id="editHomework2" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editWritten2">ØªØ­Ø±ÙŠØ±ÙŠ 2:</label>
                        <input type="number" id="editWritten2" min="0" max="40" step="0.1">
                    </div>

                    <div class="form-section">
                        <h4>ğŸ“™ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø«</h4>
                        <button type="button" class="save-term-btn btn-warning" data-term="3">Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø´Ù‡Ø± 3</button>
                    </div>
                    <div class="form-group">
                        <label for="editAttendance3">Ù…ÙˆØ§Ø¸Ø¨Ø© 3:</label>
                        <input type="number" id="editAttendance3" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editHomework3">ÙˆØ§Ø¬Ø¨Ø§Øª 3:</label>
                        <input type="number" id="editHomework3" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editOral3">Ø´ÙÙ‡ÙŠ 3:</label>
                        <input type="number" id="editOral3" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editWritten3">ØªØ­Ø±ÙŠØ±ÙŠ 3:</label>
                        <input type="number" id="editWritten3" min="0" max="40" step="0.1">
                    </div>

                    <div class="form-section" style="justify-content: center; border-bottom: none;">
                        <button type="button" id="cancelEditBtn" class="btn btn-danger">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
// JavaScript Code (Ù…ØµØ­Ø­ Ù„ØªØªØ¨Ø¹ ÙˆÙ…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©)

// ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Google Sheets Ùˆ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ==========
const GITHUB_EXCEL_URL = 'https://raw.githubusercontent.com/ameen-algmady/grades/main/students.xlsx';
const LOCAL_STORAGE_KEY = 'studentsData';
const PENDING_UPDATES_KEY = 'pendingUpdates'; // ğŸš¨ Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯ Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
// ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ù† Google Apps Script (ØªÙ… Ø§ÙØªØ±Ø§Ø¶ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¢Ù† Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¨Ø± POST)
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyj4psjmlbXkjFsOz9rgEbkSMvvDO0rJal7BAHo7QhJfrTIxP8nb3t3XFKekV1IkcZx/exec';

// ========== Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ Ø§Ù„ØµÙØ­Ø© (ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹) ==========
const loginSection = document.getElementById('loginSection');
const mainSection = document.getElementById('mainSection');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const retryBtn = document.getElementById('retryBtn');
const useLocalDataBtn = document.getElementById('useLocalDataBtn');
const saveLocalBtn = document.getElementById('saveLocalBtn');
const teacherIdInput = document.getElementById('teacherId');
const studentsTableBody = document.getElementById('studentsTableBody');
const loadingDiv = document.getElementById('loading');
const teacherInfoDiv = document.getElementById('teacherInfo');
const currentTeacherSpan = document.getElementById('currentTeacher');
const studentsCountSpan = document.getElementById('studentsCount');
const connectionStatus = document.getElementById('connectionStatus');
const editModal = document.getElementById('editModal');
const syncSheetsBtn = document.getElementById('syncSheetsBtn'); // ğŸš¨ Ø²Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
const pendingCountSpan = document.getElementById('pendingCount'); // ğŸš¨ Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©

const cancelEditBtn = document.getElementById('cancelEditBtn');
const currentStudentName = document.getElementById('currentStudentName');

// Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¯Ø§Ø®Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
const editStudentId = document.getElementById('editStudentId');
const editAttendance1 = document.getElementById('editAttendance1');
const editOral1 = document.getElementById('editOral1');
const editHomework1 = document.getElementById('editHomework1');
const editWritten1 = document.getElementById('editWritten1');
const editAttendance2 = document.getElementById('editAttendance2');
const editOral2 = document.getElementById('editOral2');
const editHomework2 = document.getElementById('editHomework2');
const editWritten2 = document.getElementById('editWritten2');
const editAttendance3 = document.getElementById('editAttendance3');
const editHomework3 = document.getElementById('editHomework3');
const editOral3 = document.getElementById('editOral3');
const editWritten3 = document.getElementById('editWritten3');

// Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
const saveTermButtons = document.querySelectorAll('.save-term-btn');


// ========== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ==========
let currentTeacherId = '';
let filteredStudents = [];
let allStudents = [];
let currentEditStudent = null;
let usingLocalData = false;
let pendingUpdates = []; // ğŸš¨ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØªØ¨Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª

// ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø© (ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨Ø¹Ø¶Ù‡Ø§) ==========

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function updatePendingCount() {
    pendingUpdates = loadPendingUpdates(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù„Ù„ØªØ£ÙƒØ¯
    const count = pendingUpdates.length;
    pendingCountSpan.textContent = count;
    if (count > 0) {
        pendingCountSpan.classList.remove('hidden');
        syncSheetsBtn.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡
    } else {
        pendingCountSpan.classList.add('hidden');
        syncSheetsBtn.style.background = 'linear-gradient(135deg, #3498db, #2980b9)'; // Ù„ÙˆÙ† Ø¹Ø§Ø¯ÙŠ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª
    }
}

// ========== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ù…Ø¹ ØªØªØ¨Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª) ==========

function savePendingUpdates() {
    try {
        localStorage.setItem(PENDING_UPDATES_KEY, JSON.stringify(pendingUpdates));
        updatePendingCount();
    } catch (error) {
        console.error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
    }
}

function loadPendingUpdates() {
    try {
        const data = localStorage.getItem(PENDING_UPDATES_KEY);
        return data ? JSON.parse(data) : [];
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©:', error);
        return [];
    }
}

function saveDataToLocalStorage() {
    try {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allStudents));
        // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø¥Ø¸Ù‡Ø§Ø± Success Ù‡Ù†Ø§ØŒ Ø¨Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ
        return true;
    } catch (error) {
        showError('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹: ' + error.message);
        return false;
    }
}

function loadDataFromLocalStorage() {
    try {
        const data = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (data) {
            allStudents = JSON.parse(data);
            pendingUpdates = loadPendingUpdates(); // ğŸš¨ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
            updatePendingCount(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
            return true;
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', error);
    }
    return false;
}

// ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„: validateTeacherId, showLoading, showError, hideError, showSuccess, updateConnectionStatus, formatGrade ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
function validateTeacherId(teacherId) {
    return /^[a-zA-Z0-9_\-]+$/.test(teacherId) && teacherId.length >= 3;
}

function showLoading(show, message = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...') {
    if (show) {
        loadingDiv.classList.remove('hidden');
        loadingDiv.innerHTML = `<p>${message}</p>`;
    } else {
        loadingDiv.classList.add('hidden');
    }
}

function showError(message) {
    loadingDiv.classList.remove('hidden');
    loadingDiv.innerHTML = `
        <div style="color: red; text-align: center; padding: 20px;">
            <p>âŒ ${message}</p>
            <button onclick="hideError()" style="margin: 5px; padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">
                Ø¥ØºÙ„Ø§Ù‚
            </button>
        </div>
    `;
}

function hideError() {
    loadingDiv.classList.add('hidden');
}

function showSuccess(message) {
    loadingDiv.classList.remove('hidden');
    loadingDiv.innerHTML = `<p style="color: green;">âœ… ${message}</p>`;
    setTimeout(() => loadingDiv.classList.add('hidden'), 3000);
}

function updateConnectionStatus(message, type = 'info') {
    const colors = {
        info: '#fff3cd',
        success: '#d4edda',
        error: '#f8d7da',
        warning: '#ffe0b2'
    };

    const borderColors = {
        info: '#ffeaa7',
        success: '#c3e6cb',
        error: '#f5c6cb',
        warning: '#ffc107'
    };

    connectionStatus.innerHTML = message;
    connectionStatus.style.background = colors[type] || colors.info;
    connectionStatus.style.borderColor = borderColors[type] || colors.info;
}

function formatGrade(value) {
    if (value === null || value === undefined || value === '') return '0';
    const strValue = value.toString().trim();
    const numValue = parseFloat(strValue);
    if (isNaN(numValue)) return '0';
    return numValue.toFixed(1).replace(/\.0$/, '');
}

// ========== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµÙÙŠØ© ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¡ (Ù„Ù… ØªØªØºÙŠØ±) ==========

function filterStudentsByTeacher() {
    if (!allStudents || allStudents.length === 0) {
        filteredStudents = [];
        return;
    }

    filteredStudents = allStudents.filter(student => student.teacherId === currentTeacherId);
}

function updateClassFilter() {
    const classFilter = document.getElementById('classFilter');
    const classes = [...new Set(filteredStudents.map(student => student.class).filter(c => c))];

    classFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø¹Ø¨</option>';
    classes.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        classFilter.appendChild(option);
    });
}

function filterStudents() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const selectedClass = document.getElementById('classFilter').value;

    let filtered = allStudents.filter(student => student.teacherId === currentTeacherId);

    if (searchTerm) {
        filtered = filtered.filter(student =>
            student.name.toLowerCase().includes(searchTerm) ||
            student.barcode.toLowerCase().includes(searchTerm)
        );
    }

    if (selectedClass) {
        filtered = filtered.filter(student => student.class === selectedClass);
    }

    filteredStudents = filtered;
    renderStudentsTable();
    displayStatistics(filteredStudents);
}

function renderStudentsTable() {
    studentsTableBody.innerHTML = '';

    studentsCountSpan.textContent = filteredStudents.length;

    if (filteredStudents.length === 0) {
        studentsTableBody.innerHTML = `
            <tr>
                <td colspan="23" style="text-align: center; color: #666; padding: 40px;">
                    ğŸ“ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø¹Ù„Ù… ${currentTeacherId}
                </td>
            </tr>
        `;
        return;
    }

    filteredStudents.forEach((student) => {
        const row = document.createElement('tr');

        function getResultClass(result) {
            const value = parseFloat(result) || 0;
            if (value >= 4.5) return 'result-excellent';
            if (value >= 3.5) return 'result-good';
            if (value >= 2.5) return 'result-average';
            return 'result-poor';
        }

        const result1Class = getResultClass(student.result1);
        const result2Class = getResultClass(student.result2);
        const result3Class = getResultClass(student.result3);

        // ğŸš¨ Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø®ÙŠØ±
        row.innerHTML = `
            <td>${student.id}</td>
            <td>${student.barcode}</td>
            <td>
                <span class="student-name" onclick="openEditModal('${student.id}')">
                    ${student.name}
                </span>
            </td>
            <td>${student.class}</td>
            <td>${student.attendance1}</td>
            <td>${student.oral1}</td>
            <td>${student.homework1}</td>
            <td>${student.written1}</td>
            <td>${student.total1}</td>
            <td class="result-cell ${result1Class}">${student.result1}</td>
            <td>${student.attendance2}</td>
            <td>${student.oral2}</td>
            <td>${student.homework2}</td>
            <td>${student.written2}</td>
            <td>${student.total2}</td>
            <td class="result-cell ${result2Class}">${student.result2}</td>
            <td>${student.attendance3}</td>
            <td>${student.homework3}</td>
            <td>${student.oral3}</td>
            <td>${student.written3}</td>
            <td>${student.total3}</td>
            <td class="result-cell ${result3Class}">${student.result3}</td>
            <td><button class="edit-btn" onclick="openEditModal('${student.id}')">ØªØ¹Ø¯ÙŠÙ„</button></td>
        `;
        studentsTableBody.appendChild(row);
    });
}


function calculateAverage(data, key) {
    if (!data || data.length === 0) return '0.0';
    const sum = data.reduce((acc, student) => acc + (parseFloat(student[key]) || 0), 0);
    return (sum / data.length).toFixed(2);
}

function calculateStatistics(data) {
    const stats = {
        totalStudents: data.length,
        avgResult1: calculateAverage(data, 'result1'),
        avgResult2: calculateAverage(data, 'result2'),
        avgResult3: calculateAverage(data, 'result3'),
        avgAttendance1: calculateAverage(data, 'attendance1'),
        avgWritten2: calculateAverage(data, 'written2'),
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‡Ù†Ø§
    };
    return stats;
}

function displayStatistics(data) {
    const stats = calculateStatistics(data);
    const statsContainer = document.getElementById('statsContainer');
    statsContainer.innerHTML = `
        <div class="stat-item">
            <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</strong>
            <p style="font-size: 1.5em; color: var(--dark-color);">${stats.totalStudents}</p>
        </div>
        <div class="stat-item">
            <strong>Ù…ØªÙˆØ³Ø· Ù…Ø­ØµÙ„Ø© 1</strong>
            <p style="font-size: 1.5em; color: var(--primary-color);">${stats.avgResult1}</p>
        </div>
        <div class="stat-item">
            <strong>Ù…ØªÙˆØ³Ø· Ù…Ø­ØµÙ„Ø© 2</strong>
            <p style="font-size: 1.5em; color: var(--primary-color);">${stats.avgResult2}</p>
        </div>
        <div class="stat-item">
            <strong>Ù…ØªÙˆØ³Ø· Ù…Ø­ØµÙ„Ø© 3</strong>
            <p style="font-size: 1.5em; color: var(--primary-color);">${stats.avgResult3}</p>
        </div>
        <div class="stat-item">
            <strong>Ù…ØªÙˆØ³Ø· Ù…ÙˆØ§Ø¸Ø¨Ø© 1</strong>
            <p style="font-size: 1.5em; color: var(--success-color);">${stats.avgAttendance1}</p>
        </div>
        <div class="stat-item">
            <strong>Ù…ØªÙˆØ³Ø· ØªØ­Ø±ÙŠØ±ÙŠ 2</strong>
            <p style="font-size: 1.5em; color: var(--warning-color);">${stats.avgWritten2}</p>
        </div>
    `;
}

// ========== Ø¯ÙˆØ§Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù„Ù… ØªØªØºÙŠØ±) ==========

async function loadDataFromGoogleSheets() {
    updateConnectionStatus('ğŸŒ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ù† Google Sheets...', 'info');

    try {
        const response = await fetch(WEB_APP_URL, {
            method: 'GET',
        });

        if (!response.ok) {
            throw new Error(`ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${response.status} ${response.statusText}`);
        }

        const rawData = await response.json();

        if (rawData.error) {
            throw new Error(rawData.error);
        }

        const processedStudents = rawData.map(row => {
            const teacherIdFromSheet = (row['Ø§Ù„Ù…Ø¹Ø±Ù'] || '').toString().trim();

            return {
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                id: (row['ID'] || '').toString().trim(), // ID Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ A
                barcode: (row['Barcode'] || '').toString().trim(),
                name: row['Ø§Ù„Ø§Ø³Ù…'] || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
                class: row['Ø§Ù„Ø´Ø¹Ø¨Ø©'] || '---',
                teacherId: teacherIdFromSheet,
                subject: row['Ø§Ù„Ù…Ø§Ø¯Ø©'] || '---',

                // Ø§Ù„ØªØ±Ù… Ø§Ù„Ø£ÙˆÙ„
                attendance1: formatGrade(row['Ù…ÙˆØ§Ø¸Ø¨Ø©']),
                oral1: formatGrade(row['Ø´ÙÙ‡ÙŠ 1']),
                homework1: formatGrade(row['ÙˆØ§Ø¬Ø¨Ø§Øª 1']),
                written1: formatGrade(row['ØªØ­Ø±ÙŠØ±ÙŠ 1']),
                total1: formatGrade(row['Ø§Ù„Ù…Ø¬Ù…Ù€Ù€Ù€Ù€Ù€ÙˆØ¹1']),
                result1: formatGrade(row['Ù…Ø­ØµÙ„Ø©1']),

                // Ø§Ù„ØªØ±Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ
                attendance2: formatGrade(row['Ù…ÙˆØ§Ø¸Ø¨Ø© 2']),
                oral2: formatGrade(row['Ø´ÙÙ‡ÙŠ 2']),
                homework2: formatGrade(row['ÙˆØ§Ø¬Ø¨Ø§Øª 2']),
                written2: formatGrade(row['ØªØ­Ø±ÙŠØ±ÙŠ 2']),
                total2: formatGrade(row['Ø§Ù„Ù…Ø¬Ù…Ù€Ù€Ù€Ù€Ù€ÙˆØ¹2']),
                result2: formatGrade(row['Ù…Ø­ØµÙ„Ø©2']),

                // Ø§Ù„ØªØ±Ù… Ø§Ù„Ø«Ø§Ù„Ø«
                attendance3: formatGrade(row['Ù…ÙˆØ§Ø¸Ø¨Ø©']),
                homework3: formatGrade(row['ÙˆØ§Ø¬Ø¨Ø§Øª 3']),
                oral3: formatGrade(row['Ø´ÙÙ‡ÙŠ 3']),
                written3: formatGrade(row['ØªØ­Ø±ÙŠØ±ÙŠ 3']),
                total3: formatGrade(row['Ø§Ù„Ù…Ø¬Ù…Ù€Ù€Ù€Ù€Ù€ÙˆØ¹']),
                result3: formatGrade(row['Ù…Ø­ØµÙ„Ø©3']),
            };
        })
        .filter(student => student.teacherId && student.id);

        allStudents = processedStudents;
        saveDataToLocalStorage();

        updateConnectionStatus(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allStudents.length} Ø·Ø§Ù„Ø¨ Ù…Ù† Google Sheets`, 'success');
        loginBtn.disabled = false;
        loginBtn.style.background = 'linear-gradient(135deg, #27ae60, #229954)';
        usingLocalData = false;
        pendingUpdates = loadPendingUpdates(); // ğŸš¨ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
        updatePendingCount(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Google Sheets:', error);

        if (loadDataFromLocalStorage()) {
            updateConnectionStatus(`âš ï¸ ÙØ´Ù„ Ø§ØªØµØ§Ù„. ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allStudents.length} Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©`, 'warning');
            loginBtn.disabled = false;
            usingLocalData = true;
        } else {
            showError('ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† ÙƒÙ„Ø§ Ø§Ù„Ù…ØµØ¯Ø±ÙŠÙ†. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
            loginBtn.disabled = true;
        }
    }
}

// ========== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù‡Ù†Ø§) ==========

function openEditModal(studentId) {
    currentEditStudent = allStudents.find(s => s.id === studentId);
    if (!currentEditStudent) {
        showError('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨!');
        return;
    }

    currentStudentName.textContent = currentEditStudent.name;
    editStudentId.value = currentEditStudent.id;

    // Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ÙˆÙ„
    editAttendance1.value = currentEditStudent.attendance1;
    editOral1.value = currentEditStudent.oral1;
    editHomework1.value = currentEditStudent.homework1;
    editWritten1.value = currentEditStudent.written1;

    // Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ
    editAttendance2.value = currentEditStudent.attendance2;
    editOral2.value = currentEditStudent.oral2;
    editHomework2.value = currentEditStudent.homework2;
    editWritten2.value = currentEditStudent.written2;

    // Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø«
    editAttendance3.value = currentEditStudent.attendance3;
    editHomework3.value = currentEditStudent.homework3;
    editOral3.value = currentEditStudent.oral3;
    editWritten3.value = currentEditStudent.written3;

    editModal.style.display = 'block';
}

function saveTerm(term) {
    const studentId = editStudentId.value;
    const studentIndex = allStudents.findIndex(s => s.id === studentId);

    if (studentIndex === -1) {
        showError('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ø­ÙØ¸.');
        return;
    }

    const student = allStudents[studentIndex];
    let newGrades = {};

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø± (Term)
    if (term === 1) {
        newGrades = {
            attendance1: formatGrade(editAttendance1.value),
            oral1: formatGrade(editOral1.value),
            homework1: formatGrade(editHomework1.value),
            written1: formatGrade(editWritten1.value),
            // ÙŠØªÙ… Ø­Ø³Ø§Ø¨ total1 Ùˆ result1 ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Google SheetsØŒ Ù„Ø°Ø§ Ù†Ø±Ø³Ù„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ© ÙÙ‚Ø·
        };
    } else if (term === 2) {
        newGrades = {
            attendance2: formatGrade(editAttendance2.value),
            oral2: formatGrade(editOral2.value),
            homework2: formatGrade(editHomework2.value),
            written2: formatGrade(editWritten2.value),
        };
    } else if (term === 3) {
        newGrades = {
            attendance3: formatGrade(editAttendance3.value),
            homework3: formatGrade(editHomework3.value),
            oral3: formatGrade(editOral3.value),
            written3: formatGrade(editWritten3.value),
        };
    } else {
        showError('Ø®Ø·Ø£: Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø± ØºÙŠØ± ØµØ§Ù„Ø­.');
        return;
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    Object.assign(student, newGrades);

    // ğŸš¨ ØªØªØ¨Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
    const updatePayload = {
        id: student.id,
        term: term,
        grades: newGrades,
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ù„Ù„ØµÙØŒ Ù…Ø«Ù„ teacherId Ø£Ùˆ class
    };

    // Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© pendingUpdates
    // Ù†Ø¨Ø­Ø« Ø¹Ù† ØªØ¹Ø¯ÙŠÙ„ Ù„Ù†ÙØ³ Ø§Ù„Ø·Ø§Ù„Ø¨
    const existingIndex = pendingUpdates.findIndex(update => update.id === student.id);

    if (existingIndex !== -1) {
        // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ ØªØ¹Ø¯ÙŠÙ„ Ø³Ø§Ø¨Ù‚ØŒ Ù†Ø¯Ù…Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        const existingUpdate = pendingUpdates[existingIndex];
        // Ù†Ø¯Ù…Ø¬ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
        existingUpdate.grades = { ...existingUpdate.grades, ...newGrades };
        pendingUpdates[existingIndex] = existingUpdate;
    } else {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø³Ø§Ø¨Ù‚ØŒ Ù†Ø¶ÙŠÙ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        pendingUpdates.push(updatePayload);
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
    saveDataToLocalStorage(); // Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
    savePendingUpdates(); // Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©

    showSuccess(`âœ… ØªÙ… Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø´Ù‡Ø± ${term} Ù„Ù„Ø·Ø§Ù„Ø¨ ${student.name} Ù…Ø­Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©!`);

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„ØªØ¸Ù‡Ø± Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
    filterStudents();
    closeModal('editModal');
}

async function syncSheets() {
    if (pendingUpdates.length === 0) {
        showError('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©.');
        return;
    }

    showLoading(true, `â˜ï¸ Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© ${pendingUpdates.length} ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹ Google Sheets...`);
    syncSheetsBtn.disabled = true;

    try {
        // ğŸš¨ Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ÙÙŠ Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯
        const response = await fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                action: 'updateGrades', // Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙ†ÙØ°Ù‡ Apps Script
                updates: JSON.stringify(pendingUpdates)
            }).toString()
        });

        if (!response.ok) {
            throw new Error(`ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${response.status} ${response.statusText}`);
        }

        const result = await response.json();

        if (result.status === 'success') {
            const successCount = result.updatedCount || pendingUpdates.length;

            // ğŸš¨ Ù…Ø³Ø­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
            pendingUpdates = [];
            savePendingUpdates(); // Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©

            showSuccess(`ğŸ‰ Ù†Ø¬Ø§Ø­ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©! ØªÙ… ØªØ­Ø¯ÙŠØ« ${successCount} Ø³Ø¬Ù„ ÙÙŠ Google Sheets.`);

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ ÙˆØ§Ù„Ù…Ø­ØµÙ„Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
            await loadDataFromGoogleSheets();
            filterStudents(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„

        } else {
            throw new Error(result.error || 'ÙØ´Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…Ø­Ø¯Ø¯Ø©.');
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        showError('ÙØ´Ù„ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø£Ùˆ Ø®Ø§Ø¯Ù… Apps Script: ' + error.message);
    } finally {
        showLoading(false);
        syncSheetsBtn.disabled = false;
        updatePendingCount(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
    }
}


// ... (Ø¨Ù‚ÙŠØ© Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ùˆ Event Listeners)

function setupEventListeners() {
    teacherIdInput.addEventListener('input', () => {
        const id = teacherIdInput.value.trim();
        loginBtn.disabled = !validateTeacherId(id);
        if (loginBtn.disabled) {
            updateConnectionStatus('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ù…Ø¹Ù„Ù… ØµØ­ÙŠØ­ (Ø£Ø­Ø±Ù ÙˆØ£Ø±Ù‚Ø§Ù…).', 'warning');
        } else {
            updateConnectionStatus('Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„.', 'info');
        }
    });

    loginBtn.addEventListener('click', async () => {
        currentTeacherId = teacherIdInput.value.trim();
        if (!currentTeacherId) return;

        showLoading(true, 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„...');
        await loadDataFromGoogleSheets();

        if (allStudents.length > 0) {
            loginSection.classList.add('hidden');
            mainSection.classList.remove('hidden');
            teacherInfoDiv.classList.remove('hidden');
            document.getElementById('searchContainer').classList.remove('hidden');
            currentTeacherSpan.textContent = currentTeacherId;

            filterStudentsByTeacher();
            updateClassFilter();
            filterStudents();
        } else {
            showError('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
            loginSection.classList.remove('hidden');
            mainSection.classList.add('hidden');
        }
        showLoading(false);
    });

    logoutBtn.addEventListener('click', () => {
        loginSection.classList.remove('hidden');
        mainSection.classList.add('hidden');
        filteredStudents = [];
        currentTeacherId = '';
        renderStudentsTable();
        updateConnectionStatus('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets...', 'info');
    });

    retryBtn.addEventListener('click', loadDataFromGoogleSheets);
    useLocalDataBtn.addEventListener('click', () => {
        if (loadDataFromLocalStorage()) {
            loginBtn.disabled = false;
            loginBtn.style.background = 'linear-gradient(135deg, #9b59b6, #8e44ad)';
            updateConnectionStatus(`âš ï¸ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allStudents.length} Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©.`, 'warning');
            usingLocalData = true;
        } else {
            showError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£ÙˆÙ„Ø§Ù‹.');
        }
    });

    saveLocalBtn.addEventListener('click', () => {
        if (saveDataToLocalStorage()) {
            showSuccess('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­.');
        }
    });

    // ğŸš¨ Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    syncSheetsBtn.addEventListener('click', syncSheets);


    document.getElementById('searchInput').addEventListener('input', filterStudents);
    document.getElementById('classFilter').addEventListener('change', filterStudents);
    document.getElementById('showStatsBtn').addEventListener('click', () => {
        document.getElementById('statsModal').style.display = 'block';
    });
    cancelEditBtn.addEventListener('click', () => closeModal('editModal'));


    // ğŸš¨ Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø± Ø¨Ø§Ù„Ø¯Ø§Ù„Ø© saveTerm
    saveTermButtons.forEach(button => {
        button.addEventListener('click', (event) => {
            const term = parseInt(event.target.dataset.term);
            saveTerm(term);
        });
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    loadDataFromGoogleSheets();
}

setupEventListeners();
    </script>
</body>
</html>